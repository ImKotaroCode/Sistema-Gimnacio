<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Administraci√≥n - SmartFit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/css/estilos.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- mODifcacion de algunos dise√±os -->
  <style>
    .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
    .grid-3{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px; }
    .span-2{ grid-column:span 2; }
    .span-3{ grid-column:span 3; }
    @media (max-width:720px){
      .grid-2,.grid-3{ grid-template-columns:1fr; }
      .span-2,.span-3{ grid-column:span 1; }
    }
    .modal-content{ max-width:720px; }
    .modal .form-group{ margin-bottom:10px; }
    .help-mini{ font-size:12px; opacity:.8; margin-top:4px; }
  </style>
</head>

<body>
  <nav>
    <ul>
      <li class="logo">SMARTFIT</li>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
      <div class="nav-links" id="navLinks">
        <li><a href="index.html">Inicio</a></li>
        <li><a href="precios.html">Precios</a></li>
        <li><a href="ubicaciones.html">Ubicaciones</a></li>
        <li><a href="clases.html">Clases</a></li>
        <li><a href="contacto.html">Contacto</a></li>
        <li id="perfilLink" style="display:none;"><a href="miperfil.html">Mi Perfil</a></li>
        <li id="adminLink" style="display:none;"><a href="admin.html">Panel Admin</a></li>
        <li class="user-info" id="userInfo">
          <span class="user-name" id="userName"></span>
          <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </li>
        <li id="authLink"><a href="login.html">Login</a></li>
      </div>
    </ul>
  </nav>

  <div id="successMsg" class="success-message"></div>
  <div id="errorMsg" class="error-message"></div>

  <div id="admin" class="page active" style="padding-top:80px;">
    <div class="admin-container">
      <div class="admin-header">
        <h1>Panel de Administraci√≥n</h1>
        <p>Gesti√≥n completa del gimnasio</p>
      </div>

      <div class="admin-tabs" id="adminTabs">
        <button class="admin-tab active" data-tab="dashboard" onclick="cambiarTabAdmin('dashboard', this)">Dashboard</button>
        <button class="admin-tab" data-tab="usuarios" onclick="cambiarTabAdmin('usuarios', this)">Usuarios</button>
        <button class="admin-tab" data-tab="membresias" onclick="cambiarTabAdmin('membresias', this)">Membres√≠as</button>
        <button class="admin-tab" data-tab="clases-admin" onclick="cambiarTabAdmin('clases-admin', this)">Clases</button>
        <button class="admin-tab" data-tab="ubicaciones-admin" onclick="cambiarTabAdmin('ubicaciones-admin', this)">Ubicaciones</button>
        <button class="admin-tab" data-tab="pagos-admin" onclick="cambiarTabAdmin('pagos-admin', this)">Pagos</button>
        <button class="admin-tab" data-tab="maquinas" onclick="cambiarTabAdmin('maquinas', this)">M√°quinas</button>
        <button class="admin-tab" data-tab="reportes" onclick="cambiarTabAdmin('reportes', this)">Reportes</button>
      </div>

      <!-- ======================= TAB DASHBOARD ======================= -->
      <div id="tab-dashboard" class="admin-content active">
        <h2 class="section-title">Estad√≠sticas Generales</h2>
        <div class="loading" id="loadingDashboard">
          <div class="spinner"></div>
          <p>Cargando estad√≠sticas...</p>
        </div>
        <div class="dashboard-grid" id="dashboardStats"></div>
      </div>

      <!-- ======================= TAB USUARIOS ======================= -->
      <div id="tab-usuarios" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Usuarios</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearUsuario()">+ Crear Usuario</button>
            <div class="filters">
              <input type="text" id="filtroUsuariosTexto" placeholder="Buscar por nombre, apellidos, dni o email" oninput="renderUsuariosFiltrados()"/>
              <select id="filtroUsuariosRol" onchange="renderUsuariosFiltrados()">
                <option value="">Todos los roles</option>
                <option value="USUARIO">Usuario</option>
                <option value="ENTRENADOR">Entrenador</option>
                <option value="ADMINISTRADOR">Administrador</option>
              </select>
              <select id="filtroUsuariosEstado" onchange="renderUsuariosFiltrados()">
                <option value="">Todos</option>
                <option value="true">Activos</option>
                <option value="false">Inactivos</option>
              </select>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingUsuarios"><div class="spinner"></div><p>Cargando usuarios...</p></div>
        <div class="data-table" id="usuariosTable"></div>
      </div>

      <!-- ======================= TAB MEMBRESIAS ======================= -->
      <div id="tab-membresias" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Membres√≠as</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearMembresia()">+ Crear Membres√≠a (Presencial)</button>
            <div class="filters">
              <input type="text" id="filtroMembresiasTexto" placeholder="Buscar por usuario o plan" oninput="renderMembresiasFiltradas()"/>
              <select id="filtroMembresiasEstado" onchange="renderMembresiasFiltradas()">
                <option value="">Estado: Todos</option>
                <option value="ACTIVO">Activo</option>
                <option value="PAUSADO">Pausado</option>
                <option value="CANCELADO">Cancelado</option>
                <option value="EXPIRADO">Expirado</option>
              </select>
              <select id="filtroMembresiasPlan" onchange="renderMembresiasFiltradas()">
                <option value="">Plan: Todos</option>
                <option value="BASICO">B√°sico</option>
                <option value="PREMIUM">Premium</option>
                <option value="ANUAL">Anual</option>
              </select>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingMembresias"><div class="spinner"></div><p>Cargando membres√≠as...</p></div>
        <div class="data-table" id="membresiasTable"></div>
      </div>

      <!-- ======================= TAB CLASES ======================= -->
      <div id="tab-clases-admin" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Clases</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearClase()">+ Crear Nueva Clase</button>
            <div class="filters">
              <input type="text" id="filtroClasesTexto" placeholder="Buscar por nombre o instructor" oninput="renderClasesAdminFiltradas()"/>
              <select id="filtroClasesEstado" onchange="renderClasesAdminFiltradas()">
                <option value="">Todos</option>
                <option value="true">Activas</option>
                <option value="false">Inactivas</option>
              </select>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingClasesAdmin"><div class="spinner"></div><p>Cargando clases...</p></div>
        <div class="data-table" id="clasesAdminTable"></div>
      </div>

      <!-- ======================= TAB UBICACIONES ======================= -->
      <div id="tab-ubicaciones-admin" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Ubicaciones</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearUbicacion()">+ Crear Nueva Ubicaci√≥n</button>
            <div class="filters">
              <input type="text" id="filtroUbicacionesTexto" placeholder="Buscar por nombre, distrito o ciudad" oninput="renderUbicacionesFiltradas()"/>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingUbicacionesAdmin"><div class="spinner"></div><p>Cargando ubicaciones...</p></div>
        <div class="data-table" id="ubicacionesAdminTable"></div>
      </div>

      <!-- ======================= TAB PAGOS ======================= -->
      <div id="tab-pagos-admin" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Historial de Pagos</h2>
          <div class="section-actions">
            <div class="filters">
              <input type="text" id="filtroPagosTexto" placeholder="Buscar por usuario o transacci√≥n" oninput="renderPagosFiltrados()"/>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingPagosAdmin"><div class="spinner"></div><p>Cargando pagos...</p></div>
        <div class="data-table" id="pagosAdminTable"></div>
      </div>

      <!-- ======================= TAB MAQUINAS ======================= -->
      <div id="tab-maquinas" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de M√°quinas</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearMaquina()">+ Registrar M√°quina</button>

            <div class="filters">
              <select id="filtroMaquinaUbicacion" onchange="renderMaquinasFiltradas()">
                <option value="">Todas las sedes</option>
              </select>

              <select id="filtroMaquinaCategoria" onchange="renderMaquinasFiltradas()">
                <option value="">Todas las categor√≠as</option>
                <option value="CARDIO">Cardio</option>
                <option value="FUERZA">Fuerza</option>
                <option value="FUNCIONAL">Funcional</option>
              </select>

              <select id="filtroMaquinaEstado" onchange="renderMaquinasFiltradas()">
                <option value="">Todos los estados</option>
                <option value="OPERATIVA">Operativa</option>
                <option value="MANTENIMIENTO">Mantenimiento</option>
                <option value="FUERA_SERVICIO">Fuera de servicio</option>
              </select>

              <input type="text" id="filtroMaquinaTexto" placeholder="Buscar por nombre o descripci√≥n" oninput="renderMaquinasFiltradas()"/>
            </div>

            <div class="section-actions">
              <button class="btn" onclick="descargarTablaComoExcel('maquinasTableContainer','Maquinas')">‚¨áÔ∏è Excel</button>
              <button class="btn btn-secondary" onclick="descargarTablaComoPDF('maquinasTableContainer','Maquinas')">‚¨áÔ∏è PDF</button>
            </div>
          </div>
        </div>

        <div class="data-table" id="maquinasTableContainer">
          <table id="tablaMaquinas">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Categor√≠a</th>
                <th>Estado</th>
                <th>Ubicaci√≥n</th>
                <th>Descripci√≥n</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ======================= TAB REPORTES ======================= -->
      <div id="tab-reportes" class="admin-content">
        <h2 class="section-title">Reportes y An√°lisis</h2>

        <div class="section-actions" style="display:flex; gap:1rem; margin-bottom:1rem; flex-wrap:wrap;">
          <button class="btn" onclick="descargarReportesExcel()">‚¨áÔ∏è Descargar reportes (Excel)</button>
          <button class="btn btn-secondary" onclick="descargarReportesPDF()">‚¨áÔ∏è Descargar reportes (PDF)</button>
        </div>

        <div class="chart-container">
          <h3>Reporte de Membres√≠as</h3>
          <div class="loading" id="loadingReporteMembresias"><div class="spinner"></div></div>
          <div id="reporteMembresiaContent"></div>
        </div>

        <div class="chart-container">
          <h3>Reporte de Ingresos</h3>
          <select id="periodoIngresos" onchange="cargarReporteIngresos()" class="select-dark">
            <option value="mensual">Mensual</option>
            <option value="anual">Anual</option>
          </select>
          <div class="loading" id="loadingReporteIngresos"><div class="spinner"></div></div>
          <div id="reporteIngresosContent"></div>
        </div>

        <div class="chart-container">
          <h3>Reporte de Clases (Ocupaci√≥n)</h3>
          <div class="loading" id="loadingReporteClases"><div class="spinner"></div></div>
          <div id="reporteClasesContent"></div>
        </div>

        <div class="chart-container">
          <h3>Evoluci√≥n Mensual de Suscripciones</h3>
          <canvas id="graficoSuscripciones"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================= MODALES ======================= -->

  <!-- MODAL USUARIO  -->
  <div id="modalUsuario" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="usuarioModalTitulo">Crear Usuario</h3>
        <button class="close-modal" onclick="cerrarModal('modalUsuario')">&times;</button>
      </div>

      <form id="formUsuario" onsubmit="guardarUsuario(event)">
        <input type="hidden" id="usuarioEditId"/>

        <div class="grid-2">
          <div class="form-group">
            <label>Nombre(s)</label>
            <input type="text" id="usuarioEditNombre" required/>
          </div>

          <div class="form-group">
            <label>Apellido paterno</label>
            <input type="text" id="usuarioEditApePat" required/>
          </div>

          <div class="form-group">
            <label>Apellido materno</label>
            <input type="text" id="usuarioEditApeMat" required/>
          </div>

          <div class="form-group">
            <label>DNI</label>
            <input type="text" id="usuarioEditDni" maxlength="8" required/>
            <div class="help-mini">Ej: 8 d√≠gitos (Per√∫)</div>
          </div>

          <div class="form-group span-2">
            <label>Direcci√≥n</label>
            <input type="text" id="usuarioEditDireccion" required/>
          </div>

          <div class="form-group span-2">
            <label>Correo</label>
            <input type="email" id="usuarioEditCorreo" required/>
          </div>

          <div class="form-group">
            <label>Tel√©fono</label>
            <input type="tel" id="usuarioEditTelefono" maxlength="9"/>
          </div>

          <div class="form-group">
            <label>Rol</label>
            <select id="usuarioEditRol">
              <option value="USUARIO">Usuario</option>
              <option value="ENTRENADOR">Entrenador</option>
              <option value="ADMINISTRADOR">Administrador</option>
            </select>
          </div>

          <div class="form-group">
            <label>Estado</label>
            <select id="usuarioEditActivo">
              <option value="true">Activo</option>
              <option value="false">Inactivo</option>
            </select>
          </div>

          <div class="form-group" id="usuarioPwdWrap">
            <label>Contrase√±a</label>
            <input type="password" id="usuarioEditPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
            <div class="help-mini">Solo al crear (o si tu API permite cambiar por admin).</div>
          </div>
        </div>

        <button type="submit" class="btn" style="width:100%; margin-top:10px;">Guardar</button>
      </form>
    </div>
  </div>

  <!-- MODAL MEMBRESIA -->
  <div id="modalMembresia" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Crear Membres√≠a (Presencial)</h3>
        <button class="close-modal" onclick="cerrarModal('modalMembresia')">&times;</button>
      </div>

      <form id="formMembresia" onsubmit="guardarMembresiaPresencial(event)">
        <div class="form-group"><label>ID Usuario</label><input type="number" id="membUsuarioId" required/></div>

        <div class="form-group">
          <label>Plan</label>
          <select id="membPlan">
            <option value="BASICO">B√°sico</option>
            <option value="PREMIUM">Premium</option>
            <option value="ANUAL">Anual</option>
          </select>
        </div>

        <div class="form-group">
          <label>Renovaci√≥n Autom√°tica</label>
          <select id="membAuto">
            <option value="true">S√≠</option>
            <option value="false">No</option>
          </select>
        </div>

        <button type="submit" class="btn" style="width:100%;">Crear</button>
      </form>
    </div>
  </div>

  <!-- MODAL CLASE -->
  <div id="modalClase" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalClaseTitle">Crear Nueva Clase</h3>
        <button class="close-modal" onclick="cerrarModal('modalClase')">&times;</button>
      </div>

      <form id="formClase" onsubmit="guardarClase(event)">
        <input type="hidden" id="claseId"/>

        <div class="grid-2">
          <div class="form-group span-2"><label>Nombre</label><input type="text" id="claseNombre" required/></div>
          <div class="form-group span-2"><label>Descripci√≥n</label><textarea id="claseDescripcion" style="min-height:80px;"></textarea></div>
          <div class="form-group"><label>Horario</label><input type="text" id="claseHorario" required/></div>
          <div class="form-group"><label>Instructor</label><input type="text" id="claseInstructor" required/></div>
          <div class="form-group"><label>Capacidad</label><input type="number" id="claseCapacidad" required min="1"/></div>
          <div class="form-group"><label>Duraci√≥n (min)</label><input type="number" id="claseDuracion" required min="15"/></div>

          <div class="form-group span-2">
            <label>Estado</label>
            <select id="claseEstado">
              <option value="true">Activa</option>
              <option value="false">Inactiva</option>
            </select>
          </div>
        </div>

        <button type="submit" class="btn" style="width:100%;">Guardar</button>
      </form>
    </div>
  </div>

  <!-- MODAL UBICACION -->
  <div id="modalUbicacion" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalUbicacionTitle">Crear Nueva Ubicaci√≥n</h3>
        <button class="close-modal" onclick="cerrarModal('modalUbicacion')">&times;</button>
      </div>

      <form id="formUbicacion" onsubmit="guardarUbicacion(event)">
        <input type="hidden" id="ubicacionId"/>

        <div class="grid-2">
          <div class="form-group span-2"><label>Nombre</label><input type="text" id="ubicacionNombre" required/></div>
          <div class="form-group span-2"><label>Direcci√≥n</label><input type="text" id="ubicacionDireccion" required/></div>
          <div class="form-group"><label>Distrito</label><input type="text" id="ubicacionDistrito" required/></div>
          <div class="form-group"><label>Ciudad</label><input type="text" id="ubicacionCiudad" required/></div>
          <div class="form-group"><label>Tel√©fono</label><input type="tel" id="ubicacionTelefono" required/></div>
          <div class="form-group"><label>Horario</label><input type="text" id="ubicacionHorario" required value="24/7"/></div>
          <div class="form-group"><label>Latitud</label><input type="number" step="0.0001" id="ubicacionLatitud"/></div>
          <div class="form-group"><label>Longitud</label><input type="number" step="0.0001" id="ubicacionLongitud"/></div>
        </div>

        <button class="btn" style="width:100%;">Guardar</button>
      </form>
    </div>
  </div>

  <!-- MODAL MAQUINA -->
  <div class="modal" id="modalMaquina">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="tituloModalMaquina">Nueva M√°quina</h3>
        <button class="close-modal" onclick="cerrarModalMaquina()">&times;</button>
      </div>

      <div class="grid-2">
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" id="maqNombre">
        </div>

        <div class="form-group">
          <label>Categor√≠a:</label>
          <select id="maqCategoria">
            <option value="CARDIO">Cardio</option>
            <option value="FUERZA">Fuerza</option>
            <option value="FUNCIONAL">Funcional</option>
          </select>
        </div>

        <div class="form-group">
          <label>Estado:</label>
          <select id="maqEstado">
            <option value="OPERATIVA">Operativa</option>
            <option value="MANTENIMIENTO">Mantenimiento</option>
            <option value="FUERA_SERVICIO">Fuera de Servicio</option>
          </select>
        </div>

        <div class="form-group">
          <label>Ubicaci√≥n:</label>
          <select id="maqUbicacion"></select>
        </div>

        <div class="form-group span-2">
          <label>Descripci√≥n:</label>
          <input type="text" id="maqDescripcion">
        </div>
      </div>

      <div class="modal-btns" style="display:flex; gap:1rem; margin-top:1rem;">
        <button class="btn" type="button" onclick="guardarMaquina()">Guardar</button>
        <button class="btn btn-secondary" type="button" onclick="cerrarModalMaquina()">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:8080/api";

    function toggleMobileMenu(){ document.getElementById('navLinks').classList.toggle('active'); }

    function verificarSesion(){
      const u = localStorage.getItem('usuario');
      const t = localStorage.getItem('token');
      window.usuarioActual = (u && t) ? JSON.parse(u) : null;
    }

    function buildNombreCompleto(u){
      if (!u) return '';
      const a = [
        u.nombreCompleto,
        [u.nombres, u.apellidoPaterno, u.apellidoMaterno].filter(Boolean).join(' ').trim()
      ].filter(Boolean)[0];
      return a || '';
    }

    function actualizarUIUsuario() {
      const isLogged = !!window.usuarioActual;
      const isAdminOrTrainer = window.usuarioActual?.rol === 'ADMINISTRADOR' || window.usuarioActual?.rol === 'ENTRENADOR';

      const authLink = document.getElementById('authLink');
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      const perfilLink = document.getElementById('perfilLink');
      const adminLink = document.getElementById('adminLink');

      if (authLink) authLink.style.display = isLogged ? 'none' : 'block';
      if (userInfo) userInfo.classList.toggle('active', isLogged);
      if (userName) userName.textContent = isLogged ? buildNombreCompleto(window.usuarioActual) : '';
      if (perfilLink) perfilLink.style.display = isLogged ? 'block' : 'none';
      if (adminLink) adminLink.style.display = isAdminOrTrainer ? 'block' : 'none';
    }

    function cerrarSesion() {
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      window.usuarioActual = null;
      actualizarUIUsuario();
      mostrarMensaje('Sesi√≥n cerrada','success');
      window.location.href = 'login.html';
    }

    function mostrarMensaje(msg,tipo){
      const s=document.getElementById('successMsg');
      const e=document.getElementById('errorMsg');
      if (tipo==='success'){
        s.textContent=msg; s.classList.add('show'); e.classList.remove('show');
        setTimeout(()=>s.classList.remove('show'),2500);
      } else {
        e.textContent=msg; e.classList.add('show'); s.classList.remove('show');
        setTimeout(()=>e.classList.remove('show'),4000);
      }
    }

    /* ========== ENDPOINTS ========== */
    const ENDPOINTS = {
      admin: {
        dashboard: API_URL + "/admin/dashboard",
        usuarios: API_URL + "/admin/usuarios",
        usuarioId: (id) => API_URL + "/admin/usuarios/" + id,
        membresias: API_URL + "/admin/membresias",
        clases: API_URL + "/admin/clases",
        claseId: (id) => API_URL + "/admin/clases/" + id,
        ubicaciones: API_URL + "/admin/ubicaciones",
        ubicacionId: (id) => API_URL + "/admin/ubicaciones/" + id,
        pagos: API_URL + "/admin/pagos",
        reporteMembresias: API_URL + "/admin/reportes/membresias",
        reporteIngresos: (periodo) => API_URL + "/admin/reportes/ingresos?periodo=" + periodo,
        reporteClases: API_URL + "/admin/reportes/clases",
        reporteSuscripciones: API_URL + "/admin/reportes/suscripciones-mensuales",
      },
      ubicaciones: { listar: API_URL + "/ubicaciones" },
      membresias: {
        crear: API_URL + "/membresias",
        cancelar: (id) => API_URL + "/membresias/" + id + "/cancelar"
      },
      maquinas: {
        listar: `${API_URL}/admin/maquinas`,
        crear: `${API_URL}/admin/maquinas`,
        editar: (id) => `${API_URL}/admin/maquinas/${id}`,
        eliminar: (id) => `${API_URL}/admin/maquinas/${id}`,
      }
    };

    function authHeaders() {
      const t = localStorage.getItem('token') || '';
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    function handle401(status) {
      if (status !== 401) return;
      if (window._loggingOutFor401) return;
      window._loggingOutFor401 = true;
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      window.usuarioActual = null;
      alert('No autorizado o sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
      window.location.href = 'login.html';
    }

    async function getJson(url, opts = {}) {
      const res = await fetch(url, {
        ...opts,
        headers: {
          'Content-Type': 'application/json',
          ...authHeaders(),
          ...(opts.headers || {})
        }
      });

      let data = null;
      try { data = await res.json(); } catch { data = null; }

      handle401(res.status);
      return { ok: res.ok, data, status: res.status };
    }

    async function sendJson(url, method = 'POST', body = null, extraHeaders = {}) {
      const res = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          ...authHeaders(),
          ...extraHeaders
        },
        body: body ? JSON.stringify(body) : null
      });

      let data = null;
      try { data = await res.json(); } catch { data = null; }

      handle401(res.status);
      return { ok: res.ok, data, status: res.status };
    }

    function safeUsuarioNombre(obj = {}) {
      const u = obj.usuario || obj;
      return (
        obj.usuarioNombre ||
        u.nombreCompleto ||
        [u.nombres, u.apellidoPaterno, u.apellidoMaterno].filter(Boolean).join(' ').trim() ||
        "‚Äî"
      );
    }

    /* ================== MODALES ================== */
    function abrirModal(id){ document.getElementById(id).classList.add('show'); }
    function cerrarModal(id){ document.getElementById(id).classList.remove('show'); }

    /* ================== Tabs por rol ================== */
    function configurarTabsAdminPorRol(rol) {
      const isAdmin = rol === 'ADMINISTRADOR';
      const isTrainer = rol === 'ENTRENADOR';

      const tabs = [
        { key:'dashboard', sel:'[data-tab="dashboard"]' },
        { key:'usuarios', sel:'[data-tab="usuarios"]' },
        { key:'membresias', sel:'[data-tab="membresias"]' },
        { key:'clases-admin', sel:'[data-tab="clases-admin"]' },
        { key:'ubicaciones-admin', sel:'[data-tab="ubicaciones-admin"]' },
        { key:'pagos-admin', sel:'[data-tab="pagos-admin"]' },
        { key:'reportes', sel:'[data-tab="reportes"]' },
        { key:'maquinas', sel:'[data-tab="maquinas"]' }
      ];

      tabs.forEach(t => {
        const btn = document.querySelector(t.sel);
        const pane = document.getElementById(`tab-${t.key}`);
        if (!btn || !pane) return;

        if (isAdmin) {
          btn.style.display = '';
          pane.style.display = '';
        } else if (isTrainer) {
          const allowed = (t.key === 'clases-admin');
          btn.style.display = allowed ? '' : 'none';
          pane.style.display = allowed ? '' : 'none';
          if (!allowed) pane.classList.remove('active');
        }
      });

      if (isTrainer) {
        document.querySelectorAll('.btn-create, .btn-edit, .btn-delete').forEach(b=> b.style.display='none');
      }
    }

    function cambiarTabAdmin(tab, elBtn){
      const rol = window.usuarioActual?.rol;
      const isAdmin = rol === 'ADMINISTRADOR';
      const isTrainer = rol === 'ENTRENADOR';

      if (isTrainer && tab !== 'clases-admin') {
        alert('Tu rol solo permite ver Clases.');
        return;
      }

      document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.admin-content').forEach(c=>c.classList.remove('active'));
      if (elBtn) elBtn.classList.add('active');

      const area = document.getElementById(`tab-${tab}`);
      if (area) area.classList.add('active');

      switch(tab){
        case 'dashboard': if(isAdmin) cargarDashboard(); break;
        case 'usuarios': if(isAdmin) cargarUsuariosAdmin(); break;
        case 'membresias': if(isAdmin) cargarMembresiasAdmin(); break;
        case 'clases-admin': cargarClasesAdmin(); break;
        case 'ubicaciones-admin': if(isAdmin) cargarUbicacionesAdmin(); break;
        case 'pagos-admin': if(isAdmin) cargarPagosAdmin(); break;
        case 'maquinas': if(isAdmin) cargarMaquinas(); break;
        case 'reportes': if(isAdmin) cargarReportes(); break;
      }
    }

    /* ================== Dashboard ================== */
    async function cargarDashboard(){
      const loading=document.getElementById('loadingDashboard');
      const container=document.getElementById('dashboardStats');
      loading.classList.add('show');

      try{
        const { ok, data } = await getJson(ENDPOINTS.admin.dashboard);
        if (ok && data){
          container.innerHTML = `
            <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value">${data.totalUsuarios}</div><div class="stat-label">Total Usuarios</div><div style="color:#28a745; margin-top:.5rem;">‚úì ${data.usuariosActivos} activos</div></div>
            <div class="stat-card"><div class="stat-icon">üí≥</div><div class="stat-value">${data.totalMembresias}</div><div class="stat-label">Total Membres√≠as</div><div style="color:#28a745; margin-top:.5rem;">‚úì ${data.membresiasActivas} activas</div></div>
            <div class="stat-card"><div class="stat-icon">üèãÔ∏è</div><div class="stat-value">${data.totalClases}</div><div class="stat-label">Clases Disponibles</div></div>
            <div class="stat-card"><div class="stat-icon">üìç</div><div class="stat-value">${data.totalUbicaciones}</div><div class="stat-label">Ubicaciones</div></div>
            <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-value">${Number(data.ingresosMensuales||0).toFixed(2)}</div><div class="stat-label">Ingresos Mensuales</div></div>
            <div class="stat-card"><div class="stat-icon">üíµ</div><div class="stat-value">${Number(data.ingresosAnuales||0).toFixed(2)}</div><div class="stat-label">Ingresos Anuales</div></div>
          `;
        } else {
          container.innerHTML = '<p style="color:#dc3545;">Error al cargar estad√≠sticas</p>';
        }
      }catch(e){
        console.error(e);
        container.innerHTML = '<p style="color:#dc3545;">Error al cargar estad√≠sticas</p>';
      } finally{
        loading.classList.remove('show');
      }
    }

    /* ================== Usuarios (con nuevos campos) ================== */
    function abrirModalCrearUsuario(){
      document.getElementById('usuarioModalTitulo').textContent='Crear Usuario';
      document.getElementById('formUsuario').reset();
      document.getElementById('usuarioEditId').value='';
      document.getElementById('usuarioPwdWrap').style.display='block';
      abrirModal('modalUsuario');
    }

    function editarUsuarioPorId(id){
      const u = (window._usuariosCache || []).find(x => String(x.id) === String(id));
      if (!u) { alert('No se encontr√≥ el usuario. Recarga la lista.'); return; }

      document.getElementById('usuarioModalTitulo').textContent='Editar Usuario';
      document.getElementById('usuarioEditId').value = u.id;

      document.getElementById('usuarioEditNombre').value = (u.nombres || (u.nombreCompleto || '')).toString().trim().split(' ')[0] || '';
      document.getElementById('usuarioEditApePat').value = (u.apellidoPaterno || '').toString().trim();
      document.getElementById('usuarioEditApeMat').value = (u.apellidoMaterno || '').toString().trim();
      document.getElementById('usuarioEditDni').value = (u.dni || '').toString().trim();
      document.getElementById('usuarioEditDireccion').value = (u.direccion || '').toString().trim();
      document.getElementById('usuarioEditCorreo').value = (u.correoElectronico || u.email || '').toString().trim();
      document.getElementById('usuarioEditTelefono').value = (u.numeroTelefono || '').toString().trim();
      document.getElementById('usuarioEditRol').value = (u.rol || 'USUARIO');
      document.getElementById('usuarioEditActivo').value = String(!!u.estaActivo);

      document.getElementById('usuarioPwdWrap').style.display='none';
      abrirModal('modalUsuario');
    }

    async function guardarUsuario(e){
      e.preventDefault();
      const id = document.getElementById('usuarioEditId').value;

      const nombres = document.getElementById('usuarioEditNombre').value.trim();
      const apPat = document.getElementById('usuarioEditApePat').value.trim();
      const apMat = document.getElementById('usuarioEditApeMat').value.trim();
      const nombreCompleto = `${nombres} ${apPat} ${apMat}`.replace(/\s+/g,' ').trim();

      const payload = {
        nombreCompleto,
        nombres,
        apellidoPaterno: apPat,
        apellidoMaterno: apMat,
        dni: document.getElementById('usuarioEditDni').value.trim(),
        direccion: document.getElementById('usuarioEditDireccion').value.trim(),
        correoElectronico: document.getElementById('usuarioEditCorreo').value.trim(),
        numeroTelefono: document.getElementById('usuarioEditTelefono').value.trim() || null,
        rol: document.getElementById('usuarioEditRol').value,
        estaActivo: document.getElementById('usuarioEditActivo').value === 'true'
      };

      const pwd = (document.getElementById('usuarioEditPwd').value || '').trim();
      if (!id && pwd) payload.contrasena = pwd; 

      const url = id ? ENDPOINTS.admin.usuarioId(id) : ENDPOINTS.admin.usuarios;
      const method = id ? 'PUT' : 'POST';

      try{
        const { ok, data } = await sendJson(url, method, payload);
        if (ok){
          cerrarModal('modalUsuario');
          await cargarUsuariosAdmin();
          mostrarMensaje('Usuario guardado', 'success');
        } else {
          alert((data && (data.mensaje || data.error)) || 'No se pudo guardar (revisa backend)');
        }
      } catch (err){
        console.error(err);
        alert('Error de conexi√≥n');
      }
    }

    async function eliminarUsuario(id){
      if(!confirm('¬øEliminar usuario?')) return;
      try{
        const { ok, data } = await sendJson(ENDPOINTS.admin.usuarioId(id),'DELETE',null);
        if (ok) {
          await cargarUsuariosAdmin();
          mostrarMensaje('Usuario eliminado', 'success');
        } else {
          alert((data && (data.mensaje||data.error)) || 'No se pudo eliminar');
        }
      }catch{
        alert('Error de conexi√≥n');
      }
    }

    async function cargarUsuariosAdmin(){
      const loading=document.getElementById('loadingUsuarios');
      const container=document.getElementById('usuariosTable');
      loading.classList.add('show');
      try{
        const { ok, data } = await getJson(ENDPOINTS.admin.usuarios);
        window._usuariosCache = Array.isArray(data)?data:[];
        renderUsuariosFiltrados();
      }catch{
        container.innerHTML='<p style="color:#dc3545;">Error al cargar usuarios</p>';
      } finally{
        loading.classList.remove('show');
      }
    }

    function renderUsuariosFiltrados(){
      const container=document.getElementById('usuariosTable');
      const q=(document.getElementById('filtroUsuariosTexto')?.value||'').toLowerCase();
      const r=document.getElementById('filtroUsuariosRol')?.value||'';
      const e=document.getElementById('filtroUsuariosEstado')?.value||'';

      const arr=(window._usuariosCache||[]).filter(u=>{
        const full = `${u.nombreCompleto||''} ${u.nombres||''} ${u.apellidoPaterno||''} ${u.apellidoMaterno||''} ${u.dni||''} ${u.correoElectronico||''}`.toLowerCase();
        const txt = full.includes(q);
        const rol = !r || (u.rol===r);
        const est = !e || (String(!!u.estaActivo)===e);
        return txt && rol && est;
      });

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Nombre</th><th>Apellidos</th><th>DNI</th>
              <th>Email</th><th>Tel√©fono</th><th>Rol</th><th>Estado</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${arr.map(u=>`
              <tr>
                <td>${u.id}</td>
                <td>${u.nombres || (u.nombreCompleto||'').split(' ')[0] || '‚Äî'}</td>
                <td>${(u.apellidoPaterno||'')} ${(u.apellidoMaterno||'')}</td>
                <td>${u.dni || '‚Äî'}</td>
                <td>${u.correoElectronico || '‚Äî'}</td>
                <td>${u.numeroTelefono || '‚Äî'}</td>
                <td><span class="badge badge-info">${u.rol || 'USUARIO'}</span></td>
                <td><span class="badge ${u.estaActivo?'badge-success':'badge-danger'}">${u.estaActivo?'Activo':'Inactivo'}</span></td>
                <td>
                  <button class="action-btn btn-edit" onclick="editarUsuarioPorId(${u.id})">Editar</button>
                  <button class="action-btn btn-delete" onclick="eliminarUsuario(${u.id})">Eliminar</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    /* ================== Membres√≠as ================== */
    function abrirModalCrearMembresia(){
      document.getElementById('formMembresia').reset();
      abrirModal('modalMembresia');
    }

    async function guardarMembresiaPresencial(e){
      e.preventDefault();
      const payload={
        usuarioId: Number(document.getElementById('membUsuarioId').value),
        tipoPlan: document.getElementById('membPlan').value,
        renovacionAutomatica: document.getElementById('membAuto').value==='true'
      };
      try{
        const { ok, data } = await sendJson(ENDPOINTS.membresias.crear,'POST',payload);
        if (ok){
          cerrarModal('modalMembresia');
          cargarMembresiasAdmin();
          alert('Membres√≠a creada');
        } else alert(data?.mensaje||data?.error||'No se pudo crear');
      }catch{ alert('Error de conexi√≥n'); }
    }

    async function cancelarMembresia(id){
      if(!confirm('¬øCancelar membres√≠a?')) return;
      try{
        const { ok } = await sendJson(ENDPOINTS.membresias.cancelar(id),'PUT',null);
        if (ok){ cargarMembresiasAdmin(); } else alert('No se pudo cancelar');
      }catch{ alert('Error de conexi√≥n'); }
    }

    async function cargarMembresiasAdmin(){
      const loading=document.getElementById('loadingMembresias');
      const container=document.getElementById('membresiasTable');
      loading.classList.add('show');
      try{
        const { ok, data } = await getJson(ENDPOINTS.admin.membresias);
        window._membresiasCache = Array.isArray(data)?data:[];
        renderMembresiasFiltradas();
      }catch{
        container.innerHTML='<p style="color:#dc3545;">Error al cargar membres√≠as</p>';
      } finally{
        loading.classList.remove('show');
      }
    }

    function renderMembresiasFiltradas(){
      const container=document.getElementById('membresiasTable');
      const q=(document.getElementById('filtroMembresiasTexto')?.value||'').toLowerCase();
      const estado=document.getElementById('filtroMembresiasEstado')?.value||'';
      const plan=document.getElementById('filtroMembresiasPlan')?.value||'';

      const arr=(window._membresiasCache||[]).filter(m=>{
        const usuario = (m.usuario?.nombreCompleto || m.usuarioNombre || safeUsuarioNombre(m) || '').toLowerCase();
        const matchesTxt = `${usuario} ${m.tipoPlan||''}`.toLowerCase().includes(q);
        const matchesEstado = !estado || m.estado===estado;
        const matchesPlan = !plan || m.tipoPlan===plan;
        return matchesTxt && matchesEstado && matchesPlan;
      });

      container.innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>Usuario</th><th>Plan</th><th>Precio</th><th>Inicio</th><th>Fin</th><th>Estado</th><th>Auto-Renov</th><th>Acciones</th></tr></thead>
          <tbody>
            ${arr.map(m=>`
              <tr>
                <td>${m.id}</td>
                <td>${safeUsuarioNombre(m)}<br><small>ID: ${m.usuarioId ?? '‚Äî'}</small></td>
                <td><span class="badge badge-info">${m.tipoPlan}</span></td>
                <td>${m.precio ?? '‚Äî'}</td>
                <td>${m.fechaInicio? new Date(m.fechaInicio).toLocaleDateString() : '‚Äî'}</td>
                <td>${m.fechaFin? new Date(m.fechaFin).toLocaleDateString() : '‚Äî'}</td>
                <td><span class="badge ${m.estado==='ACTIVO'?'badge-success':'badge-warning'}">${m.estado}</span></td>
                <td>${m.renovacionAutomatica ? '‚úì' : '‚Äî'}</td>
                <td>${m.estado==='ACTIVO' ? `<button class="action-btn btn-delete" onclick="cancelarMembresia(${m.id})">Cancelar</button>` : '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    /* ================== Clases (edit por ID) ================== */
    function abrirModalCrearClase(){
      document.getElementById('modalClaseTitle').textContent='Crear Nueva Clase';
      document.getElementById('formClase').reset();
      document.getElementById('claseId').value='';
      document.getElementById('claseEstado').value = "true";
      abrirModal('modalClase');
    }

    function editarClasePorId(id){
      const c = (window._clasesAdminCache || []).find(x => String(x.id) === String(id));
      if (!c) { alert('No se encontr√≥ la clase. Recarga.'); return; }

      document.getElementById('modalClaseTitle').textContent='Editar Clase';
      document.getElementById('claseId').value = c.id || '';
      document.getElementById('claseNombre').value = c.nombreClase || '';
      document.getElementById('claseDescripcion').value = c.descripcion || '';
      document.getElementById('claseHorario').value = c.horario || '';
      document.getElementById('claseInstructor').value = c.nombreInstructor || '';
      document.getElementById('claseCapacidad').value = c.capacidadMaxima || 1;
      document.getElementById('claseDuracion').value = c.duracionMinutos || 60;
      document.getElementById('claseEstado').value = String(!!c.estaActivo);

      abrirModal('modalClase');
    }

    async function guardarClase(e){
      e.preventDefault();
      const id = document.getElementById('claseId').value;

      const payload = {
        nombreClase: document.getElementById('claseNombre').value,
        descripcion: document.getElementById('claseDescripcion').value,
        horario: document.getElementById('claseHorario').value,
        nombreInstructor: document.getElementById('claseInstructor').value,
        capacidadMaxima: Number(document.getElementById('claseCapacidad').value),
        duracionMinutos: Number(document.getElementById('claseDuracion').value),
        estaActivo: document.getElementById('claseEstado').value === "true"
      };

      const url = id ? ENDPOINTS.admin.claseId(id) : ENDPOINTS.admin.clases;
      const method = id ? 'PUT' : 'POST';

      try{
        const { ok, data } = await sendJson(url, method, payload);
        if(ok){
          cerrarModal('modalClase');
          cargarClasesAdmin();
        } else alert((data && (data.mensaje||data.error)) || 'No se pudo guardar');
      } catch{
        alert('Error de conexi√≥n');
      }
    }

    async function eliminarClase(id){
      if(!confirm('¬øEliminar clase?')) return;
      try{
        const { ok, data } = await sendJson(ENDPOINTS.admin.claseId(id),'DELETE',null);
        if(ok) cargarClasesAdmin();
        else alert((data && (data.mensaje||data.error)) || 'No se pudo eliminar');
      } catch{
        alert('Error de conexi√≥n');
      }
    }

    async function cargarClasesAdmin(){
      const loading=document.getElementById('loadingClasesAdmin');
      const container=document.getElementById('clasesAdminTable');
      loading.classList.add('show');

      try{
        const { ok, data } = await getJson(ENDPOINTS.admin.clases);
        window._clasesAdminCache = Array.isArray(data)?data:[];
        renderClasesAdminFiltradas();
      }catch{
        container.innerHTML='<p style="color:#dc3545;">Error al cargar clases</p>';
      } finally{
        loading.classList.remove('show');
      }
    }

    function renderClasesAdminFiltradas(){
      const container=document.getElementById('clasesAdminTable');
      const q=(document.getElementById('filtroClasesTexto')?.value||'').toLowerCase();
      const est=(document.getElementById('filtroClasesEstado')?.value||'');

      const arr=(window._clasesAdminCache||[]).filter(c=>{
        const txt = `${c.nombreClase||''} ${c.nombreInstructor||''}`.toLowerCase().includes(q);
        const estado = !est || String(!!c.estaActivo)===est;
        return txt && estado;
      });

      container.innerHTML=`
        <table>
          <thead><tr><th>ID</th><th>Nombre</th><th>Instructor</th><th>Horario</th><th>Capacidad</th><th>Inscritos</th><th>Duraci√≥n</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody>
            ${arr.map(c=>`
              <tr>
                <td>${c.id}</td>
                <td>${c.nombreClase}</td>
                <td>${c.nombreInstructor}</td>
                <td>${c.horario}</td>
                <td>${c.capacidadMaxima}</td>
                <td>${Array.isArray(c.usuariosInscritos)?c.usuariosInscritos.length:(c.usuariosInscritos ?? c.inscritos ?? 0)}</td>
                <td>${c.duracionMinutos} min</td>
                <td><span class="badge ${c.estaActivo ? 'badge-success':'badge-danger'}">${c.estaActivo?'Activo':'Inactivo'}</span></td>
                <td>
                  <button class="action-btn btn-edit" onclick="editarClasePorId(${c.id})">Editar</button>
                  <button class="action-btn btn-delete" onclick="eliminarClase(${c.id})">Eliminar</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    /* ================== M√°quinas ================== */
    let maquinaEditandoId = null;

    async function cargarMaquinas() {
      const { ok, data } = await getJson(ENDPOINTS.maquinas.listar);
      if (!ok) { alert("No se pudieron cargar las m√°quinas"); return; }
      window._maquinasCache = Array.isArray(data) ? data : [];
      await cargarUbicacionesFiltroMaquinas();
      renderMaquinasFiltradas();
    }

    function renderMaquinasFiltradas() {
      const tbody = document.querySelector("#tablaMaquinas tbody");
      if (!tbody) return;

      const texto = (document.getElementById("filtroMaquinaTexto")?.value || "").toLowerCase();
      const ubicacionId = (document.getElementById("filtroMaquinaUbicacion")?.value || "");
      const categoria = (document.getElementById("filtroMaquinaCategoria")?.value || "");
      const estado = (document.getElementById("filtroMaquinaEstado")?.value || "");

      const lista = (window._maquinasCache || []).filter(m => {
        const matchTexto = !texto || `${m.nombre || ""} ${m.descripcion || ""}`.toLowerCase().includes(texto);
        const matchUbic = !ubicacionId || String(m.ubicacionId) === String(ubicacionId);
        const matchCat = !categoria || m.categoria === categoria;
        const matchEstado = !estado || m.estado === estado;
        return matchTexto && matchUbic && matchCat && matchEstado;
      });

      tbody.innerHTML = lista.map(m => `
        <tr>
          <td>${m.id}</td>
          <td>${m.nombre}</td>
          <td>${m.categoria}</td>
          <td>${m.estado}</td>
          <td>${m.nombreUbicacion || "‚Äî"}</td>
          <td>${m.descripcion || "‚Äî"}</td>
          <td>
            <button class="action-btn btn-edit" onclick="editarMaquina(${m.id})">EDITAR</button>
            <button class="action-btn btn-delete" onclick="eliminarMaquina(${m.id})">ELIMINAR</button>
          </td>
        </tr>
      `).join("");
    }

    async function abrirModalCrearMaquina() {
      maquinaEditandoId = null;
      document.getElementById("tituloModalMaquina").textContent = "Nueva M√°quina";
      document.getElementById("maqNombre").value = "";
      document.getElementById("maqDescripcion").value = "";
      document.getElementById("maqCategoria").value = "CARDIO";
      document.getElementById("maqEstado").value = "OPERATIVA";
      await cargarUbicacionesEnSelect("maqUbicacion");
      document.getElementById("modalMaquina").classList.add('show');
    }

    async function editarMaquina(id) {
      maquinaEditandoId = id;
      const m = (window._maquinasCache || []).find(x => x.id === id);
      if (!m) { alert("No se encontr√≥ la m√°quina. Reabre el tab o recarga."); return; }

      document.getElementById("tituloModalMaquina").textContent = "Editar M√°quina";
      document.getElementById("maqNombre").value = m.nombre || "";
      document.getElementById("maqDescripcion").value = m.descripcion || "";
      document.getElementById("maqCategoria").value = m.categoria || "CARDIO";
      document.getElementById("maqEstado").value = m.estado || "OPERATIVA";
      await cargarUbicacionesEnSelect("maqUbicacion");
      if (m.ubicacionId) document.getElementById("maqUbicacion").value = m.ubicacionId;
      document.getElementById("modalMaquina").classList.add('show');
    }

    async function guardarMaquina() {
      const body = {
        nombre: document.getElementById("maqNombre").value,
        descripcion: document.getElementById("maqDescripcion").value,
        categoria: document.getElementById("maqCategoria").value,
        estado: document.getElementById("maqEstado").value,
        ubicacionId: Number(document.getElementById("maqUbicacion").value)
      };

      const url = maquinaEditandoId ? ENDPOINTS.maquinas.editar(maquinaEditandoId) : ENDPOINTS.maquinas.crear;
      const method = maquinaEditandoId ? "PUT" : "POST";

      const { ok, data } = await sendJson(url, method, body);
      if (!ok) {
        alert((data && (data.mensaje||data.error)) || "Error guardando la m√°quina");
        return;
      }

      cerrarModalMaquina();
      cargarMaquinas();
    }

    async function eliminarMaquina(id) {
      if (!confirm("¬øEliminar m√°quina?")) return;
      const { ok, data } = await sendJson(ENDPOINTS.maquinas.eliminar(id), "DELETE", null);
      if (!ok) {
        alert((data && (data.mensaje||data.error)) || "No se pudo eliminar");
        return;
      }
      cargarMaquinas();
    }

    function cerrarModalMaquina() {
      document.getElementById("modalMaquina").classList.remove('show');
    }

    async function cargarUbicacionesEnSelect(selectId) {
      const { ok, data } = await getJson(ENDPOINTS.ubicaciones.listar, { headers: {} }); // p√∫blicas
      if (!ok || !Array.isArray(data)) { alert("No se pudieron cargar las ubicaciones"); return; }
      const select = document.getElementById(selectId);
      select.innerHTML = "";
      data.forEach(u => {
        select.innerHTML += `<option value="${u.id}">${u.nombreUbicacion} - ${u.distrito}</option>`;
      });
    }

    async function cargarUbicacionesFiltroMaquinas() {
      const select = document.getElementById("filtroMaquinaUbicacion");
      if (!select) return;
      if (select.dataset.loaded === "1") return;

      const { ok, data } = await getJson(ENDPOINTS.ubicaciones.listar, { headers: {} }); // p√∫blicas
      if (!ok || !Array.isArray(data)) return;

      select.innerHTML = `
        <option value="">Todas las sedes</option>
        ${data.map(u => `<option value="${u.id}">${u.nombreUbicacion} - ${u.distrito}</option>`).join("")}
      `;
      select.dataset.loaded = "1";
    }

    /* ================== Ubicaciones ================== */
    function abrirModalCrearUbicacion() {
      const rol = (window.usuarioActual?.rol)||'USUARIO';
      if (rol !== 'ADMINISTRADOR') { alert('Solo un administrador puede crear ubicaciones.'); return; }
      document.getElementById('formUbicacion').reset();
      document.getElementById('ubicacionId').value = '';
      document.getElementById('modalUbicacionTitle').textContent = 'Crear Nueva Ubicaci√≥n';
      abrirModal('modalUbicacion');
    }

    function editarUbicacionPorId(id){
      const u = (window._ubicacionesAdminCache || []).find(x => String(x.id) === String(id));
      if(!u){ alert('No se encontr√≥ la ubicaci√≥n.'); return; }

      document.getElementById('modalUbicacionTitle').textContent='Editar Ubicaci√≥n';
      document.getElementById('ubicacionId').value=u.id||'';
      document.getElementById('ubicacionNombre').value=u.nombreUbicacion||'';
      document.getElementById('ubicacionDireccion').value=u.direccion||'';
      document.getElementById('ubicacionDistrito').value=u.distrito||'';
      document.getElementById('ubicacionCiudad').value=u.ciudad||'';
      document.getElementById('ubicacionTelefono').value=u.numeroTelefono||'';
      document.getElementById('ubicacionHorario').value=u.horario||'24/7';
      document.getElementById('ubicacionLatitud').value=u.latitud||'';
      document.getElementById('ubicacionLongitud').value=u.longitud||'';

      abrirModal('modalUbicacion');
    }

    async function guardarUbicacion(e){
      e.preventDefault();
      const id=document.getElementById('ubicacionId').value;
      const payload={
        nombreUbicacion: document.getElementById('ubicacionNombre').value,
        direccion: document.getElementById('ubicacionDireccion').value,
        distrito: document.getElementById('ubicacionDistrito').value,
        ciudad: document.getElementById('ubicacionCiudad').value,
        numeroTelefono: document.getElementById('ubicacionTelefono').value,
        horario: document.getElementById('ubicacionHorario').value,
        latitud: parseFloat(document.getElementById('ubicacionLatitud').value||0),
        longitud: parseFloat(document.getElementById('ubicacionLongitud').value||0)
      };

      const url=id? ENDPOINTS.admin.ubicacionId(id): ENDPOINTS.admin.ubicaciones;
      const method=id?'PUT':'POST';

      try{
        const { ok, data } = await sendJson(url,method,payload);
        if(ok){
          cerrarModal('modalUbicacion');
          cargarUbicacionesAdmin();
        } else alert((data && (data.mensaje||data.error)) || 'No se pudo guardar');
      } catch{
        alert('Error de conexi√≥n');
      }
    }

    async function eliminarUbicacion(id){
      if(!confirm('¬øEliminar ubicaci√≥n?')) return;
      try{
        const { ok, data } = await sendJson(ENDPOINTS.admin.ubicacionId(id),'DELETE',null);
        if(ok) cargarUbicacionesAdmin();
        else alert((data && (data.mensaje||data.error)) || 'No se pudo eliminar');
      } catch{
        alert('Error de conexi√≥n');
      }
    }

    async function cargarUbicacionesAdmin(){
      const loading=document.getElementById('loadingUbicacionesAdmin');
      const container=document.getElementById('ubicacionesAdminTable');
      loading.classList.add('show');
      try{
        const { ok, data } = await getJson(ENDPOINTS.ubicaciones.listar, { headers: {} }); // p√∫blicas
        window._ubicacionesAdminCache = Array.isArray(data)?data:[];
        renderUbicacionesFiltradas();
      }catch{
        container.innerHTML='<p style="color:#dc3545;">Error al cargar ubicaciones</p>';
      } finally{
        loading.classList.remove('show');
      }
    }

    function renderUbicacionesFiltradas(){
      const container=document.getElementById('ubicacionesAdminTable');
      const q=(document.getElementById('filtroUbicacionesTexto')?.value||'').toLowerCase();

      const arr=(window._ubicacionesAdminCache||[]).filter(u=>{
        return `${u.nombreUbicacion||''} ${u.distrito||''} ${u.ciudad||''}`.toLowerCase().includes(q);
      });

      container.innerHTML=`
        <table>
          <thead><tr><th>ID</th><th>Nombre</th><th>Direcci√≥n</th><th>Distrito</th><th>Ciudad</th><th>Tel√©fono</th><th>Horario</th><th>Acciones</th></tr></thead>
          <tbody>
            ${arr.map(u=>`
              <tr>
                <td>${u.id}</td>
                <td>${u.nombreUbicacion}</td>
                <td>${u.direccion}</td>
                <td>${u.distrito}</td>
                <td>${u.ciudad||'‚Äî'}</td>
                <td>${u.numeroTelefono}</td>
                <td>${u.horario}</td>
                <td>
                  <button class="action-btn btn-edit" onclick="editarUbicacionPorId(${u.id})">Editar</button>
                  <button class="action-btn btn-delete" onclick="eliminarUbicacion(${u.id})">Eliminar</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    /* ================== Pagos ================== */
    async function cargarPagosAdmin() {
      const loading = document.getElementById('loadingPagosAdmin');
      const container = document.getElementById('pagosAdminTable');
      loading.classList.add('show');
      try {
        const { ok, data } = await getJson(ENDPOINTS.admin.pagos);
        window._pagosCache = ok && Array.isArray(data) ? data : [];
        renderPagosFiltrados();
      } catch (e) {
        console.error(e);
        container.innerHTML = '<p style="color:#dc3545;">Error al cargar pagos</p>';
      } finally {
        loading.classList.remove('show');
      }
    }

    function renderPagosFiltrados() {
      const container = document.getElementById('pagosAdminTable');
      const q = (document.getElementById('filtroPagosTexto')?.value || '').toLowerCase();

      const arr = (window._pagosCache || []).filter(p => {
        const usuarioTxt = (safeUsuarioNombre(p) + ' ' + (p.usuarioId ?? '')).toLowerCase();
        const idTx = (p.idTransaccion || '').toLowerCase();
        return usuarioTxt.includes(q) || idTx.includes(q);
      });

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Usuario</th><th>Membres√≠a</th><th>Monto</th><th>Fecha</th>
              <th>Transacci√≥n</th><th>M√©todo</th><th>Estado</th>
            </tr>
          </thead>
          <tbody>
            ${arr.map(p => `
              <tr>
                <td>${p.id}</td>
                <td>${safeUsuarioNombre(p)}<br><small>ID: ${p.usuarioId ?? '‚Äî'}</small></td>
                <td>${p.membresiaId ?? '‚Äî'}</td>
                <td>S/${Number(p.monto || 0).toFixed(2)}</td>
                <td>${p.fechaPago ? new Date(p.fechaPago).toLocaleString() : '‚Äî'}</td>
                <td>${p.idTransaccion || '‚Äî'}</td>
                <td>${p.metodoPago || '‚Äî'}</td>
                <td><span class="badge ${p.estadoPago==='COMPLETADO' ? 'badge-success' : 'badge-warning'}">${p.estadoPago || '‚Äî'}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    /* ================== Reportes ================== */
    function cargarReportes() {
      const rol = window.usuarioActual?.rol;
      if (rol !== 'ADMINISTRADOR') {
        const container = document.getElementById('tab-reportes');
        if (container) {
          container.innerHTML = `
            <div style="text-align:center; padding:3rem;">
              <h2 style="color:#ff4500;">Acceso restringido</h2>
              <p>Solo los administradores pueden visualizar las estad√≠sticas globales y los reportes.</p>
            </div>
          `;
        }
        return;
      }

      cargarReporteMembresias();
      cargarReporteIngresos();
      cargarReporteClases();
      cargarReporteSuscripcionesMensuales();
    }

    async function cargarReporteMembresias(){
      const loading=document.getElementById('loadingReporteMembresias');
      const content=document.getElementById('reporteMembresiaContent');
      loading.classList.add('show');

      try{
        const { ok, data:d } = await getJson(ENDPOINTS.admin.reporteMembresias);
        if (ok && d){
          content.innerHTML = `
            <p><strong>Total:</strong> ${d.totalMembresias ?? d.total ?? 0}</p>
            <p><strong>Activas:</strong> ${d.membresiasActivas ?? d.activas ?? 0}</p>
            <p><strong>B√°sico:</strong> ${d.membresiaBasico ?? 0} | <strong>Premium:</strong> ${d.membresiaPremium ?? 0} | <strong>Anual:</strong> ${d.membresiaAnual ?? 0}</p>
          `;
          window._reporteMembresias = d;
        } else content.innerHTML='<p style="color:#dc3545;">Error</p>';
      }catch{
        content.innerHTML='<p style="color:#dc3545;">Error</p>';
      } finally{
        loading.classList.remove('show');
      }
    }

    async function cargarReporteIngresos(){
      const loading=document.getElementById('loadingReporteIngresos');
      const content=document.getElementById('reporteIngresosContent');
      const periodo=document.getElementById('periodoIngresos').value;
      loading.classList.add('show');

      try{
        const { ok, data:d } = await getJson(ENDPOINTS.admin.reporteIngresos(periodo));
        if (ok && d){
          content.innerHTML = `
            <p><strong>Periodo:</strong> ${d.periodo||periodo}</p>
            <p><strong>Total ingresos:</strong> S/${Number(d.totalIngresos||0).toFixed(2)}</p>
            <p><strong>Cantidad de pagos:</strong> ${d.cantidadPagos||0}</p>
            <p><strong>Promedio por pago:</strong> S/${Number(d.promedioIngreso||0).toFixed(2)}</p>
          `;
          window._reporteIngresos = d;
        } else content.innerHTML='<p style="color:#dc3545;">Error</p>';
      }catch{
        content.innerHTML='<p style="color:#dc3545;">Error</p>';
      } finally{
        loading.classList.remove('show');
      }
    }

    async function cargarReporteClases(){
      const loading=document.getElementById('loadingReporteClases');
      const content=document.getElementById('reporteClasesContent');
      loading.classList.add('show');

      try{
        const { ok, data:lista } = await getJson(ENDPOINTS.admin.reporteClases);
        if (ok && Array.isArray(lista)){
          window._reporteClases = lista;
          const rows = lista.map(r => `
            <li>${r.nombreClase}: ${Number(r.tasaOcupacion||r.porcentajeOcupacion||0).toFixed(1)}% (Inscritos: ${r.usuariosInscritos ?? r.inscritos ?? 0}/${r.capacidadMaxima ?? r.capacidad ?? 0})</li>
          `).join('');
          content.innerHTML = rows ? `<ul>${rows}</ul>` : '<p>No hay datos</p>';
        } else content.innerHTML='<p style="color:#dc3545;">Error</p>';
      }catch{
        content.innerHTML='<p style="color:#dc3545;">Error</p>';
      } finally{
        loading.classList.remove('show');
      }
    }

    async function cargarReporteSuscripcionesMensuales() {
      const canvas = document.getElementById('graficoSuscripciones');
      const ctx = canvas.getContext('2d');
      try {
        const { ok, data } = await getJson(ENDPOINTS.admin.reporteSuscripciones);
        if (!ok) throw new Error("Error al obtener datos");

        window._suscripcionesMensuales = data;

        const labels = Object.keys(data);
        const values = Object.values(data);

        if (window.suscripcionesChart) window.suscripcionesChart.destroy();

        window.suscripcionesChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label:'Nuevas suscripciones por mes',
              data: values,
              borderColor:'#ff4500',
              backgroundColor:'rgba(255,69,0,0.2)',
              borderWidth:3,
              tension:0.3,
              fill:true,
              pointRadius:5,
              pointHoverRadius:7
            }]
          },
          options: { responsive: true,
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Cantidad' } },
              x: { title: { display: true, text: 'Mes (yyyy-MM)' } }
            }
          }
        });
      } catch (err) {
        console.error(err);
        alert('No se pudo cargar el gr√°fico de suscripciones.');
      }
    }

    /* ================== EXPORT REPORTES ================== */
    async function ensureAdminCaches() {
      const peticiones = [];

      if (!Array.isArray(window._usuariosCache)) {
        peticiones.push(getJson(ENDPOINTS.admin.usuarios).then(r => { if (r.ok) window._usuariosCache = r.data; }));
      }
      if (!Array.isArray(window._membresiasCache)) {
        peticiones.push(getJson(ENDPOINTS.admin.membresias).then(r => { if (r.ok) window._membresiasCache = r.data; }));
      }
      if (!Array.isArray(window._clasesAdminCache)) {
        peticiones.push(getJson(ENDPOINTS.admin.clases).then(r => { if (r.ok) window._clasesAdminCache = r.data; }));
      }
      if (!Array.isArray(window._ubicacionesAdminCache)) {
        peticiones.push(getJson(ENDPOINTS.ubicaciones.listar, { headers: {} }).then(r => { if (r.ok) window._ubicacionesAdminCache = r.data; }));
      }
      if (!Array.isArray(window._pagosCache)) {
        peticiones.push(getJson(ENDPOINTS.admin.pagos).then(r => { if (r.ok) window._pagosCache = r.data; }));
      }

      if (!window._reporteMembresias) {
        peticiones.push(getJson(ENDPOINTS.admin.reporteMembresias).then(r => { if (r.ok) window._reporteMembresias = r.data; }));
      }
      if (!window._reporteIngresos) {
        const periodo = document.getElementById('periodoIngresos')?.value || 'mensual';
        peticiones.push(getJson(ENDPOINTS.admin.reporteIngresos(periodo)).then(r => { if (r.ok) window._reporteIngresos = r.data; }));
      }
      if (!Array.isArray(window._reporteClases)) {
        peticiones.push(getJson(ENDPOINTS.admin.reporteClases).then(r => { if (r.ok) window._reporteClases = r.data; }));
      }
      if (!window._suscripcionesMensuales) {
        peticiones.push(getJson(ENDPOINTS.admin.reporteSuscripciones).then(r => { if (r.ok) window._suscripcionesMensuales = r.data; }));
      }

      await Promise.allSettled(peticiones);
    }

    function nowSlug() {
      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}`;
    }

    function mapUsuariosExcel(data=[]) {
      return data.map(u => ({
        ID: u.id,
        'Nombre completo': buildNombreCompleto(u),
        'Nombres': u.nombres ?? '',
        'Apellido paterno': u.apellidoPaterno ?? '',
        'Apellido materno': u.apellidoMaterno ?? '',
        'DNI': u.dni ?? '',
        'Direcci√≥n': u.direccion ?? '',
        'Email': u.correoElectronico ?? '',
        'Tel√©fono': u.numeroTelefono ?? '',
        'Rol': u.rol ?? '',
        'Activo': u.estaActivo ? 'S√≠' : 'No',
        'Registro': u.fechaCreacion ? new Date(u.fechaCreacion).toLocaleString() : ''
      }));
    }

    function mapMembresiasExcel(data=[]) {
      return data.map(m => ({
        ID: m.id,
        'Usuario ID': m.usuarioId ?? (m.usuario?.id ?? ''),
        'Usuario': m.usuarioNombre ?? safeUsuarioNombre(m),
        'Plan': m.tipoPlan ?? '',
        'Precio': m.precio ?? '',
        'Inicio': m.fechaInicio ? new Date(m.fechaInicio).toLocaleString() : '',
        'Fin': m.fechaFin ? new Date(m.fechaFin).toLocaleString() : '',
        'Estado': m.estado ?? '',
        'Auto-renovaci√≥n': m.renovacionAutomatica ? 'S√≠' : 'No',
      }));
    }

    function mapClasesExcel(data=[]) {
      return data.map(c => ({
        ID: c.id,
        'Nombre': c.nombreClase ?? '',
        'Instructor': c.nombreInstructor ?? '',
        'Horario': c.horario ?? '',
        'Capacidad': c.capacidadMaxima ?? '',
        'Inscritos': Array.isArray(c.usuariosInscritos) ? c.usuariosInscritos.length : (c.usuariosInscritos ?? c.inscritos ?? 0),
        'Duraci√≥n (min)': c.duracionMinutos ?? '',
        'Activo': c.estaActivo ? 'S√≠' : 'No',
      }));
    }

    function mapUbicacionesExcel(data=[]) {
      return data.map(u => ({
        ID: u.id,
        'Nombre': u.nombreUbicacion ?? '',
        'Direcci√≥n': u.direccion ?? '',
        'Distrito': u.distrito ?? '',
        'Ciudad': u.ciudad ?? '',
        'Tel√©fono': u.numeroTelefono ?? '',
        'Horario': u.horario ?? '',
        'Latitud': u.latitud ?? '',
        'Longitud': u.longitud ?? '',
      }));
    }

    function mapPagosExcel(data=[]) {
      return data.map(p => ({
        ID: p.id,
        'Usuario ID': p.usuarioId ?? (p.usuario?.id ?? ''),
        'Usuario': p.usuarioNombre ?? safeUsuarioNombre(p),
        'Membres√≠a ID': p.membresiaId ?? (p.membresia?.id ?? ''),
        'Monto': p.monto ?? '',
        'Fecha pago': (p.fechaPago || p.fecha) ? new Date(p.fechaPago || p.fecha).toLocaleString() : '',
        'Transacci√≥n': p.idTransaccion ?? '',
        'M√©todo': p.metodoPago ?? '',
        'Estado': p.estadoPago ?? '',
      }));
    }

    function mapReporteMembresiasExcel(r={}) {
      return [
        { M√©trica: 'Total', Valor: r.totalMembresias ?? r.total ?? 0 },
        { M√©trica: 'Activas', Valor: r.membresiasActivas ?? r.activas ?? 0 },
        { M√©trica: 'B√°sico', Valor: r.membresiaBasico ?? 0 },
        { M√©trica: 'Premium', Valor: r.membresiaPremium ?? 0 },
        { M√©trica: 'Anual', Valor: r.membresiaAnual ?? 0 },
        { M√©trica: 'Pausadas', Valor: r.membresiasPausadas ?? 0 },
        { M√©trica: 'Canceladas', Valor: r.membresiasCanceladas ?? 0 },
        { M√©trica: 'Expiradas', Valor: r.membresiasExpiradas ?? r.vencidas ?? 0 },
      ];
    }

    function mapReporteIngresosExcel(r={}) {
      return [
        { M√©trica: 'Periodo', Valor: r.periodo ?? '' },
        { M√©trica: 'Total ingresos', Valor: r.totalIngresos ?? 0 },
        { M√©trica: 'Cantidad de pagos', Valor: r.cantidadPagos ?? 0 },
        { M√©trica: 'Promedio por pago', Valor: r.promedioIngreso ?? 0 },
        { M√©trica: 'M√©todo m√°s usado', Valor: r.metodoPagoMasUsado ?? 'N/A' },
      ];
    }

    function mapReporteClasesExcel(list=[]) {
      return list.map(x => ({
        'Clase': x.nombreClase,
        'Instructor': x.nombreInstructor ?? '',
        'Capacidad': x.capacidadMaxima ?? 0,
        'Inscritos': x.usuariosInscritos ?? x.inscritos ?? 0,
        'Ocupaci√≥n %': typeof x.tasaOcupacion === 'number' ? x.tasaOcupacion.toFixed(1) : Number(x.tasaOcupacion||x.porcentajeOcupacion||0).toFixed(1),
      }));
    }

    function mapSuscripcionesMensualesExcel(obj={}) {
      return Object.entries(obj)
        .sort((a,b) => a[0].localeCompare(b[0]))
        .map(([mes, total]) => ({ Mes: mes, 'Nuevas suscripciones': total }));
    }

    async function descargarReportesExcel() {
      try {
        await ensureAdminCaches();
        const wb = XLSX.utils.book_new();

        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapUsuariosExcel(window._usuariosCache || [])), 'Usuarios');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapMembresiasExcel(window._membresiasCache || [])), 'Membresias');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapClasesExcel(window._clasesAdminCache || [])), 'Clases');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapUbicacionesExcel(window._ubicacionesAdminCache || [])), 'Ubicaciones');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapPagosExcel(window._pagosCache || [])), 'Pagos');

        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapReporteMembresiasExcel(window._reporteMembresias || {})), 'Rpt_Membresias');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapReporteIngresosExcel(window._reporteIngresos || {})), 'Rpt_Ingresos');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapReporteClasesExcel(window._reporteClases || [])), 'Rpt_Clases');

        if (window._suscripcionesMensuales) {
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapSuscripcionesMensualesExcel(window._suscripcionesMensuales)), 'Suscripciones_Mensuales');
        }

        XLSX.writeFile(wb, `reportes_fitzone_${nowSlug()}.xlsx`);
      } catch (e) {
        console.error(e);
        alert('No se pudo generar el Excel');
      }
    }

    async function descargarReportesPDF() {
      try {
        await ensureAdminCaches();

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt');
        const margin = 36;
        let y = margin;

        const addTitle = (t) => {
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(14);
          doc.text(t, margin, y);
          y += 8;
          doc.setLineWidth(0.5);
          doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y);
          y += 12;
        };

        const addTable = (head, body) => {
          doc.autoTable({
            startY: y,
            head: [head],
            body,
            styles: { fontSize: 9 },
            headStyles: { fillColor: [255, 69, 0], textColor: 255 },
            margin: { left: margin, right: margin },
            theme: 'striped',
            didDrawPage: (data) => { y = data.cursor.y + 18; }
          });
        };

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.text('Reporte General - FitZone', margin, y);
        y += 20;

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(11);
        doc.text(`Fecha: ${new Date().toLocaleString()}`, margin, y);
        y += 24;

        addTitle('Resumen de Membres√≠as');
        addTable(['M√©trica', 'Valor'], mapReporteMembresiasExcel(window._reporteMembresias || {}).map(r => [r['M√©trica'], String(r['Valor'])]));

        addTitle('Resumen de Ingresos');
        addTable(['M√©trica', 'Valor'], mapReporteIngresosExcel(window._reporteIngresos || {}).map(r => [r['M√©trica'], String(r['Valor'])]));

        addTitle('Clases (Ocupaci√≥n)');
        const rc = mapReporteClasesExcel(window._reporteClases || []);
        addTable(['Clase', 'Instructor', 'Capacidad', 'Inscritos', 'Ocupaci√≥n %'],
          rc.map(x => [x['Clase'], x['Instructor'], String(x['Capacidad']), String(x['Inscritos']), String(x['Ocupaci√≥n %'])])
        );

        if (window._suscripcionesMensuales) {
          addTitle('Evoluci√≥n Mensual de Suscripciones');
          const sm = mapSuscripcionesMensualesExcel(window._suscripcionesMensuales);
          addTable(['Mes', 'Nuevas suscripciones'], sm.map(r => [r['Mes'], String(r['Nuevas suscripciones'])]));
        }

        addTitle('Usuarios (resumen)');
        const u = mapUsuariosExcel((window._usuariosCache || [])).slice(0, 20);
        addTable(['ID','Nombre completo','Email','Tel√©fono','Rol','Activo','Registro'],
          u.map(r => [String(r['ID']), r['Nombre completo'], r['Email'], r['Tel√©fono'], r['Rol'], r['Activo'], r['Registro']])
        );

        addTitle('Membres√≠as (resumen)');
        const mm = mapMembresiasExcel((window._membresiasCache || [])).slice(0, 20);
        addTable(['ID','Usuario','Plan','Precio','Inicio','Fin','Estado','Auto-renovaci√≥n'],
          mm.map(r => [String(r['ID']), r['Usuario'], r['Plan'], String(r['Precio']), r['Inicio'], r['Fin'], r['Estado'], r['Auto-renovaci√≥n']])
        );

        doc.save(`reportes_fitzone_${nowSlug()}.pdf`);
      } catch (e) {
        console.error(e);
        alert('No se pudo generar el PDF');
      }
    }

    /* ===== export util para tablas ===== */
    function tablaDOMToArrays(tableEl){
      const head = [...tableEl.querySelectorAll('thead th')].map(th=>th.innerText.trim());
      const body = [...tableEl.querySelectorAll('tbody tr')].map(tr =>
        [...tr.children].map(td => td.innerText.trim())
      );
      return { head, body };
    }

    function descargarTablaComoPDF(tableContainerId, filenameBase='Tabla'){
      const table = document.querySelector(`#${tableContainerId} table`);
      if(!table){ alert('No hay datos para exportar'); return; }
      const { head, body } = tablaDOMToArrays(table);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p','pt');
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text(filenameBase, 36, 40);
      doc.autoTable({
        startY: 60,
        head: [head],
        body: body,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [255,69,0], textColor: 255 },
        margin: { left: 36, right: 36 },
        theme: 'striped'
      });
      doc.save(`${filenameBase}_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    function descargarTablaComoExcel(tableContainerId, filenameBase='Tabla'){
      const table = document.querySelector(`#${tableContainerId} table`);
      if(!table){ alert('No hay datos para exportar'); return; }
      const { head, body } = tablaDOMToArrays(table);
      const rows = body.map(r=>{
        const obj = {};
        head.forEach((h,i)=>{ obj[h] = r[i] ?? ''; });
        return obj;
      });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), 'Datos');
      XLSX.writeFile(wb, `${filenameBase}_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    /* ================== ONLOAD ================== */
    window.addEventListener('DOMContentLoaded', () => {
      verificarSesion();
      actualizarUIUsuario();

      if (!window.usuarioActual || !localStorage.getItem('token')) {
        alert('Inicia sesi√≥n primero.');
        window.location.href = 'login.html';
        return;
      }

      configurarTabsAdminPorRol(window.usuarioActual?.rol || 'ADMINISTRADOR');

      if (window.usuarioActual?.rol === 'ENTRENADOR') {
        cambiarTabAdmin('clases-admin', document.querySelector('[data-tab="clases-admin"]'));
      } else {
        cargarDashboard();
      }
    });
  </script>
</body>
</html>
