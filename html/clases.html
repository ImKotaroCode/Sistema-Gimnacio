<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartFit - Clases</title>
  <link rel="stylesheet" href="/css/estilos.css" />
</head>
<body>
  <nav>
    <ul>
      <li class="logo">SMARTFIT</li>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
      <div class="nav-links" id="navLinks">
        <li><a href="index.html">Inicio</a></li>
        <li><a href="precios.html">Precios</a></li>
        <li><a href="ubicaciones.html">Ubicaciones</a></li>
        <li><a href="clases.html">Clases</a></li>
        <li><a href="contacto.html">Contacto</a></li>
        <li id="perfilLink" style="display:none;"><a href="miperfil.html">Mi Perfil</a></li>
        <li id="adminLink" style="display:none;"><a href="admin.html">Panel Admin</a></li>
        <li class="user-info" id="userInfo">
          <span class="user-name" id="userName"></span>
          <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </li>
        <li id="authLink"><a href="login.html">Login</a></li>
      </div>
    </ul>
  </nav>

  <div class="page active" id="classes">
    <div class="classes-container">
      <h2 style="text-align:center; color:#ff4500; margin-bottom:2rem;">Clases y Horarios</h2>

      <div class="section-top">
        <div class="filters">
          <input
            type="text"
            id="filtroPublicClasesTexto"
            placeholder="Buscar por nombre o instructor"
            oninput="renderClasesPublicas()"
          />
        </div>
      </div>

      <div class="loading" id="loadingClasses">
        <div class="spinner"></div>
        <p>Cargando clases...</p>
      </div>

      <div class="classes-grid" id="classesList"></div>
    </div>
  </div>

<script>
const API_URL = 'http://localhost:8080/api';
const ENDPOINTS = {
  clases: {
    listar: `${API_URL}/clases`,
    inscribir: `${API_URL}/clases/inscribir`
  }
};

function toggleMobileMenu(){
  document.getElementById('navLinks').classList.toggle('active');
}

function verificarSesion(){
  const u = localStorage.getItem('usuario');
  const t = localStorage.getItem('token');
  window.usuarioActual = (u && t) ? JSON.parse(u) : null;
}

function actualizarUIUsuario() {
  const isLogged = !!window.usuarioActual;
  const isAdmin = window.usuarioActual?.rol === 'ADMINISTRADOR' || window.usuarioActual?.rol === 'ENTRENADOR';

  document.getElementById('authLink').style.display = isLogged ? 'none' : 'block';
  document.getElementById('userInfo').classList.toggle('active', isLogged);
  document.getElementById('userName').textContent = isLogged ? (window.usuarioActual.nombreCompleto || '') : '';
  document.getElementById('perfilLink').style.display = isLogged ? 'block' : 'none';
  document.getElementById('adminLink').style.display = isAdmin ? 'block' : 'none';
}

function authHeaders() {
  const t = localStorage.getItem('token') || '';
  return t ? { 'Authorization': 'Bearer ' + t } : {};
}

function isTokenExpiredFromResponse(data) {
  if (!data) return false;
  const txt = (data.mensaje || data.message || '').toString().toLowerCase();
  return txt.includes('token_expirado') || txt.includes('token expirado');
}

function handleTokenExpiredLogout() {
  localStorage.removeItem('token');
  localStorage.removeItem('usuario');
  window.usuarioActual = null;
  alert('Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.');
  window.location.href = 'login.html';
}

async function cargarClases(){
  const loading = document.getElementById('loadingClasses');
  const list = document.getElementById('classesList');
  loading.classList.add('show');
  try{
    const res = await fetch(ENDPOINTS.clases.listar, {
      headers:{ Accept:'application/json' }
    });
    const data = await res.json();
    window._clasesCache = Array.isArray(data) ? data : [];
    renderClasesPublicas();
  }catch(e){
    console.error(e);
    list.innerHTML = '<p style="color:#ff4500; text-align:center;">Error al cargar clases.</p>';
  }finally{
    loading.classList.remove('show');
  }
}

function renderClasesPublicas(){
  const list = document.getElementById('classesList');
  const q = (document.getElementById('filtroPublicClasesTexto')?.value || '').toLowerCase();

  const arr = (window._clasesCache || [])
    // solo mostramos clases activas
    .filter(c => c.estaActivo !== false)
    .filter(c =>
      `${c.nombreClase||''} ${c.nombreInstructor||''}`.toLowerCase().includes(q)
    );

  if (!arr.length) {
    list.innerHTML = '<p style="color:#ff4500; text-align:center;">No hay clases disponibles.</p>';
    return;
  }

  list.innerHTML = arr.map(c => {
    const inscritos = (typeof c.usuariosInscritos === 'number')
      ? c.usuariosInscritos
      : (Array.isArray(c.usuariosInscritos) ? c.usuariosInscritos.length : (c.inscritos||0));

    const cap = Number(c.capacidadMaxima || 0);
    const cupos = Math.max(cap - inscritos, 0);
    const llena = cap > 0 && inscritos >= cap;

    const horarioStr = (typeof c.horario === 'string' && c.horario.trim())
      ? c.horario
      : (c.horario ? String(c.horario) : '‚Äî');

    const deshabilitar = llena || c.estaActivo === false;

    return `
      <div class="class-card">
        <h3>${c.nombreClase || '‚Äî'}</h3>
        <p>${c.descripcion || ''}</p>
        <p style="margin:1rem 0;"><strong>üìÖ ${horarioStr}</strong></p>
        <p><strong>üë®‚Äçüè´ Instructor:</strong> ${c.nombreInstructor || '‚Äî'}</p>
        <p class="spots">
          üéØ Cupos:
          <span class="cupos" id="cupos-${c.id}">${cupos}</span>/${cap || '‚Äî'}
          ${
            llena
              ? '<span class="badge badge-warning" style="margin-left:.5rem;">Completa</span>'
              : ''
          }
        </p>
        <button
          class="btn"
          id="btn-insc-${c.id}"
          onclick="inscribirseEnClase(${c.id})"
          ${deshabilitar ? 'disabled' : ''}
        >
          Inscribirme
        </button>
      </div>`;
  }).join('');
}

async function inscribirseEnClase(claseId){
  if (!window.usuarioActual){
    alert('Debes iniciar sesi√≥n para inscribirte.');
    window.location.href = 'login.html';
    return;
  }

  const btn = document.getElementById(`btn-insc-${claseId}`);

  try{
    if (btn) btn.disabled = true;

    const payload = {
      usuarioId: window.usuarioActual.id,
      claseId
    };

    const res = await fetch(ENDPOINTS.clases.inscribir, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Accept':'application/json',
        ...authHeaders()
      },
      body: JSON.stringify(payload)
    });

    let data = null;
    try { data = await res.json(); } catch(e) { data = null; }

    if (res.status === 401 && isTokenExpiredFromResponse(data)) {
      handleTokenExpiredLogout();
      return;
    }

    if (!res.ok) {
      throw new Error(data?.mensaje || data?.error || 'No se pudo inscribir');
    }

    await cargarClases();

    alert(data?.mensaje || 'Inscripci√≥n exitosa');
  }catch(e){
    console.error(e);
    alert('‚ùå ' + e.message);
    if (btn) btn.disabled = false;
  }
}

function cerrarSesion() {
  localStorage.removeItem('token');
  localStorage.removeItem('usuario');
  window.usuarioActual = null;
  actualizarUIUsuario();
  alert('Sesi√≥n cerrada');
  window.location.href = 'login.html';
}

window.addEventListener('DOMContentLoaded', () => {
  verificarSesion();
  actualizarUIUsuario();
  cargarClases();
});
</script>
</body>
</html>
