<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SmartFit - Login</title>
    <link rel="stylesheet" href="/css/estilos.css" />

    <style>
      .auth-container {
        display: flex;
        justify-content: center;
        padding: 30px 12px;
      }
      .auth-form {
        max-width: 520px;
        width: 100%;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 520px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }
      .auth-form h2 {
        margin-bottom: 14px;
      }
      .success-message,
      .error-message {
        display: none;
        margin: 10px 0;
        padding: 10px;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <nav>
      <ul>
        <li class="logo">SMARTFIT</li>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>
        <div class="nav-links" id="navLinks">
          <li><a href="/index.html">Inicio</a></li>
          <li><a href="/html/precios.html">Precios</a></li>
          <li><a href="/html/ubicaciones.html">Ubicaciones</a></li>
          <li><a href="/html/clases.html">Clases</a></li>
          <li><a href="/html/contacto.html">Contacto</a></li>
          <li id="perfilLink" style="display: none">
            <a href="/html/miperfil.html">Mi Perfil</a>
          </li>
          <li id="adminLink" style="display: none">
            <a href="/html/admin.html">Panel Admin</a>
          </li>
          <li class="user-info" id="userInfo">
            <span class="user-name" id="userName"></span>
            <button class="btn-logout" onclick="cerrarSesion()">
              Cerrar Sesión
            </button>
          </li>
          <li id="authLink">
            <a href="/html/login.html">Login</a>
          </li>
        </div>
      </ul>
    </nav>

    <div class="page active" id="login">
      <div class="auth-container">
        <div class="auth-form">
          <h2 id="authTitle">Iniciar Sesión</h2>

          <div id="successMsg" class="success-message"></div>
          <div id="errorMsg" class="error-message"></div>

          <form id="authForm" onsubmit="manejarAutenticacion(event)">
            <div id="registerFields" style="display: none">
              <div class="grid-2">
                <div class="form-group">
                  <label>Nombres</label>
                  <input type="text" id="nombres" placeholder="Ej: Alexander" maxlength="25" />
                </div>

                <div class="form-group">
                  <label>DNI</label>
                  <input
                    type="text"
                    id="dni"
                    placeholder="8 dígitos"
                    maxlength="8"
                    inputmode="numeric"
                  />
                </div>

                <div class="form-group">
                  <label>Apellido Paterno</label>
                  <input
                    type="text"
                    id="apellidoPaterno"
                    placeholder="Ej: Ferrua"
                    maxlength="20"
                  />
                </div>

                <div class="form-group">
                  <label>Apellido Materno</label>
                  <input
                    type="text"
                    id="apellidoMaterno"
                    placeholder="Ej: Rúa"
                    maxlength="20"
                  />
                </div>
              </div>

              <div class="form-group" style="margin-top: 12px">
                <label>Dirección</label>
                <input
                  type="text"
                  id="direccion"
                  placeholder="Ej: Av. Los Olivos 123"
                  maxlength="60"
                />
              </div>

              <div class="form-group" style="margin-top: 12px">
                <label>Teléfono</label>
                <input
                  type="tel"
                  id="numeroTelefono"
                  placeholder="+51 999 999 999"
                  maxlength="9"
                />
              </div>
            </div>

            <!-- Comunes login/registro -->
            <div class="form-group" style="margin-top: 12px">
              <label>Correo</label>
              <input type="email" id="correoElectronico" required />
            </div>

            <div class="form-group">
              <label>Contraseña</label>
              <input type="password" id="contrasena" required />
            </div>

            <button type="submit" class="btn" id="btnAuth" style="width: 100%">
              Continuar
            </button>
          </form>

          <div class="auth-links">
            <p id="toggleText">
              ¿No tienes cuenta?
              <a href="#" onclick="cambiarModoAuth(event)">Regístrate</a>
            </p>
            <p>
              <a
                href="#"
                onclick="
                  mostrarMensaje(
                    'Función demo: recuperación no implementada',
                    'success',
                  )
                "
                >¿Olvidaste tu contraseña?</a
              >
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE =
        location.hostname === "localhost"
          ? "http://localhost:8080"
          : "https://gimnacioapi.onrender.com";

      const API_URL = `${API_BASE}/api`;

      const ENDPOINTS = {
        auth: {
          login: `${API_URL}/autenticacion/iniciar-sesion`,
          register: `${API_URL}/autenticacion/registrar`,
        },
      };

      function toggleMobileMenu() {
        document.getElementById("navLinks").classList.toggle("active");
      }

      function verificarSesion() {
        const u = localStorage.getItem("usuario");
        const t = localStorage.getItem("token");
        window.usuarioActual = u && t ? JSON.parse(u) : null;
      }

      function actualizarUIUsuario() {
        const isLogged = !!window.usuarioActual;
        const isAdmin =
          window.usuarioActual?.rol === "ADMINISTRADOR" ||
          window.usuarioActual?.rol === "ENTRENADOR";

        document.getElementById("authLink").style.display = isLogged
          ? "none"
          : "block";
        document
          .getElementById("userInfo")
          .classList.toggle("active", isLogged);
        document.getElementById("userName").textContent = isLogged
          ? window.usuarioActual.nombreCompleto || ""
          : "";
        document.getElementById("perfilLink").style.display = isLogged
          ? "block"
          : "none";
        document.getElementById("adminLink").style.display = isAdmin
          ? "block"
          : "none";
      }

      function mostrarMensaje(msg, tipo) {
        const s = document.getElementById("successMsg");
        const e = document.getElementById("errorMsg");
        if (tipo === "success") {
          s.textContent = msg;
          s.classList.add("show");
          e.classList.remove("show");
          setTimeout(() => s.classList.remove("show"), 2500);
        } else {
          e.textContent = msg;
          e.classList.add("show");
          s.classList.remove("show");
          setTimeout(() => e.classList.remove("show"), 4500);
        }
      }

      function esModoRegistro() {
        return (
          document.getElementById("registerFields").style.display !== "none"
        );
      }

      function normalizarTelefono(raw) {
        if (!raw) return null;
        let t = raw.trim().replace(/[^\d+]/g, "");
        if (t && !t.startsWith("+")) t = "+51" + t;
        return t || null;
      }

      function validarRegistroLocal(payload) {
        if (!payload.nombres || payload.nombres.trim().length < 2)
          return "Nombres requeridos";
        if (
          !payload.apellidoPaterno ||
          payload.apellidoPaterno.trim().length < 2
        )
          return "Apellido paterno requerido";
        if (
          !payload.apellidoMaterno ||
          payload.apellidoMaterno.trim().length < 2
        )
          return "Apellido materno requerido";
        if (!payload.dni || !/^\d{8}$/.test(payload.dni))
          return "DNI inválido (8 dígitos)";
        if (!payload.direccion || payload.direccion.trim().length < 5)
          return "Dirección requerida";
        return null;
      }

      async function manejarAutenticacion(event) {
        event.preventDefault();

        const correoElectronico = document
          .getElementById("correoElectronico")
          .value.trim();
        const contrasena = document.getElementById("contrasena").value;

        const btnAuth = document.getElementById("btnAuth");
        btnAuth.disabled = true;
        btnAuth.textContent = "Procesando...";

        try {
          let url, body;

          if (!esModoRegistro()) {
            url = ENDPOINTS.auth.login;
            body = { correoElectronico, contrasena };
          } else {
            const nombres = document.getElementById("nombres").value.trim();
            const apellidoPaterno = document
              .getElementById("apellidoPaterno")
              .value.trim();
            const apellidoMaterno = document
              .getElementById("apellidoMaterno")
              .value.trim();
            const dni = document.getElementById("dni").value.trim();
            const direccion = document.getElementById("direccion").value.trim();
            const numeroTelefono = normalizarTelefono(
              document.getElementById("numeroTelefono").value,
            );

            url = ENDPOINTS.auth.register;
            body = {
              nombres,
              apellidoPaterno,
              apellidoMaterno,
              dni,
              direccion,
              correoElectronico,
              contrasena,
              numeroTelefono,
            };

            const err = validarRegistroLocal(body);
            if (err) {
              mostrarMensaje(err, "error");
              return;
            }
          }

          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(body),
          });

          const text = await res.text();
          let data = null;
          try {
            data = text ? JSON.parse(text) : null;
          } catch {
            data = null;
          }

          if (res.ok && data?.token) {
            localStorage.setItem("token", data.token);
            localStorage.setItem(
              "usuario",
              JSON.stringify({
                usuarioId: data.usuarioId,
                nombreCompleto: data.nombreCompleto,
                correoElectronico: data.correoElectronico,
                rol:
                  data.rol ||
                  data.authority ||
                  (Array.isArray(data.roles) ? data.roles[0] : "USUARIO"),
              }),
            );
            window.usuarioActual = JSON.parse(localStorage.getItem("usuario"));
            mostrarMensaje("¡Bienvenido!", "success");
            setTimeout(() => {
              window.location.href = "/index.html";
            }, 700);
          } else {
            const backendMsg =
              (data && (data.mensaje || data.error || data.message)) ||
              (text && text.length < 250 ? text : null) ||
              "Error en la autenticación";

            mostrarMensaje(backendMsg, "error");
          }
        } catch (e) {
          console.error(e);
          mostrarMensaje("Error de conexión", "error");
        } finally {
          btnAuth.disabled = false;
          btnAuth.textContent = "Continuar";
        }
      }

      function cerrarSesion() {
        localStorage.removeItem("token");
        localStorage.removeItem("usuario");
        window.usuarioActual = null;
        actualizarUIUsuario();
        mostrarMensaje("Sesión cerrada", "success");
      }

      function cambiarModoAuth(e) {
        e.preventDefault();
        const loginMode = !esModoRegistro(); // si estaba login => pasa a registro

        document.getElementById("authTitle").textContent = loginMode
          ? "Crear Cuenta"
          : "Iniciar Sesión";
        document.getElementById("registerFields").style.display = loginMode
          ? "block"
          : "none";

        document.getElementById("toggleText").innerHTML = loginMode
          ? '¿Ya tienes cuenta? <a href="#" onclick="cambiarModoAuth(event)">Inicia Sesión</a>'
          : '¿No tienes cuenta? <a href="#" onclick="cambiarModoAuth(event)">Regístrate</a>';
      }

      window.addEventListener("DOMContentLoaded", () => {
        verificarSesion();
        actualizarUIUsuario();
      });
    </script>
  </body>
</html>
