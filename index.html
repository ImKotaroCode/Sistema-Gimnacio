<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartFit - Tu Gimnasio 24/7</title>

  <link rel="stylesheet" href="css/estilos.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://js.stripe.com/v3"></script>

</head>
<body>
  <nav>
    <ul>
      <li class="logo">SMARTFIT</li>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
      <div class="nav-links" id="navLinks">
        <li><a href="#" onclick="showPage('home')">Inicio</a></li>
        <li><a href="#" onclick="showPage('pricing')">Precios</a></li>
        <li><a href="#" onclick="showPage('locations')">Ubicaciones</a></li>
        <li><a href="#" onclick="showPage('classes')">Clases</a></li>
        <li><a href="#" onclick="showPage('contact')">Contacto</a></li>
        <li id="perfilLink" style="display:none;"><a href="#" onclick="showPage('perfil')">Mi Perfil</a></li>
        <li id="adminLink" style="display:none;"><a href="#" onclick="showPage('admin')">Panel Admin</a></li>
        <li class="user-info" id="userInfo">
          <span class="user-name" id="userName"></span>
          <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </li>
        <li id="authLink"><a href="#" onclick="showPage('login')">Login</a></li>
      </div>
    </ul>
  </nav>

  <!-- ================= HOME ================= -->
  <div id="home" class="page active">
    <div class="hero">
      <h1>Transforma tu <span class="highlight">Vida</span></h1>
      <p>Acceso 24/7 a m√°s de 50 ubicaciones. Equipamiento de √∫ltima generaci√≥n. Clases ilimitadas.</p>
      <div>
        <button class="btn" onclick="showPage('pricing')">√önete Ahora</button>
        <button class="btn btn-secondary" onclick="showPage('pricing')">Ver Precios</button>
      </div>
    </div>

    <div class="features">
      <h2>¬øPor Qu√© Elegir Smart Fit?</h2>
      <div class="features-grid">
        <div class="feature-card"><div class="feature-icon">üèãÔ∏è</div><h3>Equipamiento Premium</h3><p>Las mejores m√°quinas y equipos del mercado.</p></div>
        <div class="feature-card"><div class="feature-icon">üïê</div><h3>Acceso 24/7</h3><p>Entrena cuando quieras, donde quieras.</p></div>
        <div class="feature-card"><div class="feature-icon">üë•</div><h3>Clases Grupales</h3><p>Yoga, spinning, crossfit y m√°s.</p></div>
        <div class="feature-card"><div class="feature-icon">üìç</div><h3>+50 Ubicaciones</h3><p>Un solo plan, m√∫ltiples sedes.</p></div>
      </div>
    </div>
  </div>

  <!-- ================= PRECIOS ================= -->
  <div id="pricing" class="page">
    <div class="pricing-container">
      <h2>Planes y Precios</h2>
      <div class="pricing-grid">
        <div class="pricing-card">
          <h3>Plan B√°sico</h3>
          <div class="price">S/29<span style="font-size:1rem;">/mes</span></div>
          <ul class="pricing-features">
            <li>Acceso a 1 gimnasio</li><li>Horario 6am - 10pm</li><li>√Årea de pesas</li><li>Cardio ilimitado</li>
          </ul>
          <button class="btn" onclick="seleccionarPlan('BASICO',29)">Seleccionar</button>
        </div>
        <div class="pricing-card featured">
          <h3>Plan Premium</h3>
          <div class="price">S/49<span style="font-size:1rem;">/mes</span></div>
          <ul class="pricing-features">
            <li>Acceso a todas las sedes</li><li>Acceso 24/7</li><li>Todas las clases</li><li>1 sesi√≥n personal</li>
          </ul>
          <button class="btn" onclick="seleccionarPlan('PREMIUM',49)">Seleccionar</button>
        </div>
        <div class="pricing-card">
          <h3>Plan Anual</h3>
          <div class="price">S/399<span style="font-size:1rem;">/a√±o</span></div>
          <ul class="pricing-features">
            <li>Todo del Plan Premium</li><li>Ahorra S/189</li><li>3 sesiones/mes</li><li>Plan nutricional</li>
          </ul>
          <button class="btn" onclick="seleccionarPlan('ANUAL',399)">Seleccionar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= LOGIN ================= -->
  <div id="login" class="page">
    <div class="auth-container">
      <div class="auth-form">
        <h2 id="authTitle">Iniciar Sesi√≥n</h2>
        <div id="successMsg" class="success-message"></div>
        <div id="errorMsg" class="error-message"></div>
        <form id="authForm" onsubmit="manejarAutenticacion(event)">
          <div class="form-group" id="nameGroup" style="display:none;">
            <label>Nombre Completo</label><input type="text" id="nombreCompleto" placeholder="Tu nombre" />
          </div>
          <div class="form-group"><label>Correo</label><input type="email" id="correoElectronico" required /></div>
          <div class="form-group" id="phoneGroup" style="display:none;">
            <label>Tel√©fono</label><input type="tel" id="numeroTelefono" placeholder="+51 999 999 999" />
          </div>
          <div class="form-group"><label>Contrase√±a</label><input type="password" id="contrasena" required /></div>
          <button type="submit" class="btn" id="btnAuth" style="width:100%;">Continuar</button>
        </form>
        <div class="auth-links">
          <p id="toggleText">¬øNo tienes cuenta? <a href="#" onclick="cambiarModoAuth(event)">Reg√≠strate</a></p>
          <p><a href="#" onclick="mostrarMensaje('Se ha enviado un enlace de recuperaci√≥n a tu correo','success')">¬øOlvidaste tu contrase√±a?</a></p>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= UBICACIONES ================= -->
  <div id="locations" class="page">
    <div class="locations-container">
      <h2>Encuentra tu FitZone</h2>

      <!-- Mapa con overlay -->
      <div class="map-container-full">
        <div id="map"></div>
        <div class="map-dim"></div>
        <div class="map-overlay">
          <div class="map-emoji">üó∫Ô∏è</div>
          <div class="map-title">Mapa Interactivo - Integraci√≥n con Google Maps</div>
          <div class="map-sub">En producci√≥n: b√∫squeda por ubicaci√≥n GPS</div>
        </div>
      </div>

      <!-- Filtro -->
      <div class="section-top" style="margin-top:1.25rem;">
        <div class="filters">
          <input type="text" id="filtroPublicUbicacionesTexto" placeholder="üîç Buscar distrito o ciudad" oninput="renderUbicacionesPublicas()"/>
        </div>
      </div>

      <div class="loading" id="loadingLocations">
        <div class="spinner"></div>
        <p>Cargando ubicaciones...</p>
      </div>

      <!-- Cards 3 columnas (render din√°mico) -->
      <div class="locations-grid" id="locationsList"></div>
    </div>
  </div>

  <!-- ================= CLASES ================= -->
  <div id="classes" class="page">
    <div class="classes-container">
      <h2 style="text-align:center; color:#ff4500; margin-bottom:2rem;">Clases y Horarios</h2>
      <div class="section-top">
        <div class="filters">
          <input type="text" id="filtroPublicClasesTexto" placeholder="Buscar por nombre o instructor" oninput="renderClasesPublicas()"/>
        </div>
      </div>
      <div class="loading" id="loadingClasses"><div class="spinner"></div><p>Cargando clases...</p></div>
      <div class="classes-grid" id="classesList"></div>
    </div>
  </div>

  <!-- ================= CONTACTO ================= -->
  <div id="contact" class="page">
    <div class="contact-container">
      <h2 style="text-align:center; color:#ff4500; margin-bottom:2rem;">Contacto</h2>
      <div class="contact-grid">
        <div>
          <div class="contact-info">
            <h3>Informaci√≥n de Contacto</h3>
            <p><strong>üìû Tel√©fono:</strong> +51 999 000 111</p>
            <p><strong>‚úâÔ∏è Email:</strong> hola@smartfit.com</p>
            <p><strong>‚è∞ Atenci√≥n:</strong> 24/7 v√≠a chat y email</p>
          </div>
        </div>
        <div>
          <div class="auth-form">
            <h3 style="text-align:center; color:#ff4500;">Env√≠anos un Mensaje</h3>
            <div id="contactSuccessMsg" class="success-message"></div>
            <div id="contactErrorMsg" class="error-message"></div>
            <form onsubmit="enviarMensajeContacto(event)">
              <div class="form-group"><label>Nombre</label><input type="text" id="contactNombre" required /></div>
              <div class="form-group"><label>Email</label><input type="email" id="contactEmail" required /></div>
              <div class="form-group"><label>Asunto</label><input type="text" id="contactAsunto" required /></div>
              <div class="form-group"><label>Mensaje</label><textarea id="contactMensaje" required style="min-height:120px;"></textarea></div>
              <button type="submit" class="btn" id="btnContact" style="width:100%;">Enviar Mensaje</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= PAGO ================= -->
  <div id="payment" class="page">
    <div class="payment-container" style="max-width:800px;">
      <h2 style="text-align:center; color:#ff4500; margin-bottom:2rem;">Completar Pago</h2>
      <div class="payment-summary">
        <h3>Resumen de tu pedido</h3>
        <p><strong>Plan seleccionado:</strong> <span id="selectedPlan">-</span></p>
        <p><strong>Total:</strong> S/<span id="totalAmount">0</span></p>
      </div>
      <div class="auth-form">
        <h3 style="color:#ff4500;">Datos de Pago</h3>
        <div id="paymentSuccessMsg" class="success-message"></div>
        <div id="paymentErrorMsg" class="error-message"></div>
        <form onsubmit="procesarPago(event)">
          <div class="form-group"><label>Nombre en la Tarjeta</label><input type="text" id="nombreTarjeta" required /></div>
          <div class="form-group"><label>N√∫mero de Tarjeta</label><input type="text" id="numeroTarjeta" required maxlength="19" /></div>
          <div class="form-group"><label>Fecha de Expiraci√≥n</label><input type="text" id="fechaExpiracion" required maxlength="5" /></div>
          <div class="form-group"><label>CVV</label><input type="text" id="cvv" required maxlength="4" /></div>
          <button type="submit" class="btn" id="btnPayment" style="width:100%;">Confirmar Pago</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ================= ADMIN  ================= -->
  <div id="admin" class="page">
    <div class="admin-container">
      <div class="admin-header">
        <h1>Panel de Administraci√≥n</h1>
        <p>Gesti√≥n completa del gimnasio</p>
      </div>

      <div class="admin-tabs" id="adminTabs">
        <button class="admin-tab active" data-tab="dashboard" onclick="cambiarTabAdmin('dashboard', this)">Dashboard</button>
        <button class="admin-tab" data-tab="usuarios" onclick="cambiarTabAdmin('usuarios', this)">Usuarios</button>
        <button class="admin-tab" data-tab="membresias" onclick="cambiarTabAdmin('membresias', this)">Membres√≠as</button>
        <button class="admin-tab" data-tab="clases-admin" onclick="cambiarTabAdmin('clases-admin', this)">Clases</button>
        <button class="admin-tab" data-tab="ubicaciones-admin" onclick="cambiarTabAdmin('ubicaciones-admin', this)">Ubicaciones</button>
        <button class="admin-tab" data-tab="pagos-admin" onclick="cambiarTabAdmin('pagos-admin', this)">Pagos</button>
        <button class="admin-tab" data-tab="reportes" onclick="cambiarTabAdmin('reportes', this)">Reportes</button>
      </div>

      <!-- DASHBOARD -->
      <div id="tab-dashboard" class="admin-content active">
        <h2 class="section-title">Estad√≠sticas Generales</h2>
        <div class="loading" id="loadingDashboard"><div class="spinner"></div><p>Cargando estad√≠sticas...</p></div>
        <div class="dashboard-grid" id="dashboardStats"></div>
      </div>

      <!-- USUARIOS -->
      <div id="tab-usuarios" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Usuarios</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearUsuario()">+ Crear Usuario</button>
            <div class="filters">
              <input type="text" id="filtroUsuariosTexto" placeholder="Buscar por nombre o email" oninput="renderUsuariosFiltrados()"/>
              <select id="filtroUsuariosRol" onchange="renderUsuariosFiltrados()">
                <option value="">Todos los roles</option>
                <option value="USUARIO">Usuario</option>
                <option value="ENTRENADOR">Entrenador</option>
                <option value="ADMINISTRADOR">Administrador</option>
              </select>
              <select id="filtroUsuariosEstado" onchange="renderUsuariosFiltrados()">
                <option value="">Todos</option>
                <option value="true">Activos</option>
                <option value="false">Inactivos</option>
              </select>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingUsuarios"><div class="spinner"></div><p>Cargando usuarios...</p></div>
        <div class="data-table" id="usuariosTable"></div>
      </div>

      <!-- MEMBRES√çAS -->
      <div id="tab-membresias" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Membres√≠as</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearMembresia()">+ Crear Membres√≠a (Presencial)</button>
            <div class="filters">
              <input type="text" id="filtroMembresiasTexto" placeholder="Buscar por usuario o plan" oninput="renderMembresiasFiltradas"/>
              <select id="filtroMembresiasEstado" onchange="renderMembresiasFiltradas()">
                <option value="">Estado: Todos</option>
                <option value="ACTIVO">Activo</option>
                <option value="PAUSADO">Pausado</option>
                <option value="CANCELADO">Cancelado</option>
                <option value="EXPIRADO">Expirado</option>
              </select>
              <select id="filtroMembresiasPlan" onchange="renderMembresiasFiltradas()">
                <option value="">Plan: Todos</option>
                <option value="BASICO">B√°sico</option>
                <option value="PREMIUM">Premium</option>
                <option value="ANUAL">Anual</option>
              </select>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingMembresias"><div class="spinner"></div><p>Cargando membres√≠as...</p></div>
        <div class="data-table" id="membresiasTable"></div>
      </div>

      <!-- CLASES -->
      <div id="tab-clases-admin" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Clases</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearClase()">+ Crear Nueva Clase</button>
            <div class="filters">
              <input type="text" id="filtroClasesTexto" placeholder="Buscar por nombre o instructor" oninput="renderClasesAdminFiltradas()"/>
              <select id="filtroClasesEstado" onchange="renderClasesAdminFiltradas()">
                <option value="">Todos</option>
                <option value="true">Activas</option>
                <option value="false">Inactivas</option>
              </select>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingClasesAdmin"><div class="spinner"></div><p>Cargando clases...</p></div>
        <div class="data-table" id="clasesAdminTable"></div>
      </div>

      <!-- UBICACIONES -->
      <div id="tab-ubicaciones-admin" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Ubicaciones</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearUbicacion()">+ Crear Nueva Ubicaci√≥n</button>
            <div class="filters">
              <input type="text" id="filtroUbicacionesTexto" placeholder="Buscar por nombre, distrito o ciudad" oninput="renderUbicacionesFiltradas()"/>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingUbicacionesAdmin"><div class="spinner"></div><p>Cargando ubicaciones...</p></div>
        <div class="data-table" id="ubicacionesAdminTable"></div>
      </div>

      <!-- PAGOS -->
      <div id="tab-pagos-admin" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Historial de Pagos</h2>
          <div class="section-actions">
            <div class="filters">
              <input type="text" id="filtroPagosTexto" placeholder="Buscar por usuario o transacci√≥n" oninput="renderPagosFiltrados()"/>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingPagosAdmin"><div class="spinner"></div><p>Cargando pagos...</p></div>
        <div class="data-table" id="pagosAdminTable"></div>
      </div>

      <!-- REPORTES -->
      <div id="tab-reportes" class="admin-content">
        <h2 class="section-title">Reportes y An√°lisis</h2>

        <div class="section-actions" style="display:flex; gap:1rem; margin-bottom:1rem; flex-wrap:wrap;">
          <button class="btn" onclick="descargarReportesExcel()">‚¨áÔ∏è Descargar reportes (Excel)</button>
          <button class="btn btn-secondary" onclick="descargarReportesPDF()">‚¨áÔ∏è Descargar reportes (PDF)</button>
        </div>

        <div class="chart-container">
          <h3>Reporte de Membres√≠as</h3>
          <div class="loading" id="loadingReporteMembresias"><div class="spinner"></div></div>
          <div id="reporteMembresiaContent"></div>
        </div>

        <div class="chart-container">
          <h3>Reporte de Ingresos</h3>
          <select id="periodoIngresos" onchange="cargarReporteIngresos()" class="select-dark">
            <option value="mensual">Mensual</option>
            <option value="anual">Anual</option>
          </select>
          <div class="loading" id="loadingReporteIngresos"><div class="spinner"></div></div>
          <div id="reporteIngresosContent"></div>
        </div>

        <div class="chart-container">
          <h3>Reporte de Clases (Ocupaci√≥n)</h3>
          <div class="loading" id="loadingReporteClases"><div class="spinner"></div></div>
          <div id="reporteClasesContent"></div>
        </div>

        <div class="chart-container">
          <h3>Evoluci√≥n Mensual de Suscripciones</h3>
          <canvas id="graficoSuscripciones"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== MODALES ===== -->
  <!-- Usuario -->
  <div id="modalUsuario" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="usuarioModalTitulo">Crear Usuario</h3><button class="close-modal" onclick="cerrarModal('modalUsuario')">&times;</button></div>
      <form id="formUsuario" onsubmit="guardarUsuario(event)">
        <input type="hidden" id="usuarioEditId"/>
        <div class="form-group"><label>Nombre Completo</label><input type="text" id="usuarioEditNombre" required/></div>
        <div class="form-group"><label>Correo</label><input type="email" id="usuarioEditCorreo" required/></div>
        <div class="form-group"><label>Tel√©fono</label><input type="tel" id="usuarioEditTelefono"/></div>
        <div class="form-group"><label>Rol</label>
          <select id="usuarioEditRol"><option value="USUARIO">Usuario</option><option value="ENTRENADOR">Entrenador</option><option value="ADMINISTRADOR">Administrador</option></select>
        </div>
        <div class="form-group"><label>Estado</label>
          <select id="usuarioEditActivo"><option value="true">Activo</option><option value="false">Inactivo</option></select>
        </div>
        <div class="form-group" id="usuarioPwdWrap"><label>Contrase√±a</label><input type="password" id="usuarioEditPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
        <button type="submit" class="btn" style="width:100%;">Guardar</button>
      </form>
    </div>
  </div>

  <!-- Membres√≠a -->
  <div id="modalMembresia" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Crear Membres√≠a (Presencial)</h3><button class="close-modal" onclick="cerrarModal('modalMembresia')">&times;</button></div>
      <form id="formMembresia" onsubmit="guardarMembresiaPresencial(event)">
        <div class="form-group"><label>ID Usuario</label><input type="number" id="membUsuarioId" required/></div>
        <div class="form-group"><label>Plan</label>
          <select id="membPlan"><option value="BASICO">B√°sico</option><option value="PREMIUM">Premium</option><option value="ANUAL">Anual</option></select>
        </div>
        <div class="form-group"><label>Renovaci√≥n Autom√°tica</label>
          <select id="membAuto"><option value="true">S√≠</option><option value="false">No</option></select>
        </div>
        <button type="submit" class="btn" style="width:100%;">Crear</button>
      </form>
    </div>
  </div>

  <!-- Clase -->
  <div id="modalClase" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="modalClaseTitle">Crear Nueva Clase</h3><button class="close-modal" onclick="cerrarModal('modalClase')">&times;</button></div>
      <form id="formClase" onsubmit="guardarClase(event)">
        <input type="hidden" id="claseId"/>
        <div class="form-group"><label>Nombre</label><input type="text" id="claseNombre" required/></div>
        <div class="form-group"><label>Descripci√≥n</label><textarea id="claseDescripcion" style="min-height:80px;"></textarea></div>
        <div class="form-group"><label>Horario</label><input type="text" id="claseHorario" required/></div>
        <div class="form-group"><label>Instructor</label><input type="text" id="claseInstructor" required/></div>
        <div class="form-group"><label>Capacidad</label><input type="number" id="claseCapacidad" required min="1"/></div>
        <div class="form-group"><label>Duraci√≥n (min)</label><input type="number" id="claseDuracion" required min="15"/></div>
        <button type="submit" class="btn" style="width:100%;">Guardar</button>
      </form>
    </div>
  </div>

  <!-- Ubicaci√≥n -->
  <div id="modalUbicacion" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="modalUbicacionTitle">Crear Nueva Ubicaci√≥n</h3><button class="close-modal" onclick="cerrarModal('modalUbicacion')">&times;</button></div>
      <form id="formUbicacion" onsubmit="guardarUbicacion(event)">
        <input type="hidden" id="ubicacionId"/>
        <div class="form-group"><label>Nombre</label><input type="text" id="ubicacionNombre" required/></div>
        <div class="form-group"><label>Direcci√≥n</label><input type="text" id="ubicacionDireccion" required/></div>
        <div class="form-group"><label>Distrito</label><input type="text" id="ubicacionDistrito" required/></div>
        <div class="form-group"><label>Ciudad</label><input type="text" id="ubicacionCiudad" required/></div>
        <div class="form-group"><label>Tel√©fono</label><input type="tel" id="ubicacionTelefono" required/></div>
        <div class="form-group"><label>Horario</label><input type="text" id="ubicacionHorario" required value="24/7"/></div>
        <div class="form-group"><label>Latitud</label><input type="number" step="0.0001" id="ubicacionLatitud"/></div>
        <div class="form-group"><label>Longitud</label><input type="number" step="0.0001" id="ubicacionLongitud"/></div>
        <button class="btn" style="width:100%;">Guardar</button>
      </form>
    </div>
  </div>

  <!-- =============== PERFIL (USUARIO) =============== -->
  <div id="perfil" class="page">
    <section class="auth-container">
      <div class="auth-form">
        <h2 class="section-title" style="text-align:center">Mi Perfil</h2>

        <div class="admin-tabs" role="tablist" style="margin-bottom:1rem">
          <button class="admin-tab active" data-perfil-tab="info" onclick="cambiarTabPerfil('info', this)">üë§ Informaci√≥n</button>
          <button class="admin-tab" data-perfil-tab="membresia" onclick="cambiarTabPerfil('membresia', this)">üí≥ Membres√≠a</button>
          <button class="admin-tab" data-perfil-tab="pagos" onclick="cambiarTabPerfil('pagos', this)">üí∞ Pagos</button>
          <button class="admin-tab" data-perfil-tab="clases" onclick="cambiarTabPerfil('clases', this)">üèãÔ∏è Clases</button>
          <button class="admin-tab" data-perfil-tab="preferencias" onclick="cambiarTabPerfil('preferencias', this)">üîî Preferencias</button>
        </div>

        <!-- Info Personal -->
        <div id="perfil-info" class="admin-content active">
          <form id="formPerfil" onsubmit="guardarPerfil(event)">
            <div class="form-group">
              <label>Nombre completo</label>
              <input id="perfilNombre" type="text" required />
            </div>
            <div class="form-group">
              <label>Correo electr√≥nico</label>
              <input id="perfilCorreo" type="email" readonly />
            </div>
            <div class="form-group">
              <label>Tel√©fono</label>
              <input id="perfilTelefono" type="text" placeholder="+51 9xx xxx xxx" />
            </div>
            <div class="form-group">
              <label>Rol</label>
              <input id="perfilRol" type="text" readonly />
            </div>
            <div class="form-group">
              <label>Fecha de registro</label>
              <input id="perfilFecha" type="text" readonly />
            </div>
            <div class="form-group">
              <button class="btn" type="submit">Guardar cambios</button>
              <button class="btn btn-secondary" type="button" onclick="abrirModalPassword()">Cambiar contrase√±a</button>
              <button class="btn btn-secondary" type="button" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
            </div>
          </form>
        </div>

        <!-- Membres√≠a -->
        <div id="perfil-membresia" class="admin-content">
          <div class="payment-summary" id="perfilMembresiaBox">
            <p>Cargando membres√≠a...</p>
          </div>
          <div>
            <button class="btn" id="btnActivarMembresia" style="display:none" onclick="activarMembresia()">Activar/Renovar</button>
            <button class="btn btn-secondary" id="btnCancelarMembresia" style="display:none" onclick="cancelarMembresiaUsuario()">Cancelar membres√≠a</button>
            <label style="margin-left:1rem">
              <input id="chkAutoRenov" type="checkbox" onchange="toggleAutoRenovacion(this)" />
              Renovaci√≥n autom√°tica
            </label>
          </div>
        </div>

        <!-- Pagos -->
        <div id="perfil-pagos" class="admin-content">
          <div class="section-top" style="margin-bottom:.5rem">
            <div class="filters">
              <input type="text" id="filtroPagosUsuario" placeholder="Buscar por transacci√≥n/fecha" oninput="renderPagosUsuario()" />
            </div>
            <div class="perfil-actions">
              <button class="btn btn-secondary" onclick="descargarPagosUsuarioPDF()">Descargar PDF</button>
              <button class="btn btn-secondary" onclick="descargarPagosUsuarioExcel()">Descargar Excel</button>
            </div>
          </div>
          <div class="data-table" id="tablaPagosUsuario"></div>
        </div>

        <!-- Clases -->
        <div id="perfil-clases" class="admin-content">
          <div class="filters" style="margin-bottom:.5rem">
            <select id="filtroClasesTipo" onchange="renderClasesUsuario()">
              <option value="proximas">Pr√≥ximas</option>
              <option value="pasadas">Pasadas</option>
              <option value="todas">Todas</option>
            </select>
          </div>
          <div class="data-table" id="tablaClasesUsuario"></div>
        </div>

        <!-- Preferencias -->
        <div id="perfil-preferencias" class="admin-content">
          <form id="formPreferencias" onsubmit="guardarPreferencias(event)">
            <div class="form-group">
              <label>
                <input type="checkbox" id="prefEmailNoti" />
                Recibir notificaciones por correo
              </label>
            </div>
            <div class="form-group">
              <label>Recordatorios de clases</label>
              <select id="prefRecordatorios">
                <option value="none">Sin recordatorios</option>
                <option value="24h">24 horas antes</option>
                <option value="2h">2 horas antes</option>
                <option value="30m">30 minutos antes</option>
              </select>
            </div>
            <button class="btn" type="submit">Guardar preferencias</button>
          </form>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal Cambiar Contrase√±a -->
  <div class="modal" id="modalPassword">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Cambiar contrase√±a</h3>
        <button class="close-modal" onclick="cerrarModal('modalPassword')">√ó</button>
      </div>
      <form id="formPassword" onsubmit="guardarPassword(event)">
        <div class="form-group">
          <label>Contrase√±a actual</label>
          <input id="pwdActual" type="password" required />
        </div>
        <div class="form-group">
          <label>Nueva contrase√±a</label>
          <input id="pwdNueva" type="password" minlength="6" required />
        </div>
        <div class="form-group">
          <label>Confirmar nueva contrase√±a</label>
          <input id="pwdNueva2" type="password" minlength="6" required />
        </div>
        <button class="btn" type="submit">Actualizar</button>
      </form>
    </div>
  </div>

<script>
/* ================== CONFIG / ENDPOINTS ================== */
const API_URL = 'http://localhost:8080/api';
const ENDPOINTS = {
  auth: {
    login: `${API_URL}/autenticacion/iniciar-sesion`,
    register: `${API_URL}/autenticacion/registrar`
  },
  usuarios: {
    me: `${API_URL}/usuarios/me`,
    update: (id) => `${API_URL}/admin/usuarios/${id}`,
    password: (id) => `${API_URL}/usuarios/${id}/contrasena`,
    prefs: (id) => `${API_URL}/usuarios/${id}/preferencias`
  },
  membresias: {
    crear: `${API_URL}/membresias`,
    porUsuario: (usuarioId) => `${API_URL}/membresias/usuario/${usuarioId}`,
    cancelar: (membresiaId) => `${API_URL}/membresias/${membresiaId}/cancelar`,
    update: (membresiaId) => `${API_URL}/membresias/${membresiaId}`
  },
  pagos: {
    crear: `${API_URL}/pagos`,
    porUsuario: (usuarioId) => `${API_URL}/pagos/usuario/${usuarioId}`
  },
  clases: {
    listar: `${API_URL}/clases`,
    inscribir: `${API_URL}/clases/inscribir`,
    porUsuario: (usuarioId) => `${API_URL}/clases/usuario/${usuarioId}`,
    cancelarInscripcion: (claseId) => `${API_URL}/clases/${claseId}/cancelar-inscripcion`
  },
  ubicaciones: {
    listar: `${API_URL}/ubicaciones`,
    porId: (id) => `${API_URL}/ubicaciones/${id}`
  },
  contacto: {
    enviar: `${API_URL}/contacto`,
    listar: `${API_URL}/contacto`
  },
  admin: {
    dashboard: `${API_URL}/admin/dashboard`,
    usuarios: `${API_URL}/admin/usuarios`,
    usuarioId: (id) => `${API_URL}/admin/usuarios/${id}`,
    clases: `${API_URL}/admin/clases`,
    claseId: (id) => `${API_URL}/admin/clases/${id}`,
    ubicaciones: `${API_URL}/admin/ubicaciones`,
    ubicacionId: (id) => `${API_URL}/admin/ubicaciones/${id}`,
    membresias: `${API_URL}/admin/membresias`,
    pagos: `${API_URL}/admin/pagos`,
    reporteMembresias: `${API_URL}/admin/reportes/membresias`,
    reporteClases: `${API_URL}/admin/reportes/clases`,
    reporteIngresos: (periodo = 'mensual') => `${API_URL}/admin/reportes/ingresos?periodo=${periodo}`,
    reporteSuscripciones: `${API_URL}/admin/reportes/suscripciones-mensuales`
  }
};

/* ================== HELPERS ================== */
const authHeaders = () => ({ 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` });

async function getJson(url, options = {}) {
  const headers = options.headers ? { ...options.headers } : {};
  headers['Accept'] = 'application/json';
  const res = await fetch(url, { ...options, headers });
  const text = await res.text();
  try { return { ok: res.ok, status: res.status, data: text ? JSON.parse(text) : null }; }
  catch { return { ok: res.ok, status: res.status, data: null }; }
}

async function sendJson(url, method, payload, extraHeaders = {}) {
  const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json', Accept: 'application/json', ...extraHeaders }, body: payload ? JSON.stringify(payload) : null });
  const text = await res.text();
  let data = null; try { data = text ? JSON.parse(text) : null; } catch {}
  return { ok: res.ok, status: res.status, data };
}

function safeUsuarioNombre(x) {
  return x.usuarioNombre
      || (x.usuario && x.usuario.nombreCompleto)
      || '‚Äî';
}

/* ================== ESTADO ================== */
let usuarioActual = null;
let planSeleccionado = null;
let precioSeleccionado = 0;

/* ================== INICIO ================== */
window.addEventListener('DOMContentLoaded', () => {
  verificarSesion();
  actualizarUIUsuario();
  cargarUbicaciones();
  cargarClases();
  // enmascarado inputs pago
  const numeroTarjeta = document.getElementById('numeroTarjeta');
  if (numeroTarjeta) numeroTarjeta.addEventListener('input', e => {
    let v = e.target.value.replace(/\s/g,'').replace(/\D/g,''); e.target.value = v.match(/.{1,4}/g)?.join(' ') || v;
  });
  const fechaExp = document.getElementById('fechaExpiracion');
  if (fechaExp) fechaExp.addEventListener('input', e => {
    let v = e.target.value.replace(/\D/g,''); if (v.length>=2) v = v.substring(0,2)+'/'+v.substring(2,4); e.target.value=v;
  });
});

/* ================== AUTH ================== */
function verificarSesion(){
  const u = localStorage.getItem('usuario');
  const t = localStorage.getItem('token');
  if (u && t){ usuarioActual = JSON.parse(u); }
}

function actualizarUIUsuario() {
  const isLogged = !!usuarioActual;
  const isAdmin = usuarioActual?.rol === 'ADMINISTRADOR';
  const isTrainer = usuarioActual?.rol === 'ENTRENADOR';

  document.getElementById('authLink').style.display = isLogged ? 'none' : 'block';
  document.getElementById('userInfo').classList.toggle('active', isLogged);
  document.getElementById('userName').textContent = isLogged ? (usuarioActual.nombreCompleto || '') : '';
  document.getElementById('perfilLink').style.display = isLogged ? 'block' : 'none';
  document.getElementById('adminLink').style.display = (isAdmin || isTrainer) ? 'block' : 'none';
}

async function manejarAutenticacion(event){
  event.preventDefault();
  const correoElectronico = document.getElementById('correoElectronico').value.trim();
  const contrasena = document.getElementById('contrasena').value;
  const btnAuth = document.getElementById('btnAuth');
  btnAuth.disabled=true; btnAuth.textContent='Procesando...';

  try{
    let url, body;
    if (document.getElementById('nameGroup').style.display==='none'){ // login
      url = ENDPOINTS.auth.login; body = { correoElectronico, contrasena };
    } else { // registro
      const nombreCompleto = document.getElementById('nombreCompleto').value.trim();
      let numeroTelefono = document.getElementById('numeroTelefono').value.trim();
      if (numeroTelefono){ numeroTelefono = numeroTelefono.replace(/[^\d+]/g,''); if(!numeroTelefono.startsWith('+')) numeroTelefono = '+51'+numeroTelefono; }
      else numeroTelefono=null;
      url = ENDPOINTS.auth.register; body = { nombreCompleto, correoElectronico, contrasena, numeroTelefono };
    }
    const { ok, data } = await sendJson(url,'POST',body);
    if (ok && data?.token){
      localStorage.setItem('token', data.token);
      localStorage.setItem('usuario', JSON.stringify({
        usuarioId: data.usuarioId,
        nombreCompleto: data.nombreCompleto,
        correoElectronico: data.correoElectronico,
        rol: data.rol || data.authority || (Array.isArray(data.roles)?data.roles[0]:'USUARIO')
      }));
      usuarioActual = JSON.parse(localStorage.getItem('usuario'));
      mostrarMensaje('¬°Bienvenido!','success');
      setTimeout(()=>{ actualizarUIUsuario(); showPage('home'); document.getElementById('authForm').reset(); }, 800);
    }else{
      mostrarMensaje((data && (data.mensaje||data.error)) || 'Error en la autenticaci√≥n','error');
    }
  }catch(e){ console.error(e); mostrarMensaje('Error de conexi√≥n','error'); }
  finally{ btnAuth.disabled=false; btnAuth.textContent='Continuar'; }
}

function cerrarSesion(){
  localStorage.removeItem('token'); localStorage.removeItem('usuario');
  usuarioActual=null; actualizarUIUsuario(); showPage('home'); mostrarMensaje('Sesi√≥n cerrada','success');
}

function cambiarModoAuth(e){
  e.preventDefault();
  const loginMode = document.getElementById('nameGroup').style.display==='none';
  document.getElementById('authTitle').textContent = loginMode?'Crear Cuenta':'Iniciar Sesi√≥n';
  document.getElementById('nameGroup').style.display = loginMode?'block':'none';
  document.getElementById('phoneGroup').style.display = loginMode?'block':'none';
  document.getElementById('toggleText').innerHTML = loginMode?'¬øYa tienes cuenta? <a href="#" onclick="cambiarModoAuth(event)">Inicia Sesi√≥n</a>':'¬øNo tienes cuenta? <a href="#" onclick="cambiarModoAuth(event)">Reg√≠strate</a>';
}

/* ================== MEMBRES√çA & PAGO ================== */
// Mapea tus planes a los price_id reales de Stripe
const STRIPE_PRICE_MAP = {
  BASICO:  "price_1SPSFOPSvkDPHeMDAYuIcbPx",   
  PREMIUM: "price_1SPSAzPSvkDPHeMDIsBqzLJl",  
  ANUAL:   "price_1SPSFvPSvkDPHeMDPibimNRW"     
};

async function seleccionarPlan(tipoPlan, precio) {
  if (!usuarioActual) {
    mostrarMensaje('Debes iniciar sesi√≥n', 'error');
    showPage('login');
    return;
  }

  const priceId = STRIPE_PRICE_MAP[tipoPlan];
  if (!priceId) {
    alert('No hay priceId configurado para ' + tipoPlan);
    return;
  }

  try {
    const { ok, data } = await sendJson(
      'http://localhost:8080/api/pagos/stripe/checkout',
      'POST',
      {
        priceId,
        usuarioId: usuarioActual.usuarioId,
        plan: tipoPlan
      },
      authHeaders()
    );

    if (!ok || !data?.sessionId) {
      alert(data?.mensaje || 'No se pudo crear la sesi√≥n de pago');
      return;
    }

    // 2) redirigimos a Stripe
    const stripe = Stripe("pk_test_51SMeZBPSvkDPHeMDqR5nrAh8d48Scc8v0F8BncEhJkLqjqGTf5O6hQcLOZFdCX0Xknl3sZbwG3JY9xJM1YfVaf2A009ksXOexP");
    await stripe.redirectToCheckout({ sessionId: data.sessionId });

  } catch (err) {
    console.error(err);
    alert('Error de conexi√≥n con Stripe');
  }
}


async function procesarPago(event){
  event.preventDefault();
  const btn = document.getElementById('btnPayment'); btn.disabled=true; btn.textContent='Procesando...';
  try{
    if (!usuarioActual?.usuarioId) throw new Error('Usuario no autenticado');
    if (!planSeleccionado || !precioSeleccionado) throw new Error('Plan inv√°lido');

    const { ok:okM, data:dM } = await sendJson(ENDPOINTS.membresias.crear,'POST',
      { tipoPlan: planSeleccionado, usuarioId: usuarioActual.usuarioId, renovacionAutomatica: true }, authHeaders());
    if (!okM || !dM?.id) throw new Error('No se pudo crear la membres√≠a');
    const membId = dM.id;

    const payloadPago = {
      membresiaId: membId, usuarioId: usuarioActual.usuarioId,
      nombreTarjeta: document.getElementById('nombreTarjeta').value.trim(),
      numeroTarjeta: document.getElementById('numeroTarjeta').value.replace(/\s/g,''),
      fechaExpiracion: document.getElementById('fechaExpiracion').value.trim(),
      cvv: document.getElementById('cvv').value.trim(), monto: precioSeleccionado
    };
    const { ok:okP, data:dP } = await sendJson(ENDPOINTS.pagos.crear,'POST',payloadPago,authHeaders());
    if (!okP){ await sendJson(ENDPOINTS.membresias.cancelar(membId),'PUT',null,authHeaders()); throw new Error(dP?.mensaje||dP?.error||'Pago rechazado'); }

    mostrarMensajeEnPagina('paymentSuccessMsg',`¬°Pago exitoso! ID Tx: ${dP?.idTransaccion||'‚Äî'}`,'success');
    setTimeout(()=>{ showPage('home'); document.querySelector('#payment form').reset(); planSeleccionado=null; precioSeleccionado=0; },1500);
  }catch(e){
    mostrarMensajeEnPagina('paymentErrorMsg', e.message, 'error');
  }finally{ btn.disabled=false; btn.textContent='Confirmar Pago'; }
}

/* ================== P√öBLICO: UBICACIONES Y CLASES ================== */
async function cargarUbicaciones() {
  const loading = document.getElementById('loadingLocations');
  const list = document.getElementById('locationsList');

  try {
    loading.classList.add('show');
    list.style.display = 'none';

    const response = await fetch(ENDPOINTS.ubicaciones.listar);
    if (!response.ok) throw new Error('Error al cargar ubicaciones');

    const data = await response.json();
    window._ubicacionesCache = data;

    // ===== CAMBIO: inicializa y pinta marcadores de forma segura para SPA
    if (!map) initMap();
    pintarMarcadores(window._ubicacionesCache || []);

    renderUbicacionesPublicas();

    loading.classList.remove('show');
    list.style.display = 'grid';
  } catch (error) {
    console.error('Error:', error);
    loading.innerHTML = '<p style="color:#ff4500; padding: 2rem; text-align: center;">Error al cargar las ubicaciones. Por favor, intenta de nuevo.</p>';
  }
}
function actualizarMapa(ubicacion) {
  // (mantengo tu funci√≥n si la usas en otro lado)
}

function renderUbicacionesPublicas(){
  const list = document.getElementById('locationsList');
  const q = (document.getElementById('filtroPublicUbicacionesTexto')?.value || '').toLowerCase();
  const arr = (window._ubicacionesCache || []).filter(u =>
    `${u.distrito || ''} ${u.ciudad || ''} ${u.nombreUbicacion || ''}`.toLowerCase().includes(q)
  );

  list.innerHTML = arr.length ? arr.map((u, index) => `
    <div class="location-card ${selectedLocationIndex === index ? 'selected' : ''}" onclick="seleccionarUbicacion(${index})">
      <h3>SmartFit ${u.nombreUbicacion}</h3>
      <p><strong>üìç Direcci√≥n:</strong> ${u.direccion}</p>
      <p><strong>üèôÔ∏è Distrito:</strong> ${u.distrito}</p>
      <p><strong>‚è∞ Horario:</strong> ${u.horario}</p>
      <p><strong>üìû Tel√©fono:</strong> ${u.numeroTelefono}</p>
      <button class="btn-view-location" type="button">VER DETALLES</button>
    </div>
  `).join('') : '<p style="color:#ff4500; text-align:center; padding: 2rem; grid-column: 1/-1;">No hay ubicaciones disponibles</p>';
}

async function cargarClases(){
  const loading=document.getElementById('loadingClasses'); const list=document.getElementById('classesList');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.clases.listar);
    window._clasesCache = Array.isArray(data)?data:[];
    renderClasesPublicas();
  }catch{ list.innerHTML='<p style="color:#ff4500; text-align:center;">Error al cargar clases.</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderClasesPublicas(){
  const list = document.getElementById('classesList');
  const q = (document.getElementById('filtroPublicClasesTexto')?.value || '').toLowerCase();
  const arr = (window._clasesCache || []).filter(c =>
    `${c.nombreClase||''} ${c.nombreInstructor||''}`.toLowerCase().includes(q)
  );

  list.innerHTML = arr.length ? arr.map(c => {
    const inscritos = (typeof c.usuariosInscritos === 'number')
      ? c.usuariosInscritos
      : (Array.isArray(c.usuariosInscritos) ? c.usuariosInscritos.length : (c.inscritos||0));

    const cap = Number(c.capacidadMaxima || 0);
    const cupos = Math.max(cap - inscritos, 0);
    const llena = cap > 0 && inscritos >= cap;

    // üëá horario se muestra como string (tal cual viene del backend)
    const horarioStr = (typeof c.horario === 'string' && c.horario.trim())
      ? c.horario
      : (c.horario ? String(c.horario) : '‚Äî');

    return `
      <div class="class-card">
        <h3>${c.nombreClase || '‚Äî'}</h3>
        <p>${c.descripcion || ''}</p>
        <p style="margin:1rem 0;"><strong>üìÖ ${horarioStr}</strong></p>
        <p><strong>üë®‚Äçüè´ Instructor:</strong> ${c.nombreInstructor || '‚Äî'}</p>
        <p class="spots">
          üéØ Cupos: <span class="cupos" id="cupos-${c.id}">${cupos}</span>/${cap || '‚Äî'}
          ${llena ? '<span class="badge badge-warning" style="margin-left:.5rem;">Completa</span>' : ''}
        </p>
        <button class="btn" id="btn-insc-${c.id}" onclick="inscribirseEnClase(${c.id})" ${llena?'disabled':''}>
          Inscribirme
        </button>
      </div>`;
  }).join('') : '<p style="color:#ff4500; text-align:center;">No hay clases</p>';
}


async function inscribirseEnClase(claseId){
  if (!usuarioActual){ mostrarMensaje('Debes iniciar sesi√≥n','error'); showPage('login'); return; }
  const btn = document.getElementById(`btn-insc-${claseId}`);
  try{
    btn && (btn.disabled = true);

    const payload = { usuarioId: usuarioActual.usuarioId, claseId };
    const r = await fetch(ENDPOINTS.clases.inscribir, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', Accept:'application/json', ...authHeaders() },
      body: JSON.stringify(payload)
    });
    const contentType = r.headers.get('content-type');
    const data = contentType?.includes('json') ? await r.json() : await r.text();

    if (!r.ok) throw new Error(typeof data === 'string' ? data : (data?.mensaje || 'No se pudo inscribir'));

    // ‚úÖ Decremento optimista en DOM
    const span = document.getElementById(`cupos-${claseId}`);
    if (span){
      const nuevo = Math.max(0, (parseInt(span.textContent||'0',10) - 1));
      span.textContent = String(nuevo);
      if (nuevo === 0 && btn){
        btn.disabled = true;
        btn.title = 'Clase completa';
      }
    }

    // ‚úÖ Actualiza cache local (si la usas)
    const i = (window._clasesCache||[]).findIndex(c=>Number(c.id)===Number(claseId));
    if (i >= 0){
      const c = window._clasesCache[i];
      if (typeof c.usuariosInscritos === 'number') c.usuariosInscritos = Math.max(0, c.usuariosInscritos + 1);
      else if (Array.isArray(c.usuariosInscritos)) c.usuariosInscritos.push({ id: usuarioActual.usuarioId });
      else c.inscritos = (c.inscritos||0) + 1;
    }

    alert(`‚úÖ ${typeof data==='string' ? data : (data?.mensaje || 'Inscripci√≥n exitosa')}`);

    // üîÑ Pull r√°pido para sincronizar valores reales desde el backend
    // (por si alguien m√°s se inscribi√≥ justo antes)
    try{
      const { ok, data:lista } = await getJson(ENDPOINTS.clases.listar);
      if (ok && Array.isArray(lista)){
        window._clasesCache = lista;
        // solo refrescamos los spans de cupos para no repintar todo
        lista.forEach(c=>{
          const inscritos = (typeof c.usuariosInscritos === 'number')
            ? c.usuariosInscritos
            : (Array.isArray(c.usuariosInscritos) ? c.usuariosInscritos.length : (c.inscritos||0));
          const cap = Number(c.capacidadMaxima||0);
          const cupos = Math.max(cap - inscritos, 0);
          const s = document.getElementById(`cupos-${c.id}`);
          const b = document.getElementById(`btn-insc-${c.id}`);
          if (s){ s.textContent = String(cupos); }
          if (b){ b.disabled = (cupos<=0); }
        });
      }
    }catch{}
  }catch(e){
    alert('‚ùå ' + e.message);
  }finally{
    // si qued√≥ con cupos, habilita de nuevo
    const span = document.getElementById(`cupos-${claseId}`);
    if (btn && span && parseInt(span.textContent||'0',10) > 0) btn.disabled = false;
  }
}

let _pollClases = null;

function iniciarPollingCupos(){
  if (_pollClases) return;
  _pollClases = setInterval(async () => {
    const visible = document.getElementById('classes')?.classList.contains('active');
    if (!visible) return;
    const { ok, data } = await getJson(ENDPOINTS.clases.listar);
    if (!ok || !Array.isArray(data)) return;

    window._clasesCache = data;
    data.forEach(c=>{
      const inscritos = (typeof c.usuariosInscritos === 'number')
        ? c.usuariosInscritos
        : (Array.isArray(c.usuariosInscritos) ? c.usuariosInscritos.length : (c.inscritos||0));
      const cap = Number(c.capacidadMaxima||0);
      const cupos = Math.max(cap - inscritos, 0);
      const s = document.getElementById(`cupos-${c.id}`);
      const b = document.getElementById(`btn-insc-${c.id}`);
      if (s) s.textContent = String(cupos);
      if (b) b.disabled = (cupos<=0);
    });
  }, 15000); // 15s
}

window.addEventListener('DOMContentLoaded', iniciarPollingCupos);

/* ================== CONTACTO ================== */
async function enviarMensajeContacto(event){
  event.preventDefault();
  const btn=document.getElementById('btnContact'); btn.disabled=true; btn.textContent='Enviando...';
  try{
    const payload={ nombreRemitente:contactNombre.value, correoRemitente:contactEmail.value, asunto:contactAsunto.value, mensaje:contactMensaje.value };
    const { ok, data } = await sendJson(ENDPOINTS.contacto.enviar,'POST',payload);
    if (ok){ mostrarMensajeEnPagina('contactSuccessMsg', typeof data==='string'?data:'Mensaje enviado','success'); document.querySelector('#contact form').reset(); }
    else { mostrarMensajeEnPagina('contactErrorMsg', data?.mensaje||data?.error||'Error','error'); }
  }catch{ mostrarMensajeEnPagina('contactErrorMsg','Error de conexi√≥n','error'); }
  finally{ btn.disabled=false; btn.textContent='Enviar Mensaje'; }
}

/* ================== NAV/UI helpers ================== */
function showPage(pageId) {
  if (pageId === 'admin') {
    if (!usuarioActual) {
      alert('Acceso denegado.');
      pageId = 'home';
    } else {
      const rol = usuarioActual.rol;
      const isAdmin = rol === 'ADMINISTRADOR';
      const isTrainer = rol === 'ENTRENADOR';

      if (!(isAdmin || isTrainer)) {
        alert('Acceso denegado.');
        pageId = 'home';
      } else {
        configurarTabsAdminPorRol(rol);
        if (isTrainer) {
          cambiarTabAdmin('clases-admin', document.querySelector('.admin-tab[data-tab="clases-admin"]'));
        } else {
          cambiarTabAdmin('dashboard', document.querySelector('.admin-tab[data-tab="dashboard"]'));
        }
      }
    }
  }

  if (pageId === 'perfil') {
    if (!usuarioActual) {
      alert('Debes iniciar sesi√≥n');
      pageId = 'login';
    } else {
      irPerfil();
    }
  }

  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.getElementById('navLinks').classList.remove('active');
  window.scrollTo(0,0);

  // ===== CAMBIO: l√≥gica SPA para mapa al entrar a Ubicaciones
  if (pageId === 'locations') {
    if (!map) initMap();
    // Revalida tama√±o y centra si ya hay marcadores
    setTimeout(() => {
      try {
        map.invalidateSize();
        if (markers.length) {
          const g = L.featureGroup(markers);
          map.fitBounds(g.getBounds().pad(0.1));
        }
      } catch {}
    }, 80);
  } else if (pageId === 'classes') {
    cargarClases();
  } else if (pageId === 'admin') {
    cargarDashboard();
  }
}

function configurarTabsAdminPorRol(rol) {
  const isAdmin = rol === 'ADMINISTRADOR';
  const isTrainer = rol === 'ENTRENADOR';

  const tabs = [
    { key:'dashboard',        sel:'[data-tab="dashboard"]' },
    { key:'usuarios',         sel:'[data-tab="usuarios"]' },
    { key:'membresias',       sel:'[data-tab="membresias"]' },
    { key:'clases-admin',     sel:'[data-tab="clases-admin"]' },
    { key:'ubicaciones-admin',sel:'[data-tab="ubicaciones-admin"]' },
    { key:'pagos-admin',      sel:'[data-tab="pagos-admin"]' },
    { key:'reportes',         sel:'[data-tab="reportes"]' }
  ];

  tabs.forEach(t => {
    const btn = document.querySelector(t.sel);
    const pane = document.getElementById(`tab-${t.key}`);
    if (!btn || !pane) return;

    if (isAdmin) {
      btn.style.display = '';
      pane.style.display = '';
    } else if (isTrainer) {
      const allowed = (t.key === 'clases-admin');
      btn.style.display = allowed ? '' : 'none';
      pane.style.display = allowed ? '' : 'none';
      if (!allowed) pane.classList.remove('active');
    }
  });

  const isTrainerOnly = isTrainer;
  document.querySelectorAll('.btn-create, .btn-edit, .btn-delete').forEach(b=>{
    if (isTrainerOnly) b.style.display = 'none';
  });
}

function toggleMobileMenu(){ document.getElementById('navLinks').classList.toggle('active'); }
function mostrarMensaje(msg,tipo){
  const s=document.getElementById('successMsg'); const e=document.getElementById('errorMsg');
  if (tipo==='success'){ s.textContent=msg; s.classList.add('show'); e.classList.remove('show'); setTimeout(()=>s.classList.remove('show'),2500); }
  else { e.textContent=msg; e.classList.add('show'); s.classList.remove('show'); setTimeout(()=>e.classList.remove('show'),4000); }
}
function mostrarMensajeEnPagina(id,msg,tipo){
  const el=document.getElementById(id); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), tipo==='success'?2500:4000);
}

/* ================== ADMIN: Tabs y permisos ================== */
function cambiarTabAdmin(tab, elBtn){
  const rol = usuarioActual?.rol;
  const isAdmin = rol === 'ADMINISTRADOR';
  const isTrainer = rol === 'ENTRENADOR';

  if (isTrainer && tab !== 'clases-admin') {
    alert('Tu rol solo permite ver Clases.');
    return;
  }

  document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.admin-content').forEach(c=>c.classList.remove('active'));
  if (elBtn) elBtn.classList.add('active');
  const area = document.getElementById(`tab-${tab}`);
  if (area) area.classList.add('active');

  switch(tab){
    case 'dashboard': if(isAdmin) cargarDashboard(); break;
    case 'usuarios':  if(isAdmin) cargarUsuariosAdmin(); break;
    case 'membresias':if(isAdmin) cargarMembresiasAdmin(); break;
    case 'clases-admin': cargarClasesAdmin(); break;
    case 'ubicaciones-admin': if(isAdmin) cargarUbicacionesAdmin(); break;
    case 'pagos-admin': if(isAdmin) cargarPagosAdmin(); break;
    case 'reportes': if(isAdmin) cargarReportes(); break;
  }
}

/* ================== ADMIN: Dashboard ================== */
async function cargarDashboard(){
  const loading=document.getElementById('loadingDashboard'); const container=document.getElementById('dashboardStats');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.admin.dashboard, { headers:{...authHeaders()} });
    if (ok && data){
      container.innerHTML = `
        <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value">${data.totalUsuarios}</div><div class="stat-label">Total Usuarios</div><div style="color:#28a745; margin-top:.5rem;">‚úì ${data.usuariosActivos} activos</div></div>
        <div class="stat-card"><div class="stat-icon">üí≥</div><div class="stat-value">${data.totalMembresias}</div><div class="stat-label">Total Membres√≠as</div><div style="color:#28a745; margin-top:.5rem;">‚úì ${data.membresiasActivas} activas</div></div>
        <div class="stat-card"><div class="stat-icon">üèãÔ∏è</div><div class="stat-value">${data.totalClases}</div><div class="stat-label">Clases Disponibles</div></div>
        <div class="stat-card"><div class="stat-icon">üìç</div><div class="stat-value">${data.totalUbicaciones}</div><div class="stat-label">Ubicaciones</div></div>
        <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-value">${Number(data.ingresosMensuales||0).toFixed(2)}</div><div class="stat-label">Ingresos Mensuales</div></div>
        <div class="stat-card"><div class="stat-icon">üíµ</div><div class="stat-value">${Number(data.ingresosAnuales||0).toFixed(2)}</div><div class="stat-label">Ingresos Anuales</div></div>
      `;
    } else { container.innerHTML = '<p style="color:#dc3545;">Error al cargar estad√≠sticas</p>'; }
  }catch(e){ container.innerHTML = '<p style="color:#dc3545;">Error al cargar estad√≠sticas</p>'; }
  finally{ loading.classList.remove('show'); }
}

/* ================== ADMIN: Usuarios ================== */
function abrirModalCrearUsuario(){
  document.getElementById('usuarioModalTitulo').textContent='Crear Usuario';
  document.getElementById('formUsuario').reset();
  document.getElementById('usuarioEditId').value='';
  document.getElementById('usuarioPwdWrap').style.display='block';
  abrirModal('modalUsuario');
}
function editarUsuario(id, nombre, correo, telefono, rol, activo){
  document.getElementById('usuarioModalTitulo').textContent='Editar Usuario';
  document.getElementById('usuarioEditId').value=id;
  document.getElementById('usuarioEditNombre').value=nombre||'';
  document.getElementById('usuarioEditCorreo').value=correo||'';
  document.getElementById('usuarioEditTelefono').value=telefono||'';
  document.getElementById('usuarioEditRol').value=rol||'USUARIO';
  document.getElementById('usuarioEditActivo').value=String(!!activo);
  document.getElementById('usuarioPwdWrap').style.display='none';
  abrirModal('modalUsuario');
}
async function guardarUsuario(e){
  e.preventDefault();
  const id=document.getElementById('usuarioEditId').value;
  const payload={
    nombreCompleto: usuarioEditNombre.value,
    correoElectronico: usuarioEditCorreo.value,
    numeroTelefono: usuarioEditTelefono.value || null,
    rol: usuarioEditRol.value,
    estaActivo: usuarioEditActivo.value==='true'
  };
  if (!id && usuarioEditPwd.value) payload.contrasena = usuarioEditPwd.value;
  const url = id? ENDPOINTS.admin.usuarioId(id): ENDPOINTS.admin.usuarios;
  const method = id? 'PUT':'POST';
  try{ const { ok } = await sendJson(url,method,payload,authHeaders()); if (ok){ cerrarModal('modalUsuario'); cargarUsuariosAdmin(); } else alert('No se pudo guardar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function eliminarUsuario(id){
  if(!confirm('¬øEliminar usuario?')) return;
  try{ const { ok } = await sendJson(ENDPOINTS.admin.usuarioId(id),'DELETE',null,authHeaders()); if (ok) cargarUsuariosAdmin(); else alert('No se pudo eliminar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function cargarUsuariosAdmin(){
  const loading=document.getElementById('loadingUsuarios'); const container=document.getElementById('usuariosTable');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.admin.usuarios, { headers:{...authHeaders()} });
    window._usuariosCache = Array.isArray(data)?data:[];
    renderUsuariosFiltrados();
  }catch{ container.innerHTML='<p style="color:#dc3545;">Error al cargar usuarios</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderUsuariosFiltrados(){
  const container=document.getElementById('usuariosTable');
  const q=(document.getElementById('filtroUsuariosTexto')?.value||'').toLowerCase();
  const r=document.getElementById('filtroUsuariosRol')?.value||'';
  const e=document.getElementById('filtroUsuariosEstado')?.value||'';
  const arr=(window._usuariosCache||[]).filter(u=>{
    const txt=`${u.nombreCompleto||''} ${u.correoElectronico||''}`.toLowerCase().includes(q);
    const rol=!r || (u.rol===r);
    const est=!e || (String(!!u.estaActivo)===e);
    return txt && rol && est;
  });
  container.innerHTML = `
    <table>
      <thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Tel√©fono</th><th>Rol</th><th>Estado</th><th>Fecha</th><th>Acciones</th></tr></thead>
      <tbody>
        ${arr.map(u=>`
          <tr>
            <td>${u.id}</td>
            <td>${u.nombreCompleto}</td>
            <td>${u.correoElectronico}</td>
            <td>${u.numeroTelefono||'‚Äî'}</td>
            <td><span class="badge badge-info">${u.rol}</span></td>
            <td><span class="badge ${u.estaActivo?'badge-success':'badge-danger'}">${u.estaActivo?'Activo':'Inactivo'}</span></td>
            <td>${u.fechaCreacion? new Date(u.fechaCreacion).toLocaleDateString():'‚Äî'}</td>
            <td>
              <button class="action-btn btn-edit" onclick="editarUsuario(${u.id}, '${(u.nombreCompleto||'').replace(/'/g,"\\'")}', '${u.correoElectronico||''}', '${u.numeroTelefono||''}', '${u.rol}', ${!!u.estaActivo})">Editar</button>
              <button class="action-btn btn-delete" onclick="eliminarUsuario(${u.id})">Eliminar</button>
            </td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

/* ================== ADMIN: Membres√≠as ================== */
function abrirModalCrearMembresia(){ document.getElementById('formMembresia').reset(); abrirModal('modalMembresia'); }
async function guardarMembresiaPresencial(e){
  e.preventDefault();
  const payload={ usuarioId: Number(document.getElementById('membUsuarioId').value), tipoPlan: document.getElementById('membPlan').value, renovacionAutomatica: document.getElementById('membAuto').value==='true' };
  try{
    const { ok, data } = await sendJson(ENDPOINTS.membresias.crear,'POST',payload,authHeaders());
    if (ok){ cerrarModal('modalMembresia'); cargarMembresiasAdmin(); mostrarMensaje('Membres√≠a creada','success'); }
    else alert(data?.mensaje||data?.error||'No se pudo crear');
  }catch{ alert('Error de conexi√≥n'); }
}
async function cancelarMembresia(id){
  if(!confirm('¬øCancelar membres√≠a?')) return;
  try{
    const { ok } = await sendJson(ENDPOINTS.membresias.cancelar(id),'PUT',null,authHeaders());
    if (ok){ cargarMembresiasAdmin(); } else alert('No se pudo cancelar');
  }catch{ alert('Error de conexi√≥n'); }
}
async function cargarMembresiasAdmin(){
  const loading=document.getElementById('loadingMembresias'); const container=document.getElementById('membresiasTable');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.admin.membresias, { headers:{...authHeaders()} });
    window._membresiasCache = Array.isArray(data)?data:[];
    renderMembresiasFiltradas();
  }catch{ container.innerHTML='<p style="color:#dc3545;">Error al cargar membres√≠as</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderMembresiasFiltradas(){
  const container=document.getElementById('membresiasTable');
  const q=(document.getElementById('filtroMembresiasTexto')?.value||'').toLowerCase();
  const estado=document.getElementById('filtroMembresiasEstado')?.value||'';
  const plan=document.getElementById('filtroMembresiasPlan')?.value||'';
  const arr=(window._membresiasCache||[]).filter(m=>{
    const usuario = (m.usuario?.nombreCompleto||'').toLowerCase();
    const matchesTxt = `${usuario} ${m.tipoPlan||''}`.toLowerCase().includes(q);
    const matchesEstado = !estado || m.estado===estado;
    const matchesPlan = !plan || m.tipoPlan===plan;
    return matchesTxt && matchesEstado && matchesPlan;
  });
  container.innerHTML = `
    <table>
      <thead><tr><th>ID</th><th>Usuario</th><th>Plan</th><th>Precio</th><th>Inicio</th><th>Fin</th><th>Estado</th><th>Auto-Renov</th><th>Acciones</th></tr></thead>
      <tbody>
        ${arr.map(m=>`
          <tr>
            <td>${m.id}</td>
            <td>${safeUsuarioNombre(m)}<br><small>ID: ${m.usuarioId ?? '‚Äî'}</small></td>
            <td><span class="badge badge-info">${m.tipoPlan}</span></td>
            <td>${m.precio ?? '‚Äî'}</td>
            <td>${m.fechaInicio? new Date(m.fechaInicio).toLocaleDateString() : '‚Äî'}</td>
            <td>${m.fechaFin? new Date(m.fechaFin).toLocaleDateString() : '‚Äî'}</td>
            <td><span class="badge ${m.estado==='ACTIVO'?'badge-success':'badge-warning'}">${m.estado}</span></td>
            <td>${m.renovacionAutomatica ? '‚úì' : '‚Äî'}</td>
            <td>${m.estado==='ACTIVO' ? `<button class="action-btn btn-delete" onclick="cancelarMembresia(${m.id})">Cancelar</button>` : '‚Äî'}</td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

/* ================== ADMIN: Clases ================== */
function abrirModalCrearClase(){
  document.getElementById('modalClaseTitle').textContent='Crear Nueva Clase';
  document.getElementById('formClase').reset();
  document.getElementById('claseId').value='';
  abrirModal('modalClase');
}
function editarClase(c){
  document.getElementById('modalClaseTitle').textContent='Editar Clase';
  document.getElementById('claseId').value=c.id||'';
  claseNombre.value=c.nombreClase||''; claseDescripcion.value=c.descripcion||''; claseHorario.value=c.horario||'';
  claseInstructor.value=c.nombreInstructor||''; claseCapacidad.value=c.capacidadMaxima||1; claseDuracion.value=c.duracionMinutos||60;
  abrirModal('modalClase');
}
async function guardarClase(e){
  e.preventDefault();
  const id=claseId.value;
  const payload={ nombreClase:claseNombre.value, descripcion:claseDescripcion.value, horario:claseHorario.value, nombreInstructor:claseInstructor.value, capacidadMaxima:Number(claseCapacidad.value), duracionMinutos:Number(claseDuracion.value), estaActivo:true };
  const url = id? ENDPOINTS.admin.claseId(id): ENDPOINTS.admin.clases; const method=id?'PUT':'POST';
  try{ const { ok } = await sendJson(url,method,payload,authHeaders()); if(ok){ cerrarModal('modalClase'); cargarClasesAdmin(); } else alert('No se pudo guardar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function eliminarClase(id){
  if(!confirm('¬øEliminar clase?')) return;
  try{ const { ok } = await sendJson(ENDPOINTS.admin.claseId(id),'DELETE',null,authHeaders()); if(ok) cargarClasesAdmin(); else alert('No se pudo eliminar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function cargarClasesAdmin(){
  const loading=document.getElementById('loadingClasesAdmin'); const container=document.getElementById('clasesAdminTable');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.clases.listar);
    window._clasesAdminCache = Array.isArray(data)?data:[];
    renderClasesAdminFiltradas();
  }catch{ container.innerHTML='<p style="color:#dc3545;">Error al cargar clases</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderClasesAdminFiltradas(){
  const container=document.getElementById('clasesAdminTable');
  const q=(document.getElementById('filtroClasesTexto')?.value||'').toLowerCase();
  const est=(document.getElementById('filtroClasesEstado')?.value||'');
  const arr=(window._clasesAdminCache||[]).filter(c=>{
    const txt=`${c.nombreClase||''} ${c.nombreInstructor||''}`.toLowerCase().includes(q);
    const estado=!est || String(!!c.estaActivo)===est;
    return txt && estado;
  });
  container.innerHTML=`
    <table>
      <thead><tr><th>ID</th><th>Nombre</th><th>Instructor</th><th>Horario</th><th>Capacidad</th><th>Inscritos</th><th>Duraci√≥n</th><th>Estado</th><th>Acciones</th></tr></thead>
      <tbody>
        ${arr.map(c=>`
          <tr>
            <td>${c.id}</td><td>${c.nombreClase}</td><td>${c.nombreInstructor}</td><td>${c.horario}</td>
            <td>${c.capacidadMaxima}</td><td>${Array.isArray(c.usuariosInscritos)?c.usuariosInscritos.length:(c.inscritos||0)}</td>
            <td>${c.duracionMinutos} min</td>
            <td><span class="badge ${c.estaActivo ? 'badge-success':'badge-danger'}">${c.estaActivo?'Activo':'Inactivo'}</span></td>
            <td>
              <button class="action-btn btn-edit" onclick='editarClase(${JSON.stringify(c).replace(/'/g,"&apos;")})'>Editar</button>
              <button class="action-btn btn-delete" onclick="eliminarClase(${c.id})">Eliminar</button>
            </td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

/* ================== ADMIN: Ubicaciones ================== */
function abrirModalCrearUbicacion() {
  const rol = (usuarioActual?.rol)||'USUARIO';
  if (rol !== 'ADMINISTRADOR') {
    alert('Solo un administrador puede crear ubicaciones.');
    return;
  }
  const form = document.getElementById('formUbicacion');
  if (form) form.reset();
  document.getElementById('ubicacionId').value = '';
  document.getElementById('modalUbicacionTitle').textContent = 'Crear Nueva Ubicaci√≥n';
  abrirModal('modalUbicacion');
}
window.abrirModalCrearUbicacion = abrirModalCrearUbicacion;

function editarUbicacion(u){
  document.getElementById('modalUbicacionTitle').textContent='Editar Ubicaci√≥n';
  ubicacionId.value=u.id||''; ubicacionNombre.value=u.nombreUbicacion||''; ubicacionDireccion.value=u.direccion||'';
  ubicacionDistrito.value=u.distrito||''; ubicacionCiudad.value=u.ciudad||''; ubicacionTelefono.value=u.numeroTelefono||'';
  ubicacionHorario.value=u.horario||'24/7'; ubicacionLatitud.value=u.latitud||''; ubicacionLongitud.value=u.longitud||'';
  abrirModal('modalUbicacion');
}
async function guardarUbicacion(e){
  e.preventDefault();
  const id=ubicacionId.value;
  const payload={ nombreUbicacion:ubicacionNombre.value, direccion:ubicacionDireccion.value, distrito:ubicacionDistrito.value, ciudad:ubicacionCiudad.value, numeroTelefono:ubicacionTelefono.value, horario:ubicacionHorario.value, latitud:parseFloat(ubicacionLatitud.value||0), longitud:parseFloat(ubicacionLongitud.value||0) };
  const url=id? ENDPOINTS.admin.ubicacionId(id): ENDPOINTS.admin.ubicaciones; const method=id?'PUT':'POST';
  try{ const { ok } = await sendJson(url,method,payload,authHeaders()); if(ok){ cerrarModal('modalUbicacion'); cargarUbicacionesAdmin(); } else alert('No se pudo guardar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function eliminarUbicacion(id){
  if(!confirm('¬øEliminar ubicaci√≥n?')) return;
  try{ const { ok } = await sendJson(ENDPOINTS.admin.ubicacionId(id),'DELETE',null,authHeaders()); if(ok) cargarUbicacionesAdmin(); else alert('No se pudo eliminar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function cargarUbicacionesAdmin(){
  const loading=document.getElementById('loadingUbicacionesAdmin'); const container=document.getElementById('ubicacionesAdminTable');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.ubicaciones.listar);
    window._ubicacionesAdminCache = Array.isArray(data)?data:[];
    renderUbicacionesFiltradas();
  }catch{ container.innerHTML='<p style="color:#dc3545;">Error al cargar ubicaciones</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderUbicacionesFiltradas(){
  const container=document.getElementById('ubicacionesAdminTable');
  const q=(document.getElementById('filtroUbicacionesTexto')?.value||'').toLowerCase();
  const arr=(window._ubicacionesAdminCache||[]).filter(u=>{
    return `${u.nombreUbicacion||''} ${u.distrito||''} ${u.ciudad||''}`.toLowerCase().includes(q);
  });
  container.innerHTML=`
    <table>
      <thead><tr><th>ID</th><th>Nombre</th><th>Direcci√≥n</th><th>Distrito</th><th>Ciudad</th><th>Tel√©fono</th><th>Horario</th><th>Acciones</th></tr></thead>
      <tbody>
        ${arr.map(u=>`
          <tr>
            <td>${u.id}</td><td>${u.nombreUbicacion}</td><td>${u.direccion}</td><td>${u.distrito}</td>
            <td>${u.ciudad||'‚Äî'}</td><td>${u.numeroTelefono}</td><td>${u.horario}</td>
            <td>
              <button class="action-btn btn-edit" onclick='editarUbicacion(${JSON.stringify(u).replace(/'/g,"&apos;")})'>Editar</button>
              <button class="action-btn btn-delete" onclick="eliminarUbicacion(${u.id})">Eliminar</button>
            </td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

/* ================== ADMIN: Pagos ================== */
async function cargarPagosAdmin() {
  const loading = document.getElementById('loadingPagosAdmin');
  const container = document.getElementById('pagosAdminTable');
  loading.classList.add('show');
  try {
    const { ok, data } = await getJson(ENDPOINTS.admin.pagos, { headers: { ...authHeaders() } });
    window._pagosCache = ok && Array.isArray(data) ? data : [];
    renderPagosFiltrados();
  } catch (e) {
    console.error(e);
    container.innerHTML = '<p style="color:#dc3545;">Error al cargar pagos</p>';
  } finally {
    loading.classList.remove('show');
  }
}
function renderPagosFiltrados() {
  const container = document.getElementById('pagosAdminTable');
  const q = (document.getElementById('filtroPagosTexto')?.value || '').toLowerCase();
  const arr = (window._pagosCache || []).filter(p => {
    const usuarioTxt = (safeUsuarioNombre(p) + ' ' + (p.usuarioId ?? '')).toLowerCase();
    const idTx = (p.idTransaccion || '').toLowerCase();
    return usuarioTxt.includes(q) || idTx.includes(q);
  });
  container.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Membres√≠a</th>
          <th>Monto</th>
          <th>Fecha</th>
          <th>Transacci√≥n</th>
          <th>M√©todo</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        ${arr.map(p => `
          <tr>
            <td>${p.id}</td>
            <td>${safeUsuarioNombre(p)}<br><small>ID: ${p.usuarioId ?? '‚Äî'}</small></td>
            <td>${p.membresiaId ?? '‚Äî'}</td>
            <td>S/${Number(p.monto || 0).toFixed(2)}</td>
            <td>${p.fechaPago ? new Date(p.fechaPago).toLocaleString() : '‚Äî'}</td>
            <td>${p.idTransaccion || '‚Äî'}</td>
            <td>${p.metodoPago || '‚Äî'}</td>
            <td><span class="badge ${p.estadoPago==='COMPLETADO' ? 'badge-success' : 'badge-warning'}">${p.estadoPago || '‚Äî'}</span></td>
          </tr>
        `).join('')}
      </tbody>
    </table>`;
}

/* ================== ADMIN: Reportes ================== */
function cargarReportes() {
  const rol = usuarioActual?.rol;
  if (rol !== 'ADMINISTRADOR') {
    const container = document.getElementById('tab-reportes');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:3rem;">
          <h2 style="color:#ff4500;">Acceso restringido</h2>
          <p>Solo los administradores pueden visualizar las estad√≠sticas globales y los reportes.</p>
        </div>`;
    }
    return;
  }
  cargarReporteMembresias();
  cargarReporteIngresos();
  cargarReporteClases();
  cargarReporteSuscripcionesMensuales();
}

async function ensureAdminCaches() {
  const peticiones = [];

  if (!Array.isArray(window._usuariosCache)) {
    peticiones.push(getJson(ENDPOINTS.admin.usuarios, { headers: authHeaders() })
      .then(r => { if (r.ok) window._usuariosCache = r.data; }));
  }
  if (!Array.isArray(window._membresiasCache)) {
    peticiones.push(getJson(ENDPOINTS.admin.membresias, { headers: authHeaders() })
      .then(r => { if (r.ok) window._membresiasCache = r.data; }));
  }
  if (!Array.isArray(window._clasesAdminCache)) {
    peticiones.push(getJson(ENDPOINTS.clases.listar, { headers: authHeaders() })
      .then(r => { if (r.ok) window._clasesAdminCache = r.data; }));
  }
  if (!Array.isArray(window._ubicacionesAdminCache)) {
    peticiones.push(getJson(ENDPOINTS.ubicaciones.listar, { headers: authHeaders() })
      .then(r => { if (r.ok) window._ubicacionesAdminCache = r.data; }));
  }
  if (!Array.isArray(window._pagosCache)) {
    peticiones.push(getJson(ENDPOINTS.admin.pagos, { headers: authHeaders() })
      .then(r => { if (r.ok) window._pagosCache = r.data; }));
  }

  if (!window._reporteMembresias) {
    peticiones.push(getJson(ENDPOINTS.admin.reporteMembresias, { headers: authHeaders() })
      .then(r => { if (r.ok) window._reporteMembresias = r.data; }));
  }
  if (!window._reporteIngresos) {
    const periodo = document.getElementById('periodoIngresos')?.value || 'mensual';
    peticiones.push(getJson(ENDPOINTS.admin.reporteIngresos(periodo), { headers: authHeaders() })
      .then(r => { if (r.ok) window._reporteIngresos = r.data; }));
  }
  if (!Array.isArray(window._reporteClases)) {
    peticiones.push(getJson(ENDPOINTS.admin.reporteClases, { headers: authHeaders() })
      .then(r => { if (r.ok) window._reporteClases = r.data; }));
  }
  if (!window._suscripcionesMensuales) {
    peticiones.push(getJson(ENDPOINTS.admin.reporteSuscripciones, { headers: authHeaders() })
      .then(r => { if (r.ok) window._suscripcionesMensuales = r.data; }));
  }

  await Promise.allSettled(peticiones);
}
function nowSlug() {
  const d = new Date();
  const pad = n => String(n).padStart(2, '0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}`;
}
function mapUsuariosExcel(data=[]) {
  return data.map(u => ({
    ID: u.id,'Nombre completo': u.nombreCompleto,'Email': u.correoElectronico,'Tel√©fono': u.numeroTelefono || '',
    'Rol': u.rol,'Activo': u.estaActivo ? 'S√≠' : 'No','Fecha registro': u.fechaCreacion ? new Date(u.fechaCreacion).toLocaleString() : ''
  }));
}
function mapMembresiasExcel(data=[]) {
  return data.map(m => ({
    ID: m.id,'Usuario ID': m.usuarioId ?? (m.usuario?.id ?? ''),'Usuario': m.usuarioNombre ?? (m.usuario?.nombreCompleto ?? ''),
    'Plan': m.tipoPlan,'Precio': m.precio ?? '','Inicio': m.fechaInicio ? new Date(m.fechaInicio).toLocaleString() : '',
    'Fin': m.fechaFin ? new Date(m.fechaFin).toLocaleString() : '','Estado': m.estado,'Auto-renovaci√≥n': m.renovacionAutomatica ? 'S√≠' : 'No',
  }));
}
function mapClasesExcel(data=[]) {
  return data.map(c => ({
    ID: c.id,'Nombre': c.nombreClase,'Instructor': c.nombreInstructor,'Horario': c.horario,
    'Capacidad': c.capacidadMaxima ?? '','Inscritos': Array.isArray(c.usuariosInscritos) ? c.usuariosInscritos.length : (c.inscritos ?? 0),
    'Duraci√≥n (min)': c.duracionMinutos ?? '','Activo': c.estaActivo ? 'S√≠' : 'No',
  }));
}
function mapUbicacionesExcel(data=[]) {
  return data.map(u => ({
    ID: u.id,'Nombre': u.nombreUbicacion,'Direcci√≥n': u.direccion,'Distrito': u.distrito,'Ciudad': u.ciudad ?? '',
    'Tel√©fono': u.numeroTelefono ?? '','Horario': u.horario ?? '','Latitud': u.latitud ?? '','Longitud': u.longitud ?? '',
  }));
}
function mapPagosExcel(data=[]) {
  return data.map(p => ({
    ID: p.id,'Usuario ID': p.usuarioId ?? (p.usuario?.id ?? ''),'Usuario': p.usuarioNombre ?? (p.usuario?.nombreCompleto ?? ''),
    'Membres√≠a ID': p.membresiaId ?? (p.membresia?.id ?? ''),'Monto': p.monto ?? '',
    'Fecha pago': (p.fechaPago || p.fecha) ? new Date(p.fechaPago || p.fecha).toLocaleString() : '','Transacci√≥n': p.idTransaccion ?? '',
    'M√©todo': p.metodoPago ?? '','Estado': p.estadoPago ?? '',
  }));
}
function mapReporteMembresiasExcel(r={}) {
  return [
    { M√©trica: 'Total', Valor: r.totalMembresias ?? r.total ?? 0 },
    { M√©trica: 'Activas', Valor: r.membresiasActivas ?? r.activas ?? 0 },
    { M√©trica: 'B√°sico', Valor: r.membresiaBasico ?? 0 },
    { M√©trica: 'Premium', Valor: r.membresiaPremium ?? 0 },
    { M√©trica: 'Anual', Valor: r.membresiaAnual ?? 0 },
    { M√©trica: 'Pausadas', Valor: r.membresiasPausadas ?? 0 },
    { M√©trica: 'Canceladas', Valor: r.membresiasCanceladas ?? 0 },
    { M√©trica: 'Expiradas', Valor: r.membresiasExpiradas ?? r.vencidas ?? 0 },
  ];
}
function mapReporteIngresosExcel(r={}) {
  return [
    { M√©trica: 'Periodo', Valor: r.periodo ?? '' },
    { M√©trica: 'Total ingresos', Valor: r.totalIngresos ?? 0 },
    { M√©trica: 'Cantidad de pagos', Valor: r.cantidadPagos ?? 0 },
    { M√©trica: 'Promedio por pago', Valor: r.promedioIngreso ?? 0 },
    { M√©trica: 'M√©todo m√°s usado', Valor: r.metodoPagoMasUsado ?? 'N/A' },
  ];
}
function mapReporteClasesExcel(list=[]) {
  return list.map(x => ({
    'Clase': x.nombreClase,'Instructor': x.nombreInstructor ?? '','Capacidad': x.capacidadMaxima ?? 0,
    'Inscritos': x.usuariosInscritos ?? 0,'Ocupaci√≥n %': typeof x.tasaOcupacion === 'number' ? x.tasaOcupacion.toFixed(1) : 0,
  }));
}
function mapSuscripcionesMensualesExcel(obj={}) {
  return Object.entries(obj)
    .sort((a,b) => a[0].localeCompare(b[0]))
    .map(([mes, total]) => ({ Mes: mes, 'Nuevas suscripciones': total }));
}

/* ================== EXCEL & PDF ================== */
async function descargarReportesExcel() {
  try {
    await ensureAdminCaches();
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapUsuariosExcel(window._usuariosCache || [])), 'Usuarios');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapMembresiasExcel(window._membresiasCache || [])), 'Membresias');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapClasesExcel(window._clasesAdminCache || [])), 'Clases');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapUbicacionesExcel(window._ubicacionesAdminCache || [])), 'Ubicaciones');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapPagosExcel(window._pagosCache || [])), 'Pagos');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapReporteMembresiasExcel(window._reporteMembresias || {})), 'Rpt_Membresias');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapReporteIngresosExcel(window._reporteIngresos || {})), 'Rpt_Ingresos');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapReporteClasesExcel(window._reporteClases || [])), 'Rpt_Clases');
    if (window._suscripcionesMensuales) {
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapSuscripcionesMensualesExcel(window._suscripcionesMensuales)), 'Suscripciones_Mensuales');
    }
    const filename = `reportes_fitzone_${nowSlug()}.xlsx`;
    XLSX.writeFile(wb, filename);
  } catch (e) {
    console.error(e);
    alert('No se pudo generar el Excel');
  }
}
async function descargarReportesPDF() {
  try {
    await ensureAdminCaches();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt');
    const margin = 36;
    let y = margin;

    const addTitle = (t) => {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.text(t, margin, y);
      y += 8;
      doc.setLineWidth(0.5);
      doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y);
      y += 12;
    };

    const addTable = (head, body) => {
      doc.autoTable({
        startY: y,
        head: [head],
        body,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [255, 69, 0], textColor: 255 },
        margin: { left: margin, right: margin },
        theme: 'striped',
        didDrawPage: (data) => { y = data.cursor.y + 18; }
      });
    };

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.text('Reporte General - FitZone', margin, y);
    y += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(`Fecha: ${new Date().toLocaleString()}`, margin, y); y += 24;

    addTitle('Resumen de Membres√≠as');
    const rm = window._reporteMembresias || {};
    addTable(['M√©trica', 'Valor'], mapReporteMembresiasExcel(rm).map(r => [r['M√©trica'], String(r['Valor'])]));

    addTitle('Resumen de Ingresos');
    const ri = window._reporteIngresos || {};
    addTable(['M√©trica', 'Valor'], mapReporteIngresosExcel(ri).map(r => [r['M√©trica'], String(r['Valor'])]));

    addTitle('Clases (Ocupaci√≥n)');
    const rc = mapReporteClasesExcel(window._reporteClases || []);
    addTable(['Clase', 'Instructor', 'Capacidad', 'Inscritos', 'Ocupaci√≥n %'],
      rc.map(x => [x['Clase'], x['Instructor'], x['Capacidad'], x['Inscritos'], x['Ocupaci√≥n %']]));

    if (window._suscripcionesMensuales) {
      addTitle('Evoluci√≥n Mensual de Suscripciones');
      const sm = mapSuscripcionesMensualesExcel(window._suscripcionesMensuales);
      addTable(['Mes', 'Nuevas suscripciones'], sm.map(r => [r['Mes'], r['Nuevas suscripciones']]));
    }

    addTitle('Usuarios (resumen)');
    const u = mapUsuariosExcel((window._usuariosCache || [])).slice(0, 20);
    addTable(['ID','Nombre','Email','Tel√©fono','Rol','Activo','Registro'],
      u.map(r => [r['ID'], r['Nombre completo'], r['Email'], r['Tel√©fono'], r['Rol'], r['Activo'], r['Fecha registro']]));

    addTitle('Membres√≠as (resumen)');
    const mm = mapMembresiasExcel((window._membresiasCache || [])).slice(0, 20);
    addTable(['ID','Usuario','Plan','Precio','Inicio','Fin','Estado','Auto-renov'],
      mm.map(r => [r['ID'], r['Usuario'], r['Plan'], r['Precio'], r['Inicio'], r['Fin'], r['Estado'], r['Auto-renovaci√≥n']]));

    const filename = `reportes_fitzone_${nowSlug()}.pdf`;
    doc.save(filename);
  } catch (e) {
    console.error(e);
    alert('No se pudo generar el PDF');
  }
}

async function cargarReporteMembresias(){
  const loading=document.getElementById('loadingReporteMembresias'); const content=document.getElementById('reporteMembresiaContent');
  loading.classList.add('show');
  try{
    const { ok, data:d } = await getJson(ENDPOINTS.admin.reporteMembresias, { headers:{...authHeaders()} });
    if (ok && d){
      content.innerHTML = `
        <p><strong>Total:</strong> ${d.totalMembresias ?? d.total ?? 0}</p>
        <p><strong>Activas:</strong> ${d.membresiasActivas ?? d.activas ?? 0}</p>
        <p><strong>B√°sico:</strong> ${d.membresiaBasico ?? 0} | <strong>Premium:</strong> ${d.membresiaPremium ?? 0} | <strong>Anual:</strong> ${d.membresiaAnual ?? 0}</p>
      `;
    } else content.innerHTML='<p style="color:#dc3545;">Error</p>';
  }catch{ content.innerHTML='<p style="color:#dc3545;">Error</p>'; }
  finally{ loading.classList.remove('show'); }
}
async function cargarReporteIngresos(){
  const loading=document.getElementById('loadingReporteIngresos'); const content=document.getElementById('reporteIngresosContent');
  const periodo=document.getElementById('periodoIngresos').value;
  loading.classList.add('show');
  try{
    const { ok, data:d } = await getJson(ENDPOINTS.admin.reporteIngresos(periodo), { headers:{...authHeaders()} });
    if (ok && d){
      content.innerHTML = `
        <p><strong>Periodo:</strong> ${d.periodo||periodo}</p>
        <p><strong>Total ingresos:</strong> S/${Number(d.totalIngresos||0).toFixed(2)}</p>
        <p><strong>Cantidad de pagos:</strong> ${d.cantidadPagos||0}</p>
        <p><strong>Promedio por pago:</strong> S/${Number(d.promedioIngreso||0).toFixed(2)}</p>
      `;
    } else content.innerHTML='<p style="color:#dc3545;">Error</p>';
  }catch{ content.innerHTML='<p style="color:#dc3545;">Error</p>'; }
  finally{ loading.classList.remove('show'); }
}
async function cargarReporteClases(){
  const loading=document.getElementById('loadingReporteClases'); const content=document.getElementById('reporteClasesContent');
  loading.classList.add('show');
  try{
    const { ok, data:lista } = await getJson(ENDPOINTS.admin.reporteClases, { headers:{...authHeaders()} });
    if (ok && Array.isArray(lista)){
      const rows = lista.map(r => `<li>${r.nombreClase}: ${Number(r.tasaOcupacion||r.porcentajeOcupacion||0).toFixed(1)}% (Inscritos: ${r.usuariosInscritos ?? r.inscritos ?? 0}/${r.capacidadMaxima ?? r.capacidad ?? 0})</li>`).join('');
      content.innerHTML = rows ? `<ul>${rows}</ul>` : '<p>No hay datos</p>';
    } else content.innerHTML='<p style="color:#dc3545;">Error</p>';
  }catch{ content.innerHTML='<p style="color:#dc3545;">Error</p>'; }
  finally{ loading.classList.remove('show'); }
}
async function cargarReporteSuscripcionesMensuales() {
  const canvas = document.getElementById('graficoSuscripciones');
  const ctx = canvas.getContext('2d');
  try {
    const { ok, data } = await getJson(ENDPOINTS.admin.reporteSuscripciones, { headers: authHeaders() });
    if (!ok) throw new Error("Error al obtener datos");
    const labels = Object.keys(data);
    const values = Object.values(data);
    if (window.suscripcionesChart) window.suscripcionesChart.destroy();
    window.suscripcionesChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label:'Nuevas suscripciones por mes', data: values, borderColor:'#ff4500', backgroundColor:'rgba(255,69,0,0.2)', borderWidth:3, tension:0.3, fill:true, pointRadius:5, pointHoverRadius:7 }] },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, title: { display: true, text: 'Cantidad' } }, x: { title: { display: true, text: 'Mes (yyyy-MM)' } } },
        plugins: { legend: { labels: { color: '#fff' } }, title: { display: true, text: 'Tendencia de Suscripciones Mensuales', color: '#ff4500', font: { size: 16 } } }
      }
    });
  } catch (err) {
    console.error(err);
    alert('No se pudo cargar el gr√°fico de suscripciones.');
  }
}

/* ===== export util ===== */
function tablaDOMToArrays(tableEl){
  const head = [...tableEl.querySelectorAll('thead th')].map(th=>th.innerText.trim());
  const body = [...tableEl.querySelectorAll('tbody tr')].map(tr =>
    [...tr.children].map(td => td.innerText.trim())
  );
  return { head, body };
}
function descargarTablaComoPDF(tableContainerId, filenameBase='Tabla'){
  const table = document.querySelector(`#${tableContainerId} table`);
  if(!table){ alert('No hay datos para exportar'); return; }
  const { head, body } = tablaDOMToArrays(table);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt');
  doc.setFont('helvetica','bold'); doc.setFontSize(14);
  doc.text(filenameBase, 36, 40);
  doc.autoTable({ startY: 60, head: [head], body: body, styles: { fontSize: 9 }, headStyles: { fillColor: [255,69,0], textColor: 255 }, margin: { left: 36, right: 36 }, theme: 'striped' });
  doc.save(`${filenameBase}_${new Date().toISOString().slice(0,10)}.pdf`);
}
function descargarTablaComoExcel(tableContainerId, filenameBase='Tabla'){
  const table = document.querySelector(`#${tableContainerId} table`);
  if(!table){ alert('No hay datos para exportar'); return; }
  const { head, body } = tablaDOMToArrays(table);
  const rows = body.map(r=>{ const obj = {}; head.forEach((h,i)=>{ obj[h] = r[i] ?? ''; }); return obj; });
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), 'Datos');
  XLSX.writeFile(wb, `${filenameBase}_${new Date().toISOString().slice(0,10)}.xlsx`);
}

/* ================== PERFIL (Front) ================== */
function usuarioActualLS(){ try { return JSON.parse(localStorage.getItem('usuario')||'{}'); } catch { return {}; } }
function abrirModalPassword(){ document.getElementById('modalPassword').classList.add('show'); }
function cambiarTabPerfil(tab, btn){
  document.querySelectorAll('[data-perfil-tab]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ['info','membresia','pagos','clases','preferencias'].forEach(id=>{ document.getElementById('perfil-'+id).classList.remove('active'); });
  document.getElementById('perfil-'+tab).classList.add('active');
  if(tab==='membresia') cargarMembresiaUsuario();
  if(tab==='pagos')     cargarPagosUsuario();
  if(tab==='clases')    cargarClasesUsuario();
  if(tab==='preferencias') cargarPreferencias();
}
async function cargarPerfil(){
  let me = null;
  try { const { ok, data } = await getJson(ENDPOINTS.usuarios.me, { headers: { ...authHeaders() }}); if(ok) me = data; } catch {}
  if(!me){
    const ls = usuarioActualLS();
    const { ok, data } = await getJson(ENDPOINTS.admin.usuarios, { headers: { ...authHeaders() }}); if(ok){ me = (data||[]).find(u=>u.id === ls.usuarioId); }
  }
  if(!me){ alert('No se pudo cargar el perfil'); return; }
  document.getElementById('perfilNombre').value = me.nombreCompleto || '';
  document.getElementById('perfilCorreo').value = me.correoElectronico || '';
  document.getElementById('perfilTelefono').value = me.numeroTelefono || '';
  document.getElementById('perfilRol').value = me.rol || 'USUARIO';
  document.getElementById('perfilFecha').value = me.fechaCreacion ? new Date(me.fechaCreacion).toLocaleString() : '‚Äî';
  window._perfilUsuario = me;
}
window.cargarPerfil = cargarPerfil;

async function guardarPerfil(e){
  e.preventDefault();
  const me = window._perfilUsuario; if(!me) return;
  const payload = {
    nombreCompleto: document.getElementById('perfilNombre').value.trim(),
    numeroTelefono: document.getElementById('perfilTelefono').value.trim(),
    rol: me.rol,
    estaActivo: me.estaActivo ?? true
  };
  const { ok } = await sendJson(ENDPOINTS.usuarios.update(me.id), 'PUT', payload, authHeaders());
  if(ok){ alert('Perfil actualizado'); cargarPerfil(); }
  else { alert('No se pudo guardar'); }
}

async function guardarPassword(e){
  e.preventDefault();
  const me = window._perfilUsuario; if(!me) return;
  const a = document.getElementById('pwdActual').value;
  const n = document.getElementById('pwdNueva').value;
  const n2= document.getElementById('pwdNueva2').value;
  if(n!==n2){ alert('La nueva contrase√±a no coincide'); return; }
  const payload = { actual: a, nueva: n };
  const { ok, data } = await sendJson(ENDPOINTS.usuarios.password(me.id), 'PUT', payload, authHeaders());
  if(ok){ alert('Contrase√±a actualizada'); cerrarModal('modalPassword'); }
  else { alert((data && data.mensaje) || 'No se pudo actualizar'); }
}

/* ===== MEMBRES√çA (Perfil) ===== */
async function cargarMembresiaUsuario(){
  const me = window._perfilUsuario || usuarioActualLS(); if(!me) return;
  const box = document.getElementById('perfilMembresiaBox');
  box.innerHTML = '<p>Cargando...</p>';
  try{
    const { ok, data } = await getJson(ENDPOINTS.membresias.porUsuario(me.id), { headers: { ...authHeaders() }});
    if(!ok){ box.innerHTML = '<p style="color:#dc3545">No se pudo obtener la membres√≠a.</p>'; return; }
    window._membresiaUsuario = data;

    const diasRest = data.fechaFin ? Math.max(0, Math.ceil((new Date(data.fechaFin) - new Date())/(1000*60*60*24))) : '‚Äî';
    box.innerHTML = `
      <p><b>Plan:</b> <span class="badge badge-info">${data.tipoPlan || '‚Äî'}</span></p>
      <p><b>Precio:</b> S/ ${data.precio ?? '‚Äî'}</p>
      <p><b>Inicio:</b> ${data.fechaInicio? new Date(data.fechaInicio).toLocaleString():'‚Äî'}</p>
      <p><b>Fin:</b> ${data.fechaFin? new Date(data.fechaFin).toLocaleString():'‚Äî'} ${diasRest!=='‚Äî' ? `(<b>${diasRest} d√≠as restantes</b>)` : ''}</p>
      <p><b>Estado:</b> <span class="badge ${data.estado==='ACTIVO'?'badge-success':'badge-warning'}">${data.estado||'‚Äî'}</span></p>
    `;
    document.getElementById('btnActivarMembresia').style.display = 'inline-block';
    document.getElementById('btnCancelarMembresia').style.display = (data.estado==='ACTIVO') ? 'inline-block':'none';
    document.getElementById('chkAutoRenov').checked = !!data.renovacionAutomatica;
  }catch{
    box.innerHTML = '<p style="color:#dc3545">Error de conexi√≥n.</p>';
  }
}
async function activarMembresia(){
  const me = window._perfilUsuario || usuarioActualLS(); if(!me) return;
  const plan = prompt('Elige plan: BASICO | PREMIUM | ANUAL', 'BASICO');
  if(!plan) return;
  const payload = { usuarioId: me.id, tipoPlan: plan.toUpperCase(), renovacionAutomatica: true };
  const { ok, data } = await sendJson(ENDPOINTS.membresias.crear, 'POST', payload, authHeaders());
  if(ok){ alert('Membres√≠a activada/renovada'); cargarMembresiaUsuario(); }
  else { alert((data && data.mensaje) || 'No se pudo crear/renovar'); }
}
async function cancelarMembresiaUsuario(){
  const m = window._membresiaUsuario; if(!m) return;
  if(!confirm('¬øCancelar tu membres√≠a actual?')) return;
  const { ok, data } = await sendJson(ENDPOINTS.membresias.cancelar(m.id), 'PUT', {}, authHeaders());
  if(ok){ alert('Membres√≠a cancelada'); cargarMembresiaUsuario(); }
  else { alert((data && data.mensaje) || 'No se pudo cancelar'); }
}
async function toggleAutoRenovacion(chk){
  const m = window._membresiaUsuario; if(!m) return;
  const payload = { renovacionAutomatica: !!chk.checked };
  const { ok } = await sendJson(ENDPOINTS.membresias.update(m.id), 'PUT', payload, authHeaders());
  if(!ok){ alert('No se pudo actualizar la auto-renovaci√≥n'); chk.checked = !chk.checked; }
}

/* ===== PAGOS (Perfil) ===== */
async function cargarPagosUsuario(){
  const me = window._perfilUsuario || usuarioActualLS(); if(!me) return;
  const { ok, data } = await getJson(ENDPOINTS.pagos.porUsuario(me.id), { headers: { ...authHeaders() }});
  window._pagosUsuario = ok ? data : [];
  renderPagosUsuario();
}
function renderPagosUsuario(){
  const cont = document.getElementById('tablaPagosUsuario');
  const q = (document.getElementById('filtroPagosUsuario')?.value||'').toLowerCase();
  const arr = (window._pagosUsuario||[]).filter(p=>{
    const f = `${p.idTransaccion||''} ${p.metodoPago||''} ${p.estadoPago||''} ${p.monto||''} ${p.fechaPago||''}`.toLowerCase();
    return f.includes(q);
  });
  cont.innerHTML = `
    <table>
      <thead><tr>
        <th>Transacci√≥n</th><th>Fecha</th><th>Monto</th><th>M√©todo</th><th>Estado</th>
      </tr></thead>
      <tbody>
        ${arr.map(p=>`
          <tr>
            <td>${p.idTransaccion || '‚Äî'}</td>
            <td>${p.fechaPago ? new Date(p.fechaPago).toLocaleString() : '‚Äî'}</td>
            <td>S/ ${p.monto ?? '‚Äî'}</td>
            <td>${p.metodoPago || '‚Äî'}</td>
            <td><span class="badge ${p.estadoPago==='COMPLETADO'?'badge-success':(p.estadoPago==='PENDIENTE'?'badge-warning':'badge-danger')}">${p.estadoPago||'‚Äî'}</span></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}
async function descargarPagosUsuarioPDF(){ descargarTablaComoPDF('tablaPagosUsuario', 'Pagos_Mi_Perfil'); }
async function descargarPagosUsuarioExcel(){ descargarTablaComoExcel('tablaPagosUsuario', 'Pagos_Mi_Perfil'); }

/* ===== CLASES (Perfil) ===== */
async function cargarClasesUsuario(){
  const me = window._perfilUsuario || usuarioActualLS(); if(!me) return;
  const { ok, data } = await getJson(ENDPOINTS.clases.porUsuario(me.id), { headers: { ...authHeaders() }});
  window._clasesUsuario = ok ? data : [];
  renderClasesUsuario();
}
function renderClasesUsuario(){
  const cont = document.getElementById('tablaClasesUsuario');
  const tipo = document.getElementById('filtroClasesTipo')?.value || 'proximas';
  const ahora = new Date();

  const arr = (window._clasesUsuario||[]).filter(c=>{
    const d = c.horario && !isNaN(Date.parse(c.horario)) ? new Date(c.horario) : null;
    if (!d) return tipo === 'todas';
    if (tipo === 'proximas') return d >= ahora;
    if (tipo === 'pasadas')  return d <  ahora;
    return true;
  });

  cont.innerHTML = `
    <table>
      <thead><tr>
        <th>Clase</th><th>Instructor</th><th>Horario</th><th>Duraci√≥n</th><th>Cupos</th><th>Acciones</th>
      </tr></thead>
      <tbody>
        ${arr.map(c=>{
          const inscritos = (c.usuariosInscritos?.length)||0;
          const cap = c.capacidadMaxima ?? 0;
          const llena = cap>0 && inscritos>=cap;
          let horarioTxt = '‚Äî';
          if (c.horario) {
            if (!isNaN(Date.parse(c.horario))) { horarioTxt = new Date(c.horario).toLocaleString(); }
            else { horarioTxt = String(c.horario); }
          }
          return `
          <tr>
            <td>${c.nombreClase||'‚Äî'}</td>
            <td>${c.nombreInstructor||'‚Äî'}</td>
            <td>${horarioTxt}</td>
            <td>${c.duracionMinutos? c.duracionMinutos+' min':'‚Äî'}</td>
            <td>${inscritos}/${cap} ${llena?'<span class="badge badge-warning">Completa</span>':''}</td>
            <td><button class="action-btn btn-delete" onclick="cancelarInscripcionClase(${c.id})">Cancelar inscripci√≥n</button></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  `;
}
async function cancelarInscripcionClase(claseId) {
  const usuario = JSON.parse(localStorage.getItem('usuario'));
  const token = localStorage.getItem('token');

  if (!usuario || !usuario.usuarioId) {
    alert("No se encontr√≥ el usuario actual.");
    return;
  }

  console.log("Cancelando inscripci√≥n de clase:", claseId, "Usuario:", usuario.usuarioId);

  try {
    const res = await fetch(`${API_URL}/clases/${claseId}/cancelar-inscripcion`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ usuarioId: Number(usuario.usuarioId) })
    });

    const data = await res.json();
    console.log("Respuesta:", data);

    if (!res.ok) {
      alert(data.mensaje || "Error al cancelar inscripci√≥n");
    } else {
      alert(data.mensaje || "Inscripci√≥n cancelada con √©xito");
    }
  } catch (error) {
    console.error("Error al cancelar inscripci√≥n:", error);
    alert("Error de conexi√≥n con el servidor");
  }
}

/* ===== Preferencias (Perfil) ===== */
async function cargarPreferencias(){
  const me = window._perfilUsuario || usuarioActualLS(); if(!me) return;
  try{
    const { ok, data } = await getJson(ENDPOINTS.usuarios.prefs(me.id), { headers: { ...authHeaders() }});
    if(ok){
      document.getElementById('prefEmailNoti').checked = !!data.emailNotificaciones;
      document.getElementById('prefRecordatorios').value = data.recordatorios || 'none';
    }
  }catch{}
}
async function guardarPreferencias(e){
  e.preventDefault();
  const me = window._perfilUsuario || usuarioActualLS(); if(!me) return;
  const payload = {
    emailNotificaciones: document.getElementById('prefEmailNoti').checked,
    recordatorios: document.getElementById('prefRecordatorios').value
  };
  const { ok } = await sendJson(ENDPOINTS.usuarios.prefs(me.id),'PUT',payload,authHeaders());
  alert(ok? 'Preferencias guardadas' : 'No se pudo guardar');
}

/* ===== Utilidad para abrir Perfil directamente ===== */
function irPerfil(){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('perfil').classList.add('active');
  cambiarTabPerfil('info', document.querySelector('[data-perfil-tab="info"]'));
  cargarPerfil();
}

/* ================== MODALES ================== */
function abrirModal(id){ document.getElementById(id).classList.add('show'); }
function cerrarModal(id){ document.getElementById(id).classList.remove('show'); }

/* ================== MAPA (Leaflet) ================== */
/* ===== CAMBIO: secci√≥n de mapa reescrita para SPA con Leaflet ===== */
let map;
let markers = [];
let selectedLocationIndex = null;

/** Asegura que el contenedor del mapa tenga altura y que nada bloquee los clics */
function prepararContenedorMapa() {
  const mapEl = document.getElementById('map');
  if (!mapEl) return;

  // Altura m√≠nima para que Leaflet calcule tama√±o
  if (!mapEl.style.height && !mapEl.style.minHeight) {
    mapEl.style.minHeight = '380px';
  }
  mapEl.style.width = '100%';

  // El overlay visual no debe bloquear la interacci√≥n
  const dim = document.querySelector('.map-dim');
  const overlay = document.querySelector('.map-overlay');
  if (dim) dim.style.pointerEvents = 'none';
  if (overlay) overlay.style.pointerEvents = 'none';
}

function initMap() {
  if (map) return;

  prepararContenedorMapa();

  map = L.map('map', {
    zoomControl: true,
    attributionControl: true,
  }).setView([-12.0464, -77.0428], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // Si las ubicaciones ya est√°n en cach√©, pinto marcadores
  pintarMarcadores(window._ubicacionesCache || []);

  // Peque√±o retraso para recalcular tama√±o al montar
  setTimeout(() => map.invalidateSize(), 80);
}

/** Icono para marcador (seleccionado vs normal) */
function getMarkerIcon(selected = false) {
  const color = selected ? '#ff4500' : '#2e7d32';
  return L.divIcon({
    html: `<div style="
      background:${color};
      width:30px;height:30px;border-radius:50%;
      border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.3)
    "></div>`,
    className: '',
    iconSize: [30, 30]
  });
}

/** Dibuja marcadores desde lista de ubicaciones */
function pintarMarcadores(ubicaciones) {
  if (!map) return;

  // Limpia anteriores
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const visibles = (ubicaciones || []).filter(u => u.latitud && u.longitud);

  visibles.forEach((u, idx) => {
    const marker = L
      .marker([u.latitud, u.longitud], { icon: getMarkerIcon(selectedLocationIndex === idx) })
      .addTo(map)
      .bindPopup(`
        <div style="padding: 0.5rem;">
          <strong style="color:#ff4500;font-size:1.05rem;">${u.nombreUbicacion || 'FitZone'}</strong><br/>
          ${u.direccion ? `üìç ${u.direccion}<br/>` : ''}
          ${u.distrito ? `üèôÔ∏è ${u.distrito}<br/>` : ''}
          ${u.horario ? `‚è∞ ${u.horario}<br/>` : ''}
          ${u.numeroTelefono ? `üìû ${u.numeroTelefono}` : ''}
        </div>
      `);

    marker.on('click', () => seleccionarUbicacion(idx));
    markers.push(marker);
  });

  if (markers.length) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

/** Actualiza estado seleccionado y re-pinta iconos */
function actualizarMarcadores() {
  if (!map) return;
  pintarMarcadores(window._ubicacionesCache || []);
}

/** Seleccionar una ubicaci√≥n desde la lista */
function seleccionarUbicacion(index) {
  selectedLocationIndex = index;
  const u = (window._ubicacionesCache || [])[index];
  if (!u || !u.latitud || !u.longitud || !map) return;

  map.setView([u.latitud, u.longitud], 16, { animate: true, duration: 1 });
  actualizarMarcadores();
  if (markers[index]) markers[index].openPopup();

  if (typeof renderUbicacionesPublicas === 'function') renderUbicacionesPublicas();
}
</script>

</body>
</html>
