<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartFit - Tu Gimnasio 24/7</title>
  <link rel="stylesheet" href="css/estilos.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


</head>
<body>
  <nav>
    <ul>
      <li class="logo">SMARTFIT</li>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
      <div class="nav-links" id="navLinks">
        <li><a href="#" onclick="showPage('home')">Inicio</a></li>
        <li><a href="#" onclick="showPage('pricing')">Precios</a></li>
        <li><a href="#" onclick="showPage('locations')">Ubicaciones</a></li>
        <li><a href="#" onclick="showPage('classes')">Clases</a></li>
        <li><a href="#" onclick="showPage('contact')">Contacto</a></li>
        <li id="adminLink" style="display:none;"><a href="#" onclick="showPage('admin')">Panel Admin</a></li>
        <li class="user-info" id="userInfo">
          <span class="user-name" id="userName"></span>
          <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </li>
        <li id="authLink"><a href="#" onclick="showPage('login')">Login</a></li>
      </div>
    </ul>
  </nav>

  <!-- ================= HOME ================= -->
  <div id="home" class="page active">
    <div class="hero">
      <h1>Transforma tu <span class="highlight">Vida</span></h1>
      <p>Acceso 24/7 a m√°s de 50 ubicaciones. Equipamiento de √∫ltima generaci√≥n. Clases ilimitadas.</p>
      <div>
        <button class="btn" onclick="showPage('pricing')">√önete Ahora</button>
        <button class="btn btn-secondary" onclick="showPage('pricing')">Ver Precios</button>
      </div>
    </div>

    <div class="features">
      <h2>¬øPor Qu√© Elegir Smart Fit?</h2>
      <div class="features-grid">
        <div class="feature-card"><div class="feature-icon">üèãÔ∏è</div><h3>Equipamiento Premium</h3><p>Las mejores m√°quinas y equipos del mercado.</p></div>
        <div class="feature-card"><div class="feature-icon">üïê</div><h3>Acceso 24/7</h3><p>Entrena cuando quieras, donde quieras.</p></div>
        <div class="feature-card"><div class="feature-icon">üë•</div><h3>Clases Grupales</h3><p>Yoga, spinning, crossfit y m√°s.</p></div>
        <div class="feature-card"><div class="feature-icon">üìç</div><h3>+50 Ubicaciones</h3><p>Un solo plan, m√∫ltiples sedes.</p></div>
      </div>
    </div>
  </div>

  <!-- ================= PRECIOS ================= -->
  <div id="pricing" class="page">
    <div class="pricing-container">
      <h2>Planes y Precios</h2>
      <div class="pricing-grid">
        <div class="pricing-card">
          <h3>Plan B√°sico</h3>
          <div class="price">S/29<span style="font-size:1rem;">/mes</span></div>
          <ul class="pricing-features">
            <li>Acceso a 1 gimnasio</li><li>Horario 6am - 10pm</li><li>√Årea de pesas</li><li>Cardio ilimitado</li>
          </ul>
          <button class="btn" onclick="seleccionarPlan('BASICO',29)">Seleccionar</button>
        </div>
        <div class="pricing-card featured">
          <h3>Plan Premium</h3>
          <div class="price">S/49<span style="font-size:1rem;">/mes</span></div>
          <ul class="pricing-features">
            <li>Acceso a todas las sedes</li><li>Acceso 24/7</li><li>Todas las clases</li><li>1 sesi√≥n personal</li>
          </ul>
          <button class="btn" onclick="seleccionarPlan('PREMIUM',49)">Seleccionar</button>
        </div>
        <div class="pricing-card">
          <h3>Plan Anual</h3>
          <div class="price">S/399<span style="font-size:1rem;">/a√±o</span></div>
          <ul class="pricing-features">
            <li>Todo del Plan Premium</li><li>Ahorra S/189</li><li>3 sesiones/mes</li><li>Plan nutricional</li>
          </ul>
          <button class="btn" onclick="seleccionarPlan('ANUAL',399)">Seleccionar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= LOGIN ================= -->
  <div id="login" class="page">
    <div class="auth-container">
      <div class="auth-form">
        <h2 id="authTitle">Iniciar Sesi√≥n</h2>
        <div id="successMsg" class="success-message"></div>
        <div id="errorMsg" class="error-message"></div>
        <form id="authForm" onsubmit="manejarAutenticacion(event)">
          <div class="form-group" id="nameGroup" style="display:none;">
            <label>Nombre Completo</label><input type="text" id="nombreCompleto" placeholder="Tu nombre" />
          </div>
          <div class="form-group"><label>Correo</label><input type="email" id="correoElectronico" required /></div>
          <div class="form-group" id="phoneGroup" style="display:none;">
            <label>Tel√©fono</label><input type="tel" id="numeroTelefono" placeholder="+51 999 999 999" />
          </div>
          <div class="form-group"><label>Contrase√±a</label><input type="password" id="contrasena" required /></div>
          <button type="submit" class="btn" id="btnAuth" style="width:100%;">Continuar</button>
        </form>
        <div class="auth-links">
          <p id="toggleText">¬øNo tienes cuenta? <a href="#" onclick="cambiarModoAuth(event)">Reg√≠strate</a></p>
          <p><a href="#" onclick="mostrarMensaje('Se ha enviado un enlace de recuperaci√≥n a tu correo','success')">¬øOlvidaste tu contrase√±a?</a></p>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= UBICACIONES ================= -->
  <div id="locations" class="page">
    <div class="locations-container">
      <h2 style="text-align:center; color:#ff4500; margin-bottom:2rem;">Encuentra tu FitZone</h2>
      <div class="map-container">
        <div class="map-header" style="text-align:center;">
          <div style="font-size:3rem; margin-bottom:.5rem;">üó∫Ô∏è</div>
          <p>Mapa Interactivo - Integraci√≥n con Google Maps (en producci√≥n)</p>
        </div>
        <iframe
          src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d710.0623193428297!2d-76.88396156762542!3d-12.017979333594807!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x9105c342d50651b3%3A0x4b7661150d480a93!2sGimnasio%20Smart%20Fit%20-%20Qhatu%20Plaza%20-%20Santa%20Clara!5e0!3m2!1ses!2spe!4v1760017481962!5m2!1ses!2spe"
          loading="lazy" referrerpolicy="no-referrer-when-downgrade" allowfullscreen>
        </iframe>
      </div>

      <div class="section-top" style="margin-top:1rem;">
        <div class="filters">
          <input type="text" id="filtroPublicUbicacionesTexto" placeholder="Buscar distrito o ciudad" oninput="renderUbicacionesPublicas()"/>
        </div>
      </div>

      <div class="loading" id="loadingLocations"><div class="spinner"></div><p>Cargando ubicaciones...</p></div>
      <div class="locations-list" id="locationsList"></div>
    </div>
  </div>

  <!-- ================= CLASES ================= -->
  <div id="classes" class="page">
    <div class="classes-container">
      <h2 style="text-align:center; color:#ff4500; margin-bottom:2rem;">Clases y Horarios</h2>
      <div class="section-top">
        <div class="filters">
          <input type="text" id="filtroPublicClasesTexto" placeholder="Buscar por nombre o instructor" oninput="renderClasesPublicas()"/>
        </div>
      </div>
      <div class="loading" id="loadingClasses"><div class="spinner"></div><p>Cargando clases...</p></div>
      <div class="classes-grid" id="classesList"></div>
    </div>
  </div>

  <!-- ================= CONTACTO ================= -->
  <div id="contact" class="page">
    <div class="contact-container">
      <h2 style="text-align:center; color:#ff4500; margin-bottom:2rem;">Contacto</h2>
      <div class="contact-grid">
        <div>
          <div class="contact-info">
            <h3>Informaci√≥n de Contacto</h3>
            <p><strong>üìû Tel√©fono:</strong> +51 999 000 111</p>
            <p><strong>‚úâÔ∏è Email:</strong> hola@smartfit.com</p>
            <p><strong>‚è∞ Atenci√≥n:</strong> 24/7 v√≠a chat y email</p>
          </div>
        </div>
        <div>
          <div class="auth-form">
            <h3 style="text-align:center; color:#ff4500;">Env√≠anos un Mensaje</h3>
            <div id="contactSuccessMsg" class="success-message"></div>
            <div id="contactErrorMsg" class="error-message"></div>
            <form onsubmit="enviarMensajeContacto(event)">
              <div class="form-group"><label>Nombre</label><input type="text" id="contactNombre" required /></div>
              <div class="form-group"><label>Email</label><input type="email" id="contactEmail" required /></div>
              <div class="form-group"><label>Asunto</label><input type="text" id="contactAsunto" required /></div>
              <div class="form-group"><label>Mensaje</label><textarea id="contactMensaje" required style="min-height:120px;"></textarea></div>
              <button type="submit" class="btn" id="btnContact" style="width:100%;">Enviar Mensaje</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= PAGO ================= -->
  <div id="payment" class="page">
    <div class="payment-container" style="max-width:800px;">
      <h2 style="text-align:center; color:#ff4500; margin-bottom:2rem;">Completar Pago</h2>
      <div class="payment-summary">
        <h3>Resumen de tu pedido</h3>
        <p><strong>Plan seleccionado:</strong> <span id="selectedPlan">-</span></p>
        <p><strong>Total:</strong> S/<span id="totalAmount">0</span></p>
      </div>
      <div class="auth-form">
        <h3 style="color:#ff4500;">Datos de Pago</h3>
        <div id="paymentSuccessMsg" class="success-message"></div>
        <div id="paymentErrorMsg" class="error-message"></div>
        <form onsubmit="procesarPago(event)">
          <div class="form-group"><label>Nombre en la Tarjeta</label><input type="text" id="nombreTarjeta" required /></div>
          <div class="form-group"><label>N√∫mero de Tarjeta</label><input type="text" id="numeroTarjeta" required maxlength="19" /></div>
          <div class="form-group"><label>Fecha de Expiraci√≥n</label><input type="text" id="fechaExpiracion" required maxlength="5" /></div>
          <div class="form-group"><label>CVV</label><input type="text" id="cvv" required maxlength="4" /></div>
          <button type="submit" class="btn" id="btnPayment" style="width:100%;">Confirmar Pago</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ================= ADMIN  ================= -->
  <div id="admin" class="page">
    <div class="admin-container">
      <div class="admin-header">
        <h1>Panel de Administraci√≥n</h1>
        <p>Gesti√≥n completa del gimnasio</p>
      </div>

      <!-- Pesta√±as arriba (sin sidebar) -->
      <div class="admin-tabs" id="adminTabs">
        <button class="admin-tab active" data-tab="dashboard" onclick="cambiarTabAdmin('dashboard', this)">Dashboard</button>
        <button class="admin-tab" data-tab="usuarios" onclick="cambiarTabAdmin('usuarios', this)">Usuarios</button>
        <button class="admin-tab" data-tab="membresias" onclick="cambiarTabAdmin('membresias', this)">Membres√≠as</button>
        <button class="admin-tab" data-tab="clases-admin" onclick="cambiarTabAdmin('clases-admin', this)">Clases</button>
        <button class="admin-tab" data-tab="ubicaciones-admin" onclick="cambiarTabAdmin('ubicaciones-admin', this)">Ubicaciones</button>
        <button class="admin-tab" data-tab="pagos-admin" onclick="cambiarTabAdmin('pagos-admin', this)">Pagos</button>
        <button class="admin-tab" data-tab="reportes" onclick="cambiarTabAdmin('reportes', this)">Reportes</button>
      </div>

      <!-- DASHBOARD -->
      <div id="tab-dashboard" class="admin-content active">
        <h2 class="section-title">Estad√≠sticas Generales</h2>
        <div class="loading" id="loadingDashboard"><div class="spinner"></div><p>Cargando estad√≠sticas...</p></div>
        <div class="dashboard-grid" id="dashboardStats"></div>
      </div>

      <!-- USUARIOS -->
      <div id="tab-usuarios" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Usuarios</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearUsuario()">+ Crear Usuario</button>
            <div class="filters">
              <input type="text" id="filtroUsuariosTexto" placeholder="Buscar por nombre o email" oninput="renderUsuariosFiltrados()"/>
              <select id="filtroUsuariosRol" onchange="renderUsuariosFiltrados()">
                <option value="">Todos los roles</option>
                <option value="USUARIO">Usuario</option>
                <option value="ENTRENADOR">Entrenador</option>
                <option value="ADMINISTRADOR">Administrador</option>
              </select>
              <select id="filtroUsuariosEstado" onchange="renderUsuariosFiltrados()">
                <option value="">Todos</option>
                <option value="true">Activos</option>
                <option value="false">Inactivos</option>
              </select>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingUsuarios"><div class="spinner"></div><p>Cargando usuarios...</p></div>
        <div class="data-table" id="usuariosTable"></div>
      </div>

      <!-- MEMBRES√çAS -->
      <div id="tab-membresias" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Membres√≠as</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearMembresia()">+ Crear Membres√≠a (Presencial)</button>
            <div class="filters">
              <input type="text" id="filtroMembresiasTexto" placeholder="Buscar por usuario o plan" oninput="renderMembresiasFiltradas()"/>
              <select id="filtroMembresiasEstado" onchange="renderMembresiasFiltradas()">
                <option value="">Estado: Todos</option>
                <option value="ACTIVO">Activo</option>
                <option value="PAUSADO">Pausado</option>
                <option value="CANCELADO">Cancelado</option>
                <option value="EXPIRADO">Expirado</option>
              </select>
              <select id="filtroMembresiasPlan" onchange="renderMembresiasFiltradas()">
                <option value="">Plan: Todos</option>
                <option value="BASICO">B√°sico</option>
                <option value="PREMIUM">Premium</option>
                <option value="ANUAL">Anual</option>
              </select>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingMembresias"><div class="spinner"></div><p>Cargando membres√≠as...</p></div>
        <div class="data-table" id="membresiasTable"></div>
      </div>

      <!-- CLASES -->
      <div id="tab-clases-admin" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Clases</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearClase()">+ Crear Nueva Clase</button>
            <div class="filters">
              <input type="text" id="filtroClasesTexto" placeholder="Buscar por nombre o instructor" oninput="renderClasesAdminFiltradas()"/>
              <select id="filtroClasesEstado" onchange="renderClasesAdminFiltradas()">
                <option value="">Todos</option>
                <option value="true">Activas</option>
                <option value="false">Inactivas</option>
              </select>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingClasesAdmin"><div class="spinner"></div><p>Cargando clases...</p></div>
        <div class="data-table" id="clasesAdminTable"></div>
      </div>

      <!-- UBICACIONES -->
      <div id="tab-ubicaciones-admin" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Gesti√≥n de Ubicaciones</h2>
          <div class="section-actions">
            <button class="btn-create" onclick="abrirModalCrearUbicacion()">+ Crear Nueva Ubicaci√≥n</button>
            <div class="filters">
              <input type="text" id="filtroUbicacionesTexto" placeholder="Buscar por nombre, distrito o ciudad" oninput="renderUbicacionesFiltradas()"/>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingUbicacionesAdmin"><div class="spinner"></div><p>Cargando ubicaciones...</p></div>
        <div class="data-table" id="ubicacionesAdminTable"></div>
      </div>

      <!-- PAGOS -->
      <div id="tab-pagos-admin" class="admin-content">
        <div class="section-top">
          <h2 class="section-title">Historial de Pagos</h2>
          <div class="section-actions">
            <div class="filters">
              <input type="text" id="filtroPagosTexto" placeholder="Buscar por usuario o transacci√≥n" oninput="renderPagosFiltrados()"/>
            </div>
          </div>
        </div>
        <div class="loading" id="loadingPagosAdmin"><div class="spinner"></div><p>Cargando pagos...</p></div>
        <div class="data-table" id="pagosAdminTable"></div>
      </div>

    <!-- REPORTES -->
    <div id="tab-reportes" class="admin-content">
      <h2 class="section-title">Reportes y An√°lisis</h2>

      <!-- üîΩ Botones de descarga -->
      <div class="section-actions" style="display:flex; gap:1rem; margin-bottom:1rem; flex-wrap:wrap;">
        <button class="btn" onclick="descargarReportesExcel()">‚¨áÔ∏è Descargar reportes (Excel)</button> 
        <button class="btn btn-secondary" onclick="descargarReportesPDF()">‚¨áÔ∏è Descargar reportes (PDF)</button>
      </div>

      <div class="chart-container">
        <h3>Reporte de Membres√≠as</h3>
        <div class="loading" id="loadingReporteMembresias"><div class="spinner"></div></div>
        <div id="reporteMembresiaContent"></div>
      </div>

      <div class="chart-container">
        <h3>Reporte de Ingresos</h3>
        <select id="periodoIngresos" onchange="cargarReporteIngresos()" class="select-dark">
          <option value="mensual">Mensual</option>
          <option value="anual">Anual</option>
        </select>
        <div class="loading" id="loadingReporteIngresos"><div class="spinner"></div></div>
        <div id="reporteIngresosContent"></div>
      </div>

      <div class="chart-container">
        <h3>Reporte de Clases (Ocupaci√≥n)</h3>
        <div class="loading" id="loadingReporteClases"><div class="spinner"></div></div>
        <div id="reporteClasesContent"></div>
      </div>

      <div class="chart-container">
        <h3>Evoluci√≥n Mensual de Suscripciones</h3>
        <canvas id="graficoSuscripciones"></canvas>
      </div>
    </div>

  <!-- ===== MODALES ===== -->
  <!-- Usuario -->
  <div id="modalUsuario" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="usuarioModalTitulo">Crear Usuario</h3><button class="close-modal" onclick="cerrarModal('modalUsuario')">&times;</button></div>
      <form id="formUsuario" onsubmit="guardarUsuario(event)">
        <input type="hidden" id="usuarioEditId"/>
        <div class="form-group"><label>Nombre Completo</label><input type="text" id="usuarioEditNombre" required/></div>
        <div class="form-group"><label>Correo</label><input type="email" id="usuarioEditCorreo" required/></div>
        <div class="form-group"><label>Tel√©fono</label><input type="tel" id="usuarioEditTelefono"/></div>
        <div class="form-group"><label>Rol</label>
          <select id="usuarioEditRol"><option value="USUARIO">Usuario</option><option value="ENTRENADOR">Entrenador</option><option value="ADMINISTRADOR">Administrador</option></select>
        </div>
        <div class="form-group"><label>Estado</label>
          <select id="usuarioEditActivo"><option value="true">Activo</option><option value="false">Inactivo</option></select>
        </div>
        <div class="form-group" id="usuarioPwdWrap"><label>Contrase√±a</label><input type="password" id="usuarioEditPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
        <button type="submit" class="btn" style="width:100%;">Guardar</button>
      </form>
    </div>
  </div>

  <!-- Membres√≠a -->
  <div id="modalMembresia" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Crear Membres√≠a (Presencial)</h3><button class="close-modal" onclick="cerrarModal('modalMembresia')">&times;</button></div>
      <form id="formMembresia" onsubmit="guardarMembresiaPresencial(event)">
        <div class="form-group"><label>ID Usuario</label><input type="number" id="membUsuarioId" required/></div>
        <div class="form-group"><label>Plan</label>
          <select id="membPlan"><option value="BASICO">B√°sico</option><option value="PREMIUM">Premium</option><option value="ANUAL">Anual</option></select>
        </div>
        <div class="form-group"><label>Renovaci√≥n Autom√°tica</label>
          <select id="membAuto"><option value="true">S√≠</option><option value="false">No</option></select>
        </div>
        <button type="submit" class="btn" style="width:100%;">Crear</button>
      </form>
    </div>
  </div>

  <!-- Clase -->
  <div id="modalClase" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="modalClaseTitle">Crear Nueva Clase</h3><button class="close-modal" onclick="cerrarModal('modalClase')">&times;</button></div>
      <form id="formClase" onsubmit="guardarClase(event)">
        <input type="hidden" id="claseId"/>
        <div class="form-group"><label>Nombre</label><input type="text" id="claseNombre" required/></div>
        <div class="form-group"><label>Descripci√≥n</label><textarea id="claseDescripcion" style="min-height:80px;"></textarea></div>
        <div class="form-group"><label>Horario</label><input type="text" id="claseHorario" required/></div>
        <div class="form-group"><label>Instructor</label><input type="text" id="claseInstructor" required/></div>
        <div class="form-group"><label>Capacidad</label><input type="number" id="claseCapacidad" required min="1"/></div>
        <div class="form-group"><label>Duraci√≥n (min)</label><input type="number" id="claseDuracion" required min="15"/></div>
        <button type="submit" class="btn" style="width:100%;">Guardar</button>
      </form>
    </div>
  </div>

  <!-- Ubicaci√≥n -->
  <div id="modalUbicacion" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="modalUbicacionTitle">Crear Nueva Ubicaci√≥n</h3><button class="close-modal" onclick="cerrarModal('modalUbicacion')">&times;</button></div>
      <form id="formUbicacion" onsubmit="guardarUbicacion(event)">
        <input type="hidden" id="ubicacionId"/>
        <div class="form-group"><label>Nombre</label><input type="text" id="ubicacionNombre" required/></div>
        <div class="form-group"><label>Direcci√≥n</label><input type="text" id="ubicacionDireccion" required/></div>
        <div class="form-group"><label>Distrito</label><input type="text" id="ubicacionDistrito" required/></div>
        <div class="form-group"><label>Ciudad</label><input type="text" id="ubicacionCiudad" required/></div>
        <div class="form-group"><label>Tel√©fono</label><input type="tel" id="ubicacionTelefono" required/></div>
        <div class="form-group"><label>Horario</label><input type="text" id="ubicacionHorario" required value="24/7"/></div>
        <div class="form-group"><label>Latitud</label><input type="number" step="0.0001" id="ubicacionLatitud"/></div>
        <div class="form-group"><label>Longitud</label><input type="number" step="0.0001" id="ubicacionLongitud"/></div>
        <button type="submit" class="btn" style="width:100%;">Guardar</button>
      </form>
    </div>
  </div>

<script>
/* ================== CONFIG / ENDPOINTS ================== */
const API_URL = 'http://localhost:8080/api';
const ENDPOINTS = {
  auth: { login: `${API_URL}/autenticacion/iniciar-sesion`, register: `${API_URL}/autenticacion/registrar` },
  membresias: {
    crear: `${API_URL}/membresias`,
    porUsuario: (usuarioId) => `${API_URL}/membresias/usuario/${usuarioId}`,
    cancelar: (membresiaId) => `${API_URL}/membresias/${membresiaId}/cancelar`,
  },
  pagos: { crear: `${API_URL}/pagos`, porUsuario: (usuarioId) => `${API_URL}/pagos/usuario/${usuarioId}` },
  clases: { listar: `${API_URL}/clases`, inscribir: `${API_URL}/clases/inscribir`, porUsuario: (usuarioId) => `${API_URL}/clases/usuario/${usuarioId}` },
  ubicaciones: { listar: `${API_URL}/ubicaciones`, porId: (id)=>`${API_URL}/ubicaciones/${id}` },
  contacto: { enviar: `${API_URL}/contacto`, listar: `${API_URL}/contacto` },
  admin: {
    dashboard: `${API_URL}/admin/dashboard`,
    usuarios: `${API_URL}/admin/usuarios`,
    usuarioId: (id)=>`${API_URL}/admin/usuarios/${id}`,
    clases: `${API_URL}/admin/clases`,
    claseId: (id)=>`${API_URL}/admin/clases/${id}`,
    ubicaciones: `${API_URL}/admin/ubicaciones`,
    ubicacionId: (id)=>`${API_URL}/admin/ubicaciones/${id}`,
    membresias: `${API_URL}/admin/membresias`,
    pagos: `${API_URL}/admin/pagos`,
    reporteMembresias: `${API_URL}/admin/reportes/membresias`,
    reporteClases: `${API_URL}/admin/reportes/clases`,
    reporteIngresos: (periodo='mensual') => `${API_URL}/admin/reportes/ingresos?periodo=${periodo}`
  }
};

/* ================== HELPERS ================== */
const authHeaders = () => ({ 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` });

async function getJson(url, options = {}) {
  const headers = options.headers ? { ...options.headers } : {};
  headers['Accept'] = 'application/json';
  const res = await fetch(url, { ...options, headers });
  const text = await res.text();
  try { return { ok: res.ok, status: res.status, data: text ? JSON.parse(text) : null }; }
  catch { return { ok: res.ok, status: res.status, data: null }; }
}

async function sendJson(url, method, payload, extraHeaders = {}) {
  const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json', Accept: 'application/json', ...extraHeaders }, body: payload ? JSON.stringify(payload) : null });
  const text = await res.text();
  let data = null; try { data = text ? JSON.parse(text) : null; } catch {}
  return { ok: res.ok, status: res.status, data };
}

function getRol(u = usuarioActual){
  const r1=(u?.rol??'').toString().trim();
  const r2=Array.isArray(u?.roles)?(u.roles.find(x=>typeof x==='string')||''):'';
  const r3=(u?.authority??u?.authorities?.[0]?.authority??'').toString();
  return (r1||r2||r3).toUpperCase();
}
function isAdmin(u){ return getRol(u).includes('ADMIN'); }
function isInstructor(u){ return getRol(u).includes('INSTRUC'); }
function safeUsuarioNombre(x) {
  return x.usuarioNombre
      || (x.usuario && x.usuario.nombreCompleto)
      || '‚Äî';
}

/* ================== ESTADO ================== */
let usuarioActual = null;
let planSeleccionado = null;
let precioSeleccionado = 0;
let membresiaId = null;

/* ================== INICIO ================== */
window.addEventListener('DOMContentLoaded', () => {
  verificarSesion();
  actualizarUIUsuario();
  cargarUbicaciones();
  cargarClases();
  // formateo inputs de pago
  const numeroTarjeta = document.getElementById('numeroTarjeta');
  if (numeroTarjeta) numeroTarjeta.addEventListener('input', e => {
    let v = e.target.value.replace(/\s/g,'').replace(/\D/g,''); e.target.value = v.match(/.{1,4}/g)?.join(' ') || v;
  });
  const fechaExp = document.getElementById('fechaExpiracion');
  if (fechaExp) fechaExp.addEventListener('input', e => {
    let v = e.target.value.replace(/\D/g,''); if (v.length>=2) v = v.substring(0,2)+'/'+v.substring(2,4); e.target.value=v;
  });
});

/* ================== AUTH ================== */
function verificarSesion(){
  const u = localStorage.getItem('usuario');
  const t = localStorage.getItem('token');
  if (u && t){ usuarioActual = JSON.parse(u); }
}

function actualizarUIUsuario() {
  const isAdmin = usuarioActual?.rol === 'ADMINISTRADOR';
  const isTrainer = usuarioActual?.rol === 'ENTRENADOR';

  if (usuarioActual) {
    document.getElementById('authLink').style.display = 'none';
    document.getElementById('userInfo').classList.add('active');
    document.getElementById('userName').textContent = usuarioActual.nombreCompleto;

    // Mostrar "Panel Admin" para admin e instructor
    if (isAdmin || isTrainer) {
      document.getElementById('adminLink').style.display = 'block';
    } else {
      document.getElementById('adminLink').style.display = 'none';
    }
  } else {
    document.getElementById('authLink').style.display = 'block';
    document.getElementById('userInfo').classList.remove('active');
    document.getElementById('adminLink').style.display = 'none';
  }
}

async function manejarAutenticacion(event){
  event.preventDefault();
  const correoElectronico = document.getElementById('correoElectronico').value.trim();
  const contrasena = document.getElementById('contrasena').value;
  const btnAuth = document.getElementById('btnAuth');
  btnAuth.disabled=true; btnAuth.textContent='Procesando...';

  try{
    let url, body;
    if (document.getElementById('nameGroup').style.display==='none'){ // login
      url = ENDPOINTS.auth.login; body = { correoElectronico, contrasena };
    } else { // registro
      const nombreCompleto = document.getElementById('nombreCompleto').value.trim();
      let numeroTelefono = document.getElementById('numeroTelefono').value.trim();
      if (numeroTelefono){ numeroTelefono = numeroTelefono.replace(/[^\d+]/g,''); if(!numeroTelefono.startsWith('+')) numeroTelefono = '+51'+numeroTelefono; }
      else numeroTelefono=null;
      url = ENDPOINTS.auth.register; body = { nombreCompleto, correoElectronico, contrasena, numeroTelefono };
    }
    const { ok, data } = await sendJson(url,'POST',body);
    if (ok && data?.token){
      localStorage.setItem('token', data.token);
      localStorage.setItem('usuario', JSON.stringify({
        usuarioId: data.usuarioId, nombreCompleto: data.nombreCompleto, correoElectronico: data.correoElectronico,
        rol: data.rol || data.authority || (Array.isArray(data.roles)?data.roles[0]:'USUARIO')
      }));
      usuarioActual = JSON.parse(localStorage.getItem('usuario'));
      mostrarMensaje('¬°Bienvenido!','success');
      setTimeout(()=>{ actualizarUIUsuario(); showPage('home'); document.getElementById('authForm').reset(); }, 800);
    }else{
      mostrarMensaje((data && (data.mensaje||data.error)) || 'Error en la autenticaci√≥n','error');
    }
  }catch(e){ console.error(e); mostrarMensaje('Error de conexi√≥n','error'); }
  finally{ btnAuth.disabled=false; btnAuth.textContent='Continuar'; }
}

function cerrarSesion(){
  localStorage.removeItem('token'); localStorage.removeItem('usuario');
  usuarioActual=null; actualizarUIUsuario(); showPage('home'); mostrarMensaje('Sesi√≥n cerrada','success');
}

function cambiarModoAuth(e){
  e.preventDefault();
  const loginMode = document.getElementById('nameGroup').style.display==='none';
  document.getElementById('authTitle').textContent = loginMode?'Crear Cuenta':'Iniciar Sesi√≥n';
  document.getElementById('nameGroup').style.display = loginMode?'block':'none';
  document.getElementById('phoneGroup').style.display = loginMode?'block':'none';
  document.getElementById('toggleText').innerHTML = loginMode?'¬øYa tienes cuenta? <a href="#" onclick="cambiarModoAuth(event)">Inicia Sesi√≥n</a>':'¬øNo tienes cuenta? <a href="#" onclick="cambiarModoAuth(event)">Reg√≠strate</a>';
}

/* ================== MEMBRES√çA & PAGO ================== */
function seleccionarPlan(tipoPlan, precio){
  if (!usuarioActual){ mostrarMensaje('Debes iniciar sesi√≥n','error'); showPage('login'); return; }
  planSeleccionado = tipoPlan; precioSeleccionado = precio; membresiaId = null;
  document.getElementById('selectedPlan').textContent = `Plan ${tipoPlan}`;
  document.getElementById('totalAmount').textContent = precio;
  showPage('payment');
}

async function procesarPago(event){
  event.preventDefault();
  const btn = document.getElementById('btnPayment'); btn.disabled=true; btn.textContent='Procesando...';
  try{
    if (!usuarioActual?.usuarioId) throw new Error('Usuario no autenticado');
    if (!planSeleccionado || !precioSeleccionado) throw new Error('Plan inv√°lido');

    // 1) Crear membres√≠a
    const { ok:okM, data:dM } = await sendJson(ENDPOINTS.membresias.crear,'POST',
      { tipoPlan: planSeleccionado, usuarioId: usuarioActual.usuarioId, renovacionAutomatica: true }, authHeaders());
    if (!okM || !dM?.id) throw new Error('No se pudo crear la membres√≠a');
    const membId = dM.id;

    // 2) Pago simulado
    const payloadPago = {
      membresiaId: membId, usuarioId: usuarioActual.usuarioId,
      nombreTarjeta: document.getElementById('nombreTarjeta').value.trim(),
      numeroTarjeta: document.getElementById('numeroTarjeta').value.replace(/\s/g,''),
      fechaExpiracion: document.getElementById('fechaExpiracion').value.trim(),
      cvv: document.getElementById('cvv').value.trim(), monto: precioSeleccionado
    };
    const { ok:okP, data:dP } = await sendJson(ENDPOINTS.pagos.crear,'POST',payloadPago,authHeaders());
    if (!okP){ await sendJson(ENDPOINTS.membresias.cancelar(membId),'PUT',null,authHeaders()); throw new Error(dP?.mensaje||dP?.error||'Pago rechazado'); }

    mostrarMensajeEnPagina('paymentSuccessMsg',`¬°Pago exitoso! ID Tx: ${dP?.idTransaccion||'‚Äî'}`,'success');
    setTimeout(()=>{ showPage('home'); document.querySelector('#payment form').reset(); planSeleccionado=null; precioSeleccionado=0; },1500);
  }catch(e){
    mostrarMensajeEnPagina('paymentErrorMsg', e.message, 'error');
  }finally{ btn.disabled=false; btn.textContent='Confirmar Pago'; }
}

/* ================== P√öBLICO: UBICACIONES Y CLASES ================== */
async function cargarUbicaciones(){
  const loading=document.getElementById('loadingLocations'); const list=document.getElementById('locationsList');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.ubicaciones.listar);
    window._ubicacionesCache = Array.isArray(data)?data:[];
    renderUbicacionesPublicas();
  }catch{ list.innerHTML='<p style="color:#ff4500; text-align:center;">Error al cargar ubicaciones.</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderUbicacionesPublicas(){
  const list=document.getElementById('locationsList');
  const q=(document.getElementById('filtroPublicUbicacionesTexto')?.value||'').toLowerCase();
  const arr=(window._ubicacionesCache||[]).filter(u=>`${u.distrito||''} ${u.ciudad||''}`.toLowerCase().includes(q));
  list.innerHTML = arr.length? arr.map(u=>`
    <div class="location-card">
      <h3>${u.nombreUbicacion}</h3>
      <p><strong>üìç Direcci√≥n:</strong> ${u.direccion}</p>
      <p><strong>üèôÔ∏è Distrito:</strong> ${u.distrito}</p>
      <p><strong>‚è∞ Horario:</strong> ${u.horario}</p>
      <p><strong>üìû Tel√©fono:</strong> ${u.numeroTelefono}</p>
    </div>`).join('') : '<p style="color:#ff4500; text-align:center;">No hay ubicaciones</p>';
}

async function cargarClases(){
  const loading=document.getElementById('loadingClasses'); const list=document.getElementById('classesList');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.clases.listar);
    window._clasesCache = Array.isArray(data)?data:[];
    renderClasesPublicas();
  }catch{ list.innerHTML='<p style="color:#ff4500; text-align:center;">Error al cargar clases.</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderClasesPublicas(){
  const list=document.getElementById('classesList');
  const q=(document.getElementById('filtroPublicClasesTexto')?.value||'').toLowerCase();
  const arr=(window._clasesCache||[]).filter(c=>`${c.nombreClase||''} ${c.nombreInstructor||''}`.toLowerCase().includes(q));
  list.innerHTML = arr.length? arr.map(c=>{
    const inscritos = Array.isArray(c.usuariosInscritos) ? c.usuariosInscritos.length : (c.inscritos||0);
    const cupos = Math.max((c.capacidadMaxima||0)-inscritos,0);
    return `<div class="class-card">
      <h3>${c.nombreClase}</h3><p>${c.descripcion||''}</p>
      <p style="margin:1rem 0;"><strong>üìÖ ${c.horario}</strong></p>
      <p><strong>üë®‚Äçüè´ Instructor:</strong> ${c.nombreInstructor}</p>
      <p class="spots">üéØ Cupos: ${cupos}/${c.capacidadMaxima}</p>
      <button class="btn" onclick="inscribirseEnClase(${c.id})">Inscribirme</button>
    </div>`
  }).join('') : '<p style="color:#ff4500; text-align:center;">No hay clases</p>';
}

async function inscribirseEnClase(claseId){
  if (!usuarioActual){ mostrarMensaje('Debes iniciar sesi√≥n','error'); showPage('login'); return; }
  try{
    const payload={ usuarioId: usuarioActual.usuarioId, claseId };
    const r = await fetch(ENDPOINTS.clases.inscribir,{ method:'POST', headers:{'Content-Type':'application/json',Accept:'application/json',...authHeaders()}, body:JSON.stringify(payload) });
    const contentType=r.headers.get('content-type'); const data = contentType?.includes('json')? await r.json(): await r.text();
    if (r.ok){ alert(`‚úÖ ${typeof data==='string'?data:'Inscrito'}`); cargarClases(); }
    else { throw new Error(typeof data==='string'?data:(data?.mensaje||data?.error||'No se pudo inscribir')); }
  }catch(e){ alert('‚ùå '+e.message); }
}

/* ================== CONTACTO ================== */
async function enviarMensajeContacto(event){
  event.preventDefault();
  const btn=document.getElementById('btnContact'); btn.disabled=true; btn.textContent='Enviando...';
  try{
    const payload={ nombreRemitente:contactNombre.value, correoRemitente:contactEmail.value, asunto:contactAsunto.value, mensaje:contactMensaje.value };
    const { ok, data } = await sendJson(ENDPOINTS.contacto.enviar,'POST',payload);
    if (ok){ mostrarMensajeEnPagina('contactSuccessMsg', typeof data==='string'?data:'Mensaje enviado','success'); document.querySelector('#contact form').reset(); }
    else { mostrarMensajeEnPagina('contactErrorMsg', data?.mensaje||data?.error||'Error','error'); }
  }catch{ mostrarMensajeEnPagina('contactErrorMsg','Error de conexi√≥n','error'); }
  finally{ btn.disabled=false; btn.textContent='Enviar Mensaje'; }
}

/* ================== NAV/UI helpers ================== */
function showPage(pageId) {
  if (pageId === 'admin') {
    if (!usuarioActual) {
      alert('Acceso denegado.');
      pageId = 'home';
    } else {
      const rol = usuarioActual.rol;
      const isAdmin = rol === 'ADMINISTRADOR';
      const isTrainer = rol === 'ENTRENADOR';

      if (!(isAdmin || isTrainer)) {
        alert('Acceso denegado.');
        pageId = 'home';
      } else {
        // Es admin o entrenador: ajustar tabs visibles
        configurarTabsAdminPorRol(rol);
        // Tab por defecto: admin -> dashboard | entrenador -> clases
        if (isTrainer) {
          cambiarTabAdmin('clases-admin', document.querySelector('.admin-tab[data-tab="clases-admin"]'));
        } else {
          cambiarTabAdmin('dashboard', document.querySelector('.admin-tab[data-tab="dashboard"]'));
        }
      }
    }
  }

  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.getElementById('navLinks').classList.remove('active');
  window.scrollTo(0,0);
  if (pageId === 'locations') cargarUbicaciones();
  else if (pageId === 'classes') cargarClases();
  else if (pageId === 'admin') cargarDashboard(); // si es entrenador, esta llamada no afectar√°
}

function configurarTabsAdminPorRol(rol) {
  const isAdmin = rol === 'ADMINISTRADOR';
  const isTrainer = rol === 'ENTRENADOR';

  // Botones/pesta√±as
  const tabs = [
    { key:'dashboard',        sel:'[data-tab="dashboard"]' },
    { key:'usuarios',         sel:'[data-tab="usuarios"]' },
    { key:'membresias',       sel:'[data-tab="membresias"]' },
    { key:'clases-admin',     sel:'[data-tab="clases-admin"]' },
    { key:'ubicaciones-admin',sel:'[data-tab="ubicaciones-admin"]' },
    { key:'pagos-admin',      sel:'[data-tab="pagos-admin"]' },
    { key:'reportes',         sel:'[data-tab="reportes"]' }
  ];

  tabs.forEach(t => {
    const btn = document.querySelector(`.admin-menu ${t.sel}`);
    const pane = document.getElementById(`tab-${t.key}`);
    if (!btn || !pane) return;

    if (isAdmin) {
      // Admin ve todo
      btn.style.display = '';
      pane.style.display = '';
    } else if (isTrainer) {
      // Entrenador: solo CLASES
      const allowed = (t.key === 'clases-admin');
      btn.style.display = allowed ? '' : 'none';
      pane.style.display = allowed ? '' : 'none';
      if (!allowed) pane.classList.remove('active');
    }
  });

  // Oculta botones de acciones de escritura si es entrenador
  const isTrainerOnly = isTrainer;
  document.querySelectorAll('.btn-create, .btn-edit, .btn-delete').forEach(b=>{
    if (isTrainerOnly) b.style.display = 'none';
  });
}

function toggleMobileMenu(){ document.getElementById('navLinks').classList.toggle('active'); }
function mostrarMensaje(msg,tipo){
  const s=document.getElementById('successMsg'); const e=document.getElementById('errorMsg');
  if (tipo==='success'){ s.textContent=msg; s.classList.add('show'); e.classList.remove('show'); setTimeout(()=>s.classList.remove('show'),2500); }
  else { e.textContent=msg; e.classList.add('show'); s.classList.remove('show'); setTimeout(()=>e.classList.remove('show'),4000); }
}
function mostrarMensajeEnPagina(id,msg,tipo){
  const el=document.getElementById(id); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), tipo==='success'?2500:4000);
}

/* ================== ADMIN: Tabs y permisos ================== */
function cambiarTabAdmin(tab, elBtn){
  const rol = usuarioActual?.rol;
  const isAdmin = rol === 'ADMINISTRADOR';
  const isTrainer = rol === 'ENTRENADOR';

  if (isTrainer && tab !== 'clases-admin') {
    alert('Tu rol solo permite ver Clases.');
    return;
  }

  document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.admin-content').forEach(c=>c.classList.remove('active'));
  if (elBtn) elBtn.classList.add('active');
  const area = document.getElementById(`tab-${tab}`);
  if (area) area.classList.add('active');

  switch(tab){
    case 'dashboard': if(isAdmin) cargarDashboard(); break;
    case 'usuarios':  if(isAdmin) cargarUsuariosAdmin(); break;
    case 'membresias':if(isAdmin) cargarMembresiasAdmin(); break;
    case 'clases-admin': cargarClasesAdmin(); break; // <- visible para ambos, pero los botones de crear/editar se ocultan al entrenador
    case 'ubicaciones-admin': if(isAdmin) cargarUbicacionesAdmin(); break;
    case 'pagos-admin': if(isAdmin) cargarPagosAdmin(); break;
    case 'reportes': if(isAdmin) cargarReportes(); break;
  }
}


function aplicarPermisosTabs(){
  const tabs = document.querySelectorAll('.admin-tabs .admin-tab');
  if (isInstructor(usuarioActual) && !isAdmin(usuarioActual)){
    tabs.forEach(t=>{
      const k=t.getAttribute('data-tab');
      const visible = (k==='clases-admin' || k==='ubicaciones-admin');
      t.style.display = visible ? 'inline-block' : 'none';
    });
    // Forzar mostrar "clases" si estaba otra activa
    const active = document.querySelector('.admin-tab.active'); if (!active || active.style.display==='none'){
      const btn = document.querySelector('.admin-tab[data-tab="clases-admin"]'); if (btn) btn.click();
    }
  } else {
    tabs.forEach(t=> t.style.display='inline-block');
  }
}

/* ================== ADMIN: Dashboard ================== */
async function cargarDashboard(){
  const loading=document.getElementById('loadingDashboard'); const container=document.getElementById('dashboardStats');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.admin.dashboard, { headers:{...authHeaders()} });
    if (ok && data){
      container.innerHTML = `
        <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value">${data.totalUsuarios}</div><div class="stat-label">Total Usuarios</div><div style="color:#28a745; margin-top:.5rem;">‚úì ${data.usuariosActivos} activos</div></div>
        <div class="stat-card"><div class="stat-icon">üí≥</div><div class="stat-value">${data.totalMembresias}</div><div class="stat-label">Total Membres√≠as</div><div style="color:#28a745; margin-top:.5rem;">‚úì ${data.membresiasActivas} activas</div></div>
        <div class="stat-card"><div class="stat-icon">üèãÔ∏è</div><div class="stat-value">${data.totalClases}</div><div class="stat-label">Clases Disponibles</div></div>
        <div class="stat-card"><div class="stat-icon">üìç</div><div class="stat-value">${data.totalUbicaciones}</div><div class="stat-label">Ubicaciones</div></div>
        <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-value">${Number(data.ingresosMensuales||0).toFixed(2)}</div><div class="stat-label">Ingresos Mensuales</div></div>
        <div class="stat-card"><div class="stat-icon">üíµ</div><div class="stat-value">${Number(data.ingresosAnuales||0).toFixed(2)}</div><div class="stat-label">Ingresos Anuales</div></div>
      `;
    } else { container.innerHTML = '<p style="color:#dc3545;">Error al cargar estad√≠sticas</p>'; }
  }catch(e){ container.innerHTML = '<p style="color:#dc3545;">Error al cargar estad√≠sticas</p>'; }
  finally{ loading.classList.remove('show'); }
}

/* ================== ADMIN: Usuarios ================== */
function abrirModalCrearUsuario(){
  document.getElementById('usuarioModalTitulo').textContent='Crear Usuario';
  document.getElementById('formUsuario').reset();
  document.getElementById('usuarioEditId').value='';
  document.getElementById('usuarioPwdWrap').style.display='block';
  abrirModal('modalUsuario');
}
function editarUsuario(id, nombre, correo, telefono, rol, activo){
  document.getElementById('usuarioModalTitulo').textContent='Editar Usuario';
  document.getElementById('usuarioEditId').value=id;
  document.getElementById('usuarioEditNombre').value=nombre||'';
  document.getElementById('usuarioEditCorreo').value=correo||'';
  document.getElementById('usuarioEditTelefono').value=telefono||'';
  document.getElementById('usuarioEditRol').value=rol||'USUARIO';
  document.getElementById('usuarioEditActivo').value=String(!!activo);
  document.getElementById('usuarioPwdWrap').style.display='none';
  abrirModal('modalUsuario');
}
async function guardarUsuario(e){
  e.preventDefault();
  const id=document.getElementById('usuarioEditId').value;
  const payload={
    nombreCompleto: usuarioEditNombre.value,
    correoElectronico: usuarioEditCorreo.value,
    numeroTelefono: usuarioEditTelefono.value || null,
    rol: usuarioEditRol.value,
    estaActivo: usuarioEditActivo.value==='true'
  };
  if (!id && usuarioEditPwd.value) payload.contrasena = usuarioEditPwd.value;
  const url = id? ENDPOINTS.admin.usuarioId(id): ENDPOINTS.admin.usuarios;
  const method = id? 'PUT':'POST';
  try{ const { ok } = await sendJson(url,method,payload,authHeaders()); if (ok){ cerrarModal('modalUsuario'); cargarUsuariosAdmin(); } else alert('No se pudo guardar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function eliminarUsuario(id){
  if(!confirm('¬øEliminar usuario?')) return;
  try{ const { ok } = await sendJson(ENDPOINTS.admin.usuarioId(id),'DELETE',null,authHeaders()); if (ok) cargarUsuariosAdmin(); else alert('No se pudo eliminar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function cargarUsuariosAdmin(){
  const loading=document.getElementById('loadingUsuarios'); const container=document.getElementById('usuariosTable');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.admin.usuarios, { headers:{...authHeaders()} });
    window._usuariosCache = Array.isArray(data)?data:[];
    renderUsuariosFiltrados();
  }catch{ container.innerHTML='<p style="color:#dc3545;">Error al cargar usuarios</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderUsuariosFiltrados(){
  const container=document.getElementById('usuariosTable');
  const q=(document.getElementById('filtroUsuariosTexto')?.value||'').toLowerCase();
  const r=document.getElementById('filtroUsuariosRol')?.value||'';
  const e=document.getElementById('filtroUsuariosEstado')?.value||'';
  const arr=(window._usuariosCache||[]).filter(u=>{
    const txt=`${u.nombreCompleto||''} ${u.correoElectronico||''}`.toLowerCase().includes(q);
    const rol=!r || (u.rol===r);
    const est=!e || (String(!!u.estaActivo)===e);
    return txt && rol && est;
  });
  container.innerHTML = `
    <table>
      <thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Tel√©fono</th><th>Rol</th><th>Estado</th><th>Fecha</th><th>Acciones</th></tr></thead>
      <tbody>
        ${arr.map(u=>`
          <tr>
            <td>${u.id}</td>
            <td>${u.nombreCompleto}</td>
            <td>${u.correoElectronico}</td>
            <td>${u.numeroTelefono||'‚Äî'}</td>
            <td><span class="badge badge-info">${u.rol}</span></td>
            <td><span class="badge ${u.estaActivo?'badge-success':'badge-danger'}">${u.estaActivo?'Activo':'Inactivo'}</span></td>
            <td>${u.fechaCreacion? new Date(u.fechaCreacion).toLocaleDateString():'‚Äî'}</td>
            <td>
              <button class="action-btn btn-edit" onclick="editarUsuario(${u.id}, '${(u.nombreCompleto||'').replace(/'/g,"\\'")}', '${u.correoElectronico||''}', '${u.numeroTelefono||''}', '${u.rol}', ${!!u.estaActivo})">Editar</button>
              <button class="action-btn btn-delete" onclick="eliminarUsuario(${u.id})">Eliminar</button>
            </td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

/* ================== ADMIN: Membres√≠as ================== */
function abrirModalCrearMembresia(){ document.getElementById('formMembresia').reset(); abrirModal('modalMembresia'); }
async function guardarMembresiaPresencial(e){
  e.preventDefault();
  const payload={ usuarioId: Number(document.getElementById('membUsuarioId').value), tipoPlan: document.getElementById('membPlan').value, renovacionAutomatica: document.getElementById('membAuto').value==='true' };
  try{
    const { ok, data } = await sendJson(ENDPOINTS.membresias.crear,'POST',payload,authHeaders());
    if (ok){ cerrarModal('modalMembresia'); cargarMembresiasAdmin(); mostrarMensaje('Membres√≠a creada','success'); }
    else alert(data?.mensaje||data?.error||'No se pudo crear');
  }catch{ alert('Error de conexi√≥n'); }
}
async function cancelarMembresia(id){
  if(!confirm('¬øCancelar membres√≠a?')) return;
  try{
    const { ok } = await sendJson(ENDPOINTS.membresias.cancelar(id),'PUT',null,authHeaders());
    if (ok){ cargarMembresiasAdmin(); } else alert('No se pudo cancelar');
  }catch{ alert('Error de conexi√≥n'); }
}
async function cargarMembresiasAdmin(){
  const loading=document.getElementById('loadingMembresias'); const container=document.getElementById('membresiasTable');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.admin.membresias, { headers:{...authHeaders()} });
    window._membresiasCache = Array.isArray(data)?data:[];
    renderMembresiasFiltradas();
  }catch{ container.innerHTML='<p style="color:#dc3545;">Error al cargar membres√≠as</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderMembresiasFiltradas(){
  const container=document.getElementById('membresiasTable');
  const q=(document.getElementById('filtroMembresiasTexto')?.value||'').toLowerCase();
  const estado=document.getElementById('filtroMembresiasEstado')?.value||'';
  const plan=document.getElementById('filtroMembresiasPlan')?.value||'';
  const arr=(window._membresiasCache||[]).filter(m=>{
    const usuario = (m.usuario?.nombreCompleto||'').toLowerCase();
    const matchesTxt = `${usuario} ${m.tipoPlan||''}`.toLowerCase().includes(q);
    const matchesEstado = !estado || m.estado===estado;
    const matchesPlan = !plan || m.tipoPlan===plan;
    return matchesTxt && matchesEstado && matchesPlan;
  });
  container.innerHTML = `
    <table>
      <thead><tr><th>ID</th><th>Usuario</th><th>Plan</th><th>Precio</th><th>Inicio</th><th>Fin</th><th>Estado</th><th>Auto-Renov</th><th>Acciones</th></tr></thead>
      <tbody>
        ${arr.map(m=>`
          <tr>
            <td>${m.id}</td>
            <td>${safeUsuarioNombre(m)}<br><small>ID: ${m.usuarioId ?? '‚Äî'}</small></td>
            <td><span class="badge badge-info">${m.tipoPlan}</span></td>
            <td>${m.precio ?? '‚Äî'}</td>
            <td>${m.fechaInicio? new Date(m.fechaInicio).toLocaleDateString() : '‚Äî'}</td>
            <td>${m.fechaFin? new Date(m.fechaFin).toLocaleDateString() : '‚Äî'}</td>
            <td><span class="badge ${m.estado==='ACTIVO'?'badge-success':'badge-warning'}">${m.estado}</span></td>
            <td>${m.renovacionAutomatica ? '‚úì' : '‚Äî'}</td>
            <td>${m.estado==='ACTIVO' ? `<button class="action-btn btn-delete" onclick="cancelarMembresia(${m.id})">Cancelar</button>` : '‚Äî'}</td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

/* ================== ADMIN: Clases ================== */
function abrirModalCrearClase(){
  document.getElementById('modalClaseTitle').textContent='Crear Nueva Clase';
  document.getElementById('formClase').reset();
  document.getElementById('claseId').value='';
  abrirModal('modalClase');
}
function editarClase(c){
  document.getElementById('modalClaseTitle').textContent='Editar Clase';
  document.getElementById('claseId').value=c.id||'';
  claseNombre.value=c.nombreClase||''; claseDescripcion.value=c.descripcion||''; claseHorario.value=c.horario||'';
  claseInstructor.value=c.nombreInstructor||''; claseCapacidad.value=c.capacidadMaxima||1; claseDuracion.value=c.duracionMinutos||60;
  abrirModal('modalClase');
}
async function guardarClase(e){
  e.preventDefault();
  const id=claseId.value;
  const payload={ nombreClase:claseNombre.value, descripcion:claseDescripcion.value, horario:claseHorario.value, nombreInstructor:claseInstructor.value, capacidadMaxima:Number(claseCapacidad.value), duracionMinutos:Number(claseDuracion.value), estaActivo:true };
  const url = id? ENDPOINTS.admin.claseId(id): ENDPOINTS.admin.clases; const method=id?'PUT':'POST';
  try{ const { ok } = await sendJson(url,method,payload,authHeaders()); if(ok){ cerrarModal('modalClase'); cargarClasesAdmin(); } else alert('No se pudo guardar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function eliminarClase(id){
  if(!confirm('¬øEliminar clase?')) return;
  try{ const { ok } = await sendJson(ENDPOINTS.admin.claseId(id),'DELETE',null,authHeaders()); if(ok) cargarClasesAdmin(); else alert('No se pudo eliminar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function cargarClasesAdmin(){
  const loading=document.getElementById('loadingClasesAdmin'); const container=document.getElementById('clasesAdminTable');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.clases.listar);
    window._clasesAdminCache = Array.isArray(data)?data:[];
    renderClasesAdminFiltradas();
  }catch{ container.innerHTML='<p style="color:#dc3545;">Error al cargar clases</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderClasesAdminFiltradas(){
  const container=document.getElementById('clasesAdminTable');
  const q=(document.getElementById('filtroClasesTexto')?.value||'').toLowerCase();
  const est=(document.getElementById('filtroClasesEstado')?.value||'');
  const arr=(window._clasesAdminCache||[]).filter(c=>{
    const txt=`${c.nombreClase||''} ${c.nombreInstructor||''}`.toLowerCase().includes(q);
    const estado=!est || String(!!c.estaActivo)===est;
    return txt && estado;
  });
  container.innerHTML=`
    <table>
      <thead><tr><th>ID</th><th>Nombre</th><th>Instructor</th><th>Horario</th><th>Capacidad</th><th>Inscritos</th><th>Duraci√≥n</th><th>Estado</th><th>Acciones</th></tr></thead>
      <tbody>
        ${arr.map(c=>`
          <tr>
            <td>${c.id}</td><td>${c.nombreClase}</td><td>${c.nombreInstructor}</td><td>${c.horario}</td>
            <td>${c.capacidadMaxima}</td><td>${Array.isArray(c.usuariosInscritos)?c.usuariosInscritos.length:(c.inscritos||0)}</td>
            <td>${c.duracionMinutos} min</td>
            <td><span class="badge ${c.estaActivo ? 'badge-success':'badge-danger'}">${c.estaActivo?'Activo':'Inactivo'}</span></td>
            <td>
              <button class="action-btn btn-edit" onclick='editarClase(${JSON.stringify(c).replace(/'/g,"&apos;")})'>Editar</button>
              <button class="action-btn btn-delete" onclick="eliminarClase(${c.id})">Eliminar</button>
            </td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

/* ================== ADMIN: Ubicaciones ================== */
function abrirModalCrearUbicacion() {
  const rol = (usuarioActual?.rol)||'USUARIO';
  if (rol !== 'ADMINISTRADOR') {
    alert('Solo un administrador puede crear ubicaciones.');
    return;
  }

  ubicacionEditando = null;
  const form = document.getElementById('formUbicacion');
  if (form) form.reset();

  const idInput = document.getElementById('ubicacionId');
  if (idInput) idInput.value = '';
  const title = document.getElementById('modalUbicacionTitle');
  if (title) title.textContent = 'Crear Nueva Ubicaci√≥n';

  abrirModal('modalUbicacion');
}

// Aseg√∫rate de exponerla al scope global cuando usas inline onclick en el HTML
window.abrirModalCrearUbicacion = abrirModalCrearUbicacion;

function editarUbicacion(u){
  document.getElementById('modalUbicacionTitle').textContent='Editar Ubicaci√≥n';
  ubicacionId.value=u.id||''; ubicacionNombre.value=u.nombreUbicacion||''; ubicacionDireccion.value=u.direccion||'';
  ubicacionDistrito.value=u.distrito||''; ubicacionCiudad.value=u.ciudad||''; ubicacionTelefono.value=u.numeroTelefono||'';
  ubicacionHorario.value=u.horario||'24/7'; ubicacionLatitud.value=u.latitud||''; ubicacionLongitud.value=u.longitud||'';
  abrirModal('modalUbicacion');
}
async function guardarUbicacion(e){
  e.preventDefault();
  const id=ubicacionId.value;
  const payload={ nombreUbicacion:ubicacionNombre.value, direccion:ubicacionDireccion.value, distrito:ubicacionDistrito.value, ciudad:ubicacionCiudad.value, numeroTelefono:ubicacionTelefono.value, horario:ubicacionHorario.value, latitud:parseFloat(ubicacionLatitud.value||0), longitud:parseFloat(ubicacionLongitud.value||0) };
  const url=id? ENDPOINTS.admin.ubicacionId(id): ENDPOINTS.admin.ubicaciones; const method=id?'PUT':'POST';
  try{ const { ok } = await sendJson(url,method,payload,authHeaders()); if(ok){ cerrarModal('modalUbicacion'); cargarUbicacionesAdmin(); } else alert('No se pudo guardar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function eliminarUbicacion(id){
  if(!confirm('¬øEliminar ubicaci√≥n?')) return;
  try{ const { ok } = await sendJson(ENDPOINTS.admin.ubicacionId(id),'DELETE',null,authHeaders()); if(ok) cargarUbicacionesAdmin(); else alert('No se pudo eliminar'); }
  catch{ alert('Error de conexi√≥n'); }
}
async function cargarUbicacionesAdmin(){
  const loading=document.getElementById('loadingUbicacionesAdmin'); const container=document.getElementById('ubicacionesAdminTable');
  loading.classList.add('show');
  try{
    const { ok, data } = await getJson(ENDPOINTS.ubicaciones.listar);
    window._ubicacionesAdminCache = Array.isArray(data)?data:[];
    renderUbicacionesFiltradas();
  }catch{ container.innerHTML='<p style="color:#dc3545;">Error al cargar ubicaciones</p>'; }
  finally{ loading.classList.remove('show'); }
}
function renderUbicacionesFiltradas(){
  const container=document.getElementById('ubicacionesAdminTable');
  const q=(document.getElementById('filtroUbicacionesTexto')?.value||'').toLowerCase();
  const arr=(window._ubicacionesAdminCache||[]).filter(u=>{
    return `${u.nombreUbicacion||''} ${u.distrito||''} ${u.ciudad||''}`.toLowerCase().includes(q);
  });
  container.innerHTML=`
    <table>
      <thead><tr><th>ID</th><th>Nombre</th><th>Direcci√≥n</th><th>Distrito</th><th>Ciudad</th><th>Tel√©fono</th><th>Horario</th><th>Acciones</th></tr></thead>
      <tbody>
        ${arr.map(u=>`
          <tr>
            <td>${u.id}</td><td>${u.nombreUbicacion}</td><td>${u.direccion}</td><td>${u.distrito}</td>
            <td>${u.ciudad||'‚Äî'}</td><td>${u.numeroTelefono}</td><td>${u.horario}</td>
            <td>
              <button class="action-btn btn-edit" onclick='editarUbicacion(${JSON.stringify(u).replace(/'/g,"&apos;")})'>Editar</button>
              <button class="action-btn btn-delete" onclick="eliminarUbicacion(${u.id})">Eliminar</button>
            </td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

/* ================== ADMIN: Pagos ================== */
// Usa el mismo helper que ya tienes
// function safeUsuarioNombre(p){ ... } (ya est√° definido arriba)

async function cargarPagosAdmin() {
  const loading = document.getElementById('loadingPagosAdmin');
  const container = document.getElementById('pagosAdminTable');
  loading.classList.add('show');
  try {
    const { ok, data } = await getJson(ENDPOINTS.admin.pagos, { headers: { ...authHeaders() } });
    window._pagosCache = ok && Array.isArray(data) ? data : [];
    renderPagosFiltrados();
  } catch (e) {
    console.error(e);
    container.innerHTML = '<p style="color:#dc3545;">Error al cargar pagos</p>';
  } finally {
    loading.classList.remove('show');
  }
}

function renderPagosFiltrados() {
  const container = document.getElementById('pagosAdminTable');
  const q = (document.getElementById('filtroPagosTexto')?.value || '').toLowerCase();

  const arr = (window._pagosCache || []).filter(p => {
    const usuarioTxt = (safeUsuarioNombre(p) + ' ' + (p.usuarioId ?? '')).toLowerCase();
    const idTx = (p.idTransaccion || '').toLowerCase();
    return usuarioTxt.includes(q) || idTx.includes(q);
  });

  container.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Membres√≠a</th>
          <th>Monto</th>
          <th>Fecha</th>
          <th>Transacci√≥n</th>
          <th>M√©todo</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        ${arr.map(p => `
          <tr>
            <td>${p.id}</td>
            <td>${safeUsuarioNombre(p)}<br><small>ID: ${p.usuarioId ?? '‚Äî'}</small></td>
            <td>${p.membresiaId ?? '‚Äî'}</td>
            <td>S/${Number(p.monto || 0).toFixed(2)}</td>
            <td>${p.fechaPago ? new Date(p.fechaPago).toLocaleString() : '‚Äî'}</td>
            <td>${p.idTransaccion || '‚Äî'}</td>
            <td>${p.metodoPago || '‚Äî'}</td>
            <td><span class="badge ${p.estadoPago==='COMPLETADO' ? 'badge-success' : 'badge-warning'}">${p.estadoPago || '‚Äî'}</span></td>
          </tr>
        `).join('')}
      </tbody>
    </table>`;
}


/* ================== ADMIN: Reportes ================== */
function cargarReportes() {
  const rol = usuarioActual?.rol;

  if (rol !== 'ADMINISTRADOR') {
    const container = document.getElementById('tab-reportes');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:3rem;">
          <h2 style="color:#ff4500;">Acceso restringido</h2>
          <p>Solo los administradores pueden visualizar las estad√≠sticas globales y los reportes.</p>
        </div>`;
    }
    return;
  }

  cargarReporteMembresias();
  cargarReporteIngresos();
  cargarReporteClases();
  cargarReporteSuscripcionesMensuales(); // üëà importante
}
/* ======================== EXPORTADORES ======================== */
/** Asegura que existan caches. Si no, las carga ahora */
async function ensureAdminCaches() {
  const peticiones = [];

  if (!Array.isArray(window._usuariosCache)) {
    peticiones.push(getJson(ENDPOINTS.admin.usuarios, { headers: authHeaders() })
      .then(r => { if (r.ok) window._usuariosCache = r.data; }));
  }
  if (!Array.isArray(window._membresiasCache)) {
    peticiones.push(getJson(ENDPOINTS.admin.membresias, { headers: authHeaders() })
      .then(r => { if (r.ok) window._membresiasCache = r.data; }));
  }
  if (!Array.isArray(window._clasesAdminCache)) {
    peticiones.push(getJson(ENDPOINTS.clases.listar, { headers: authHeaders() })
      .then(r => { if (r.ok) window._clasesAdminCache = r.data; }));
  }
  if (!Array.isArray(window._ubicacionesAdminCache)) {
    peticiones.push(getJson(ENDPOINTS.ubicaciones.listar, { headers: authHeaders() })
      .then(r => { if (r.ok) window._ubicacionesAdminCache = r.data; }));
  }
  if (!Array.isArray(window._pagosCache)) {
    peticiones.push(getJson(ENDPOINTS.admin.pagos, { headers: authHeaders() })
      .then(r => { if (r.ok) window._pagosCache = r.data; }));
  }

  // Reportes agregados
  if (!window._reporteMembresias) {
    peticiones.push(getJson(ENDPOINTS.admin.reporteMembresias, { headers: authHeaders() })
      .then(r => { if (r.ok) window._reporteMembresias = r.data; }));
  }
  if (!window._reporteIngresos) {
    const periodo = document.getElementById('periodoIngresos')?.value || 'mensual';
    peticiones.push(getJson(ENDPOINTS.admin.reporteIngresos(periodo), { headers: authHeaders() })
      .then(r => { if (r.ok) window._reporteIngresos = r.data; }));
  }
  if (!Array.isArray(window._reporteClases)) {
    peticiones.push(getJson(ENDPOINTS.admin.reporteClases, { headers: authHeaders() })
      .then(r => { if (r.ok) window._reporteClases = r.data; }));
  }
  if (!window._suscripcionesMensuales) {
    // Si protegiste este endpoint por rol, aseg√∫rate de ser ADMIN
    peticiones.push(getJson(`${API_URL}/admin/reportes/suscripciones-mensuales`, { headers: authHeaders() })
      .then(r => { if (r.ok) window._suscripcionesMensuales = r.data; }));
  }

  await Promise.allSettled(peticiones);
}

/** Util: fecha y hora bonita para nombre de archivo */
function nowSlug() {
  const d = new Date();
  const pad = n => String(n).padStart(2, '0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}`;
}

/** Limpia y mapea datos para Excel */
function mapUsuariosExcel(data=[]) {
  return data.map(u => ({
    ID: u.id,
    'Nombre completo': u.nombreCompleto,
    'Email': u.correoElectronico,
    'Tel√©fono': u.numeroTelefono || '',
    'Rol': u.rol,
    'Activo': u.estaActivo ? 'S√≠' : 'No',
    'Fecha registro': u.fechaCreacion ? new Date(u.fechaCreacion).toLocaleString() : ''
  }));
}
function mapMembresiasExcel(data=[]) {
  return data.map(m => ({
    ID: m.id,
    'Usuario ID': m.usuarioId ?? (m.usuario?.id ?? ''),
    'Usuario': m.usuarioNombre ?? (m.usuario?.nombreCompleto ?? ''),
    'Plan': m.tipoPlan,
    'Precio': m.precio ?? '',
    'Inicio': m.fechaInicio ? new Date(m.fechaInicio).toLocaleString() : '',
    'Fin': m.fechaFin ? new Date(m.fechaFin).toLocaleString() : '',
    'Estado': m.estado,
    'Auto-renovaci√≥n': m.renovacionAutomatica ? 'S√≠' : 'No',
  }));
}
function mapClasesExcel(data=[]) {
  return data.map(c => ({
    ID: c.id,
    'Nombre': c.nombreClase,
    'Instructor': c.nombreInstructor,
    'Horario': c.horario,
    'Capacidad': c.capacidadMaxima ?? '',
    'Inscritos': Array.isArray(c.usuariosInscritos) ? c.usuariosInscritos.length : (c.inscritos ?? 0),
    'Duraci√≥n (min)': c.duracionMinutos ?? '',
    'Activo': c.estaActivo ? 'S√≠' : 'No',
  }));
}
function mapUbicacionesExcel(data=[]) {
  return data.map(u => ({
    ID: u.id,
    'Nombre': u.nombreUbicacion,
    'Direcci√≥n': u.direccion,
    'Distrito': u.distrito,
    'Ciudad': u.ciudad ?? '',
    'Tel√©fono': u.numeroTelefono ?? '',
    'Horario': u.horario ?? '',
    'Latitud': u.latitud ?? '',
    'Longitud': u.longitud ?? '',
  }));
}
function mapPagosExcel(data=[]) {
  return data.map(p => ({
    ID: p.id,
    'Usuario ID': p.usuarioId ?? (p.usuario?.id ?? ''),
    'Usuario': p.usuarioNombre ?? (p.usuario?.nombreCompleto ?? ''),
    'Membres√≠a ID': p.membresiaId ?? (p.membresia?.id ?? ''),
    'Monto': p.monto ?? '',
    'Fecha pago': (p.fechaPago || p.fecha) ? new Date(p.fechaPago || p.fecha).toLocaleString() : '',
    'Transacci√≥n': p.idTransaccion ?? '',
    'M√©todo': p.metodoPago ?? '',
    'Estado': p.estadoPago ?? '',
  }));
}
function mapReporteMembresiasExcel(r={}) {
  return [
    { M√©trica: 'Total', Valor: r.totalMembresias ?? r.total ?? 0 },
    { M√©trica: 'Activas', Valor: r.membresiaActivas ?? r.activas ?? 0 },
    { M√©trica: 'B√°sico', Valor: r.membresiaBasico ?? 0 },
    { M√©trica: 'Premium', Valor: r.membresiaPremium ?? 0 },
    { M√©trica: 'Anual', Valor: r.membresiaAnual ?? 0 },
    { M√©trica: 'Pausadas', Valor: r.membresiasPausadas ?? 0 },
    { M√©trica: 'Canceladas', Valor: r.membresiasCanceladas ?? 0 },
    { M√©trica: 'Expiradas', Valor: r.membresiasExpiradas ?? r.vencidas ?? 0 },
  ];
}
function mapReporteIngresosExcel(r={}) {
  return [
    { M√©trica: 'Periodo', Valor: r.periodo ?? '' },
    { M√©trica: 'Total ingresos', Valor: r.totalIngresos ?? 0 },
    { M√©trica: 'Cantidad de pagos', Valor: r.cantidadPagos ?? 0 },
    { M√©trica: 'Promedio por pago', Valor: r.promedioIngreso ?? 0 },
    { M√©trica: 'M√©todo m√°s usado', Valor: r.metodoPagoMasUsado ?? 'N/A' },
  ];
}
function mapReporteClasesExcel(list=[]) {
  return list.map(x => ({
    'Clase': x.nombreClase,
    'Instructor': x.nombreInstructor ?? '',
    'Capacidad': x.capacidadMaxima ?? 0,
    'Inscritos': x.usuariosInscritos ?? 0,
    'Ocupaci√≥n %': typeof x.tasaOcupacion === 'number' ? x.tasaOcupacion.toFixed(1) : 0,
  }));
}
function mapSuscripcionesMensualesExcel(obj={}) {
  // obj: { "2025-01": 10, "2025-02": 12, ... }
  return Object.entries(obj)
    .sort((a,b) => a[0].localeCompare(b[0]))
    .map(([mes, total]) => ({ Mes: mes, 'Nuevas suscripciones': total }));
}

/* ======================== EXCEL ======================== */
async function descargarReportesExcel() {
  try {
    await ensureAdminCaches();

    const wb = XLSX.utils.book_new();

    // Tablas CRUD
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapUsuariosExcel(window._usuariosCache || [])), 'Usuarios');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapMembresiasExcel(window._membresiasCache || [])), 'Membresias');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapClasesExcel(window._clasesAdminCache || [])), 'Clases');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapUbicacionesExcel(window._ubicacionesAdminCache || [])), 'Ubicaciones');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapPagosExcel(window._pagosCache || [])), 'Pagos');

    // Reportes agregados
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapReporteMembresiasExcel(window._reporteMembresias || {})), 'Rpt_Membresias');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapReporteIngresosExcel(window._reporteIngresos || {})), 'Rpt_Ingresos');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapReporteClasesExcel(window._reporteClases || [])), 'Rpt_Clases');

    // Serie mensual
    if (window._suscripcionesMensuales) {
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mapSuscripcionesMensualesExcel(window._suscripcionesMensuales)), 'Suscripciones_Mensuales');
    }

    const filename = `reportes_fitzone_${nowSlug()}.xlsx`;
    XLSX.writeFile(wb, filename);
  } catch (e) {
    console.error(e);
    alert('No se pudo generar el Excel');
  }
}

/* ======================== PDF ======================== */
async function descargarReportesPDF() {
  try {
    await ensureAdminCaches();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt');
    const margin = 36;
    let y = margin;

    const addTitle = (t) => {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.text(t, margin, y);
      y += 8;
      doc.setLineWidth(0.5);
      doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y);
      y += 12;
    };

    const addTable = (head, body) => {
      doc.autoTable({
        startY: y,
        head: [head],
        body,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [255, 69, 0], textColor: 255 },
        margin: { left: margin, right: margin },
        theme: 'striped',
        didDrawPage: (data) => { y = data.cursor.y + 18; }
      });
    };

    // Portada
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.text('Reporte General - FitZone', margin, y);
    y += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(`Fecha: ${new Date().toLocaleString()}`, margin, y); y += 24;

    // Rpt Membres√≠as (resumen)
    addTitle('Resumen de Membres√≠as');
    const rm = window._reporteMembresias || {};
    addTable(['M√©trica', 'Valor'], mapReporteMembresiasExcel(rm).map(r => [r['M√©trica'], String(r['Valor'])]));

    // Rpt Ingresos
    addTitle('Resumen de Ingresos');
    const ri = window._reporteIngresos || {};
    addTable(['M√©trica', 'Valor'], mapReporteIngresosExcel(ri).map(r => [r['M√©trica'], String(r['Valor'])]));

    // Rpt Clases
    addTitle('Clases (Ocupaci√≥n)');
    const rc = mapReporteClasesExcel(window._reporteClases || []);
    addTable(['Clase', 'Instructor', 'Capacidad', 'Inscritos', 'Ocupaci√≥n %'],
      rc.map(x => [x['Clase'], x['Instructor'], x['Capacidad'], x['Inscritos'], x['Ocupaci√≥n %']]));

    // Suscripciones mensuales
    if (window._suscripcionesMensuales) {
      addTitle('Evoluci√≥n Mensual de Suscripciones');
      const sm = mapSuscripcionesMensualesExcel(window._suscripcionesMensuales);
      addTable(['Mes', 'Nuevas suscripciones'], sm.map(r => [r['Mes'], r['Nuevas suscripciones']]));
    }

    // (Opcional) Tablas CRUD resumidas
    addTitle('Usuarios (resumen)');
    const u = mapUsuariosExcel((window._usuariosCache || [])).slice(0, 20);
    addTable(['ID','Nombre','Email','Tel√©fono','Rol','Activo','Registro'],
      u.map(r => [r['ID'], r['Nombre completo'], r['Email'], r['Tel√©fono'], r['Rol'], r['Activo'], r['Fecha registro']]));

    addTitle('Membres√≠as (resumen)');
    const mm = mapMembresiasExcel((window._membresiasCache || [])).slice(0, 20);
    addTable(['ID','Usuario','Plan','Precio','Inicio','Fin','Estado','Auto-renov'],
      mm.map(r => [r['ID'], r['Usuario'], r['Plan'], r['Precio'], r['Inicio'], r['Fin'], r['Estado'], r['Auto-renovaci√≥n']]));

    const filename = `reportes_fitzone_${nowSlug()}.pdf`;
    doc.save(filename);
  } catch (e) {
    console.error(e);
    alert('No se pudo generar el PDF');
  }
}

async function cargarReporteMembresias(){
  const loading=document.getElementById('loadingReporteMembresias'); const content=document.getElementById('reporteMembresiaContent');
  loading.classList.add('show');
  try{
    const { ok, data:d } = await getJson(ENDPOINTS.admin.reporteMembresias, { headers:{...authHeaders()} });
    if (ok && d){
      content.innerHTML = `
        <p><strong>Total:</strong> ${d.totalMembresias ?? d.total ?? 0}</p>
        <p><strong>Activas:</strong> ${d.membresiasActivas ?? d.activas ?? 0}</p>
        <p><strong>B√°sico:</strong> ${d.membresiaBasico ?? 0} | <strong>Premium:</strong> ${d.membresiaPremium ?? 0} | <strong>Anual:</strong> ${d.membresiaAnual ?? 0}</p>
      `;
    } else content.innerHTML='<p style="color:#dc3545;">Error</p>';
  }catch{ content.innerHTML='<p style="color:#dc3545;">Error</p>'; }
  finally{ loading.classList.remove('show'); }
}
async function cargarReporteIngresos(){
  const loading=document.getElementById('loadingReporteIngresos'); const content=document.getElementById('reporteIngresosContent');
  const periodo=document.getElementById('periodoIngresos').value;
  loading.classList.add('show');
  try{
    const { ok, data:d } = await getJson(ENDPOINTS.admin.reporteIngresos(periodo), { headers:{...authHeaders()} });
    if (ok && d){
      content.innerHTML = `
        <p><strong>Periodo:</strong> ${d.periodo||periodo}</p>
        <p><strong>Total ingresos:</strong> S/${Number(d.totalIngresos||0).toFixed(2)}</p>
        <p><strong>Cantidad de pagos:</strong> ${d.cantidadPagos||0}</p>
        <p><strong>Promedio por pago:</strong> S/${Number(d.promedioIngreso||0).toFixed(2)}</p>
      `;
    } else content.innerHTML='<p style="color:#dc3545;">Error</p>';
  }catch{ content.innerHTML='<p style="color:#dc3545;">Error</p>'; }
  finally{ loading.classList.remove('show'); }
}
async function cargarReporteClases(){
  const loading=document.getElementById('loadingReporteClases'); const content=document.getElementById('reporteClasesContent');
  loading.classList.add('show');
  try{
    const { ok, data:lista } = await getJson(ENDPOINTS.admin.reporteClases, { headers:{...authHeaders()} });
    if (ok && Array.isArray(lista)){
      const rows = lista.map(r => `<li>${r.nombreClase}: ${Number(r.tasaOcupacion||r.porcentajeOcupacion||0).toFixed(1)}% (Inscritos: ${r.usuariosInscritos ?? r.inscritos ?? 0}/${r.capacidadMaxima ?? r.capacidad ?? 0})</li>`).join('');
      content.innerHTML = rows ? `<ul>${rows}</ul>` : '<p>No hay datos</p>';
    } else content.innerHTML='<p style="color:#dc3545;">Error</p>';
  }catch{ content.innerHTML='<p style="color:#dc3545;">Error</p>'; }
  finally{ loading.classList.remove('show'); }
}
async function cargarReporteSuscripcionesMensuales() {
  const canvas = document.getElementById('graficoSuscripciones');
  const ctx = canvas.getContext('2d');
  const loading = document.getElementById('loadingSuscripcionesMensuales');

  loading?.classList.add('show');
  try {
    const { ok, data } = await getJson(`${API_URL}/admin/reportes/suscripciones-mensuales`, { headers: authHeaders() });
    if (!ok) throw new Error("Error al obtener datos");

    const labels = Object.keys(data);
    const values = Object.values(data);

    if (window.suscripcionesChart) window.suscripcionesChart.destroy();
    window.suscripcionesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Nuevas suscripciones por mes',
          data: values,
          borderColor: '#ff4500',
          backgroundColor: 'rgba(255,69,0,0.2)',
          borderWidth: 3,
          tension: 0.3,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Cantidad' } },
          x: { title: { display: true, text: 'Mes (yyyy-MM)' } }
        },
        plugins: {
          legend: { labels: { color: '#fff' } },
          title: { display: true, text: 'Tendencia de Suscripciones Mensuales', color: '#ff4500', font: { size: 16 } }
        }
      }
    });
  } catch (err) {
    console.error(err);
    alert('No se pudo cargar el gr√°fico de suscripciones.');
  } finally {
    loading?.classList.remove('show');
  }
}


/* ================== MODALES ================== */
function abrirModal(id){ document.getElementById(id).classList.add('show'); }
function cerrarModal(id){ document.getElementById(id).classList.remove('show'); }
</script>

</body>
</html>
